<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>배송 시트</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <style>
        body {
            font-family: 'Malgun Gothic', '맑은 고딕', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f9;
        }
        .container {
            max-width: 1200px;
            margin: auto;
            background: white;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            border-radius: 8px;
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .form-container, .controls-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            padding: 20px;
            background-color: #fdfdff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        input[type="text"], input[type="date"], input[type="number"] {
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            padding: 10px 15px;
            border: none;
            background-color: #007bff;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #0056b3;
        }
        .delete-btn {
            background-color: #dc3545;
        }
        .delete-btn:hover {
            background-color: #c82333;
        }
        .excel-btn {
            background-color: #28a745;
        }
        .excel-btn:hover {
            background-color: #218838;
        }
        #search {
            grid-column: 1 / -1;
        }
        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
            white-space: nowrap;
        }
        th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        .paste-area {
            width: 100%;
            height: 100px;
            padding: 10px;
            box-sizing: border-box;
            border: 2px dashed #ccc;
            border-radius: 4px;
            margin-bottom: 20px;
            font-family: monospace;
            white-space: pre;
        }
        .file-upload-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        #ocr-result {
            margin-top: 10px;
            font-style: italic;
            color: #555;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>배송 시트</h1>
        <div class="form-container">
            <input type="date" id="date" placeholder="날짜">
            <input type="text" id="receiver" placeholder="수하인">
            <input type="text" id="phone" placeholder="연락처">
            <input type="text" id="address" placeholder="주소">
            <input type="text" id="product" placeholder="상품명" value="상품명">
            <input type="number" id="quantity" placeholder="수량" value="1">
            <input type="text" id="waybill" placeholder="운송장 번호">
            <input type="text" id="weight" placeholder="무게(kg)">
            <input type="text" id="note" placeholder="비고">
            <button id="add-btn">추가</button>
        </div>
        
        <h2>일괄 추가</h2>
        <textarea id="paste-area" placeholder="여기에 엑셀 데이터를 복사-붙여넣기 하세요 (탭으로 구분된 형식)"></textarea>
        <button id="paste-btn">붙여넣기로 추가</button>

        <div class="controls-container">
            <input type="text" id="search" placeholder="검색...">
            <div class="file-upload-container">
                <label for="image-upload">사진으로 추가:</label>
                <input type="file" id="image-upload" accept="image/*">
            </div>
            <button id="export-btn" class="excel-btn">엑셀로 내보내기</button>
        </div>
        <div id="ocr-result"></div>

        <div class="table-container">
            <table id="item-table">
                <thead>
                    <tr>
                        <th>날짜</th>
                        <th>수하인</th>
                        <th>연락처</th>
                        <th>주소</th>
                        <th>상품명</th>
                        <th>수량</th>
                        <th>운송장 번호</th>
                        <th>무게(kg)</th>
                        <th>비고</th>
                        <th>작업</th>
                    </tr>
                </thead>
                <tbody id="item-list"></tbody>
            </table>
        </div>
    </div>

    <script>
        const dateInput = document.getElementById('date');
        const receiverInput = document.getElementById('receiver');
        const phoneInput = document.getElementById('phone');
        const addressInput = document.getElementById('address');
        const productInput = document.getElementById('product');
        const quantityInput = document.getElementById('quantity');
        const waybillInput = document.getElementById('waybill');
        const weightInput = document.getElementById('weight');
        const noteInput = document.getElementById('note');
        const addBtn = document.getElementById('add-btn');
        const itemList = document.getElementById('item-list');
        const searchInput = document.getElementById('search');
        const exportBtn = document.getElementById('export-btn');
        const pasteArea = document.getElementById('paste-area');
        const pasteBtn = document.getElementById('paste-btn');
        const imageUpload = document.getElementById('image-upload');


        // 오늘 날짜로 기본 설정
        dateInput.value = new Date().toISOString().slice(0, 10);

        let items = [];

        function renderItems(filteredItems) {
            itemList.innerHTML = '';
            const dataToRender = filteredItems || items;
            dataToRender.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td contenteditable="true" data-key="date">${item.date || ''}</td>
                    <td contenteditable="true" data-key="receiver">${item.receiver || ''}</td>
                    <td contenteditable="true" data-key="phone">${item.phone || ''}</td>
                    <td contenteditable="true" data-key="address">${item.address || ''}</td>
                    <td contenteditable="true" data-key="product">${item.product || ''}</td>
                    <td contenteditable="true" data-key="quantity">${item.quantity || ''}</td>
                    <td contenteditable="true" data-key="waybill">${item.waybill || ''}</td>
                    <td contenteditable="true" data-key="weight">${item.weight || ''}</td>
                    <td contenteditable="true" data-key="note">${item.note || ''}</td>
                    <td><button class="delete-btn" data-id="${item.id}">삭제</button></td>
                `;
                itemList.appendChild(tr);
            });
        }

        function addItem() {
            const newItem = {
                id: Date.now(),
                date: dateInput.value,
                receiver: receiverInput.value,
                phone: phoneInput.value,
                address: addressInput.value,
                product: productInput.value,
                quantity: quantityInput.value,
                waybill: waybillInput.value,
                weight: weightInput.value,
                note: noteInput.value
            };
            items.push(newItem);
            clearInputs();
            saveAndLoadItems();
        }

        function clearInputs() {
            receiverInput.value = '';
            phoneInput.value = '';
            addressInput.value = '';
            waybillInput.value = '';
            weightInput.value = '';
            noteInput.value = '';
            productInput.value = '상품명';
            quantityInput.value = '1';
            dateInput.value = new Date().toISOString().slice(0, 10);
            receiverInput.focus();
        }

        function saveAndLoadItems() {
            localStorage.setItem('deliveryItems', JSON.stringify(items));
            const savedItems = localStorage.getItem('deliveryItems');
            if (savedItems) {
                items = JSON.parse(savedItems);
                renderItems();
            }
        }
        
        function filterItems() {
            const searchTerm = searchInput.value.toLowerCase();
            if (!searchTerm) {
                renderItems(items);
                return;
            }
            const filtered = items.filter(item => 
                Object.values(item).some(value => 
                    String(value).toLowerCase().includes(searchTerm)
                )
            );
            renderItems(filtered);
        }

        function handleTableClick(e) {
            if (e.target.classList.contains('delete-btn')) {
                const id = parseInt(e.target.dataset.id);
                items = items.filter(item => item.id !== id);
                saveAndLoadItems();
            }
        }

        function handleTableEdit(e) {
            if (e.target.hasAttribute('contenteditable')) {
                const tr = e.target.parentElement;
                const id = parseInt(tr.querySelector('.delete-btn').dataset.id);
                const key = e.target.dataset.key;
                const value = e.target.textContent;

                const itemIndex = items.findIndex(item => item.id === id);
                if (itemIndex > -1) {
                    items[itemIndex][key] = value;
                    // 수정 시 바로 저장하지 않고, 사용자가 원할 때 저장하도록 할 수 있음
                    // 여기서는 즉시 저장
                    localStorage.setItem('deliveryItems', JSON.stringify(items));
                }
            }
        }
        
        function handlePaste() {
            const text = pasteArea.value.trim();
            if (!text) return;

            const lines = text.split('\n');
            const newItems = lines.map((line, index) => {
                const parts = line.split('\t');
                return {
                    id: Date.now() + index,
                    date: parts[0] || new Date().toISOString().slice(0, 10),
                    receiver: parts[1] || '',
                    phone: parts[2] || '',
                    address: parts[3] || '',
                    product: parts[4] || '상품명',
                    quantity: parts[5] || '1',
                    waybill: parts[6] || '',
                    weight: parts[7] || '',
                    note: parts[8] || ''
                };
            });

            items.push(...newItems);
            pasteArea.value = '';
            saveAndLoadItems();
        }


        function exportToExcel() {
            const dataToExport = [];
            const rows = itemList.querySelectorAll('tr');
            
            // 헤더 추가
            const headers = Array.from(document.querySelectorAll('#item-table th'))
                                .map(th => th.textContent)
                                .slice(0, -1); // '작업' 열 제외
            dataToExport.push(headers);

            rows.forEach(row => {
                const rowData = [];
                const cells = row.querySelectorAll('td');
                // 마지막 '작업' 셀 제외
                for (let i = 0; i < cells.length - 1; i++) {
                    rowData.push(cells[i].textContent);
                }
                dataToExport.push(rowData);
            });

            const worksheet = XLSX.utils.aoa_to_sheet(dataToExport);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "배송시트");

            const today = new Date().toISOString().slice(0, 10);
            XLSX.writeFile(workbook, `배송시트_${today}.xlsx`);
        }
        
        // OCR 이미지 처리 함수
        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const resultDiv = document.getElementById('ocr-result');
            resultDiv.textContent = '이미지를 분석 중입니다...';

            try {
                const { data: { text } } = await Tesseract.recognize(
                    file,
                    'eng+kor', // 영어와 한국어 동시 인식
                    {
                        logger: m => console.log(m)
                    }
                );

                resultDiv.textContent = '텍스트 추출 완료. 데이터를 처리 중...';
                
                // 1. OCR로 추출된 텍스트를 줄 단위로 나눔
                const lines = text.split('\n').filter(line => line.trim() !== '');
                
                let newItems = [];

                // 2. 각 줄을 순회하며 데이터 추출
                lines.forEach((line, index) => {
                    // 정규식을 사용하여 필요한 정보 추출
                    const phoneMatch = line.match(/\b(010\d{8}|\d{8,11})\b/); // 전화번호 (010 포함 또는 8~11자리 숫자)
                    const sfMatch = line.match(/SF\d+/); // SF 운송장 번호
                    const kgMatch = line.match(/(\d+\.\d+)\s*KG/i); // 무게 (e.g., 1.25 KG)

                    const phone = phoneMatch ? phoneMatch[0] : '';
                    const waybillMain = sfMatch ? sfMatch[0] : '';
                    const weight = kgMatch ? kgMatch[1] : '';
                    
                    // 추출된 정보를 원래 줄에서 제거하여 나머지 텍스트를 만듦
                    let remainingText = line
                        .replace(phone, '')
                        .replace(waybillMain, '')
                        .replace(/(\d+\.\d+)\s*KG/i, '')
                        .replace(/\b\d{4,}\b/g, '') // 운송장 번호 아래 숫자 등 불필요한 긴 숫자 제거
                        .trim();
                    
                    // 남은 텍스트에서 주소, 수하인 등을 추측
                    // (이 부분은 완벽하지 않을 수 있으며, 데이터 형식에 따라 추가적인 규칙이 필요할 수 있습니다)
                    const parts = remainingText.split(/\s{2,}/).filter(p => p.trim() !== '' && p.length > 1);

                    // 예시: 가장 긴 텍스트 조각을 주소로, 나머지를 수하인/회사명으로 가정
                    let address = '';
                    let receiverParts = [];
                    if (parts.length > 1) {
                        // 가장 긴 부분을 주소로 가정 (Gyeonggi-do... 같이 긴 텍스트)
                        const addressIndex = parts.indexOf(parts.reduce((a, b) => a.length > b.length ? a : b));
                        address = parts.splice(addressIndex, 1)[0];
                        receiverParts = parts;
                    } else {
                        address = parts[0] || '';
                    }
                    
                    // 수하인/회사명 재조합
                    const receiver = receiverParts.join(' ');

                    const item = {
                        id: Date.now() + index,
                        date: new Date().toISOString().slice(0, 10),
                        receiver: receiver || '확인필요', // 수하인
                        phone: phone, // 추출한 전화번호
                        address: address, // 추출한 주소
                        product: '상품명',
                        quantity: '1',
                        waybill: waybillMain, // 추출한 운송장 번호
                        weight: weight, // 추출한 무게
                        note: ''
                    };
                    
                    // 최소한 운송장 번호나 전화번호가 있어야 유효한 데이터로 간주
                    if (item.waybill || item.phone) {
                        newItems.push(item);
                    }
                });

                if (newItems.length > 0) {
                    items.push(...newItems);
                    saveAndLoadItems();
                    resultDiv.textContent = `${newItems.length}개의 항목이 추가되었습니다.`;
                } else {
                     // 문제가 된 원본 텍스트를 보여주어 디버깅에 도움
                    resultDiv.textContent = '유효한 데이터를 찾지 못했습니다. OCR 결과: ' + text;
                }

            } catch (error) {
                console.error('OCR 처리 중 오류 발생:', error);
                resultDiv.textContent = '오류가 발생했습니다. 콘솔을 확인해주세요.';
            } finally {
                // 파일 입력 초기화 (같은 파일 다시 올릴 수 있도록)
                event.target.value = null;
            }
        }


        // 이벤트 리스너 연결
        addBtn.addEventListener('click', addItem);
        searchInput.addEventListener('input', filterItems);
        exportBtn.addEventListener('click', exportToExcel);
        itemList.addEventListener('click', handleTableClick);
        itemList.addEventListener('input', handleTableEdit); // 'blur' 대신 'input' 사용
        pasteBtn.addEventListener('click', handlePaste);
        imageUpload.addEventListener('change', handleImageUpload);


        // 페이지 로드 시 데이터 불러오기
        document.addEventListener('DOMContentLoaded', saveAndLoadItems);
    </script>
</body>
</html>
