<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>배송 시트</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        html {
            scroll-behavior: auto !important; /* JS로 부드러운 스크롤을 제어하기 위해 기본 스크롤 동작을 즉시로 변경 */
        }
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding-bottom: 80px;
            overscroll-behavior-y: contain;
        }
        .signature-modal, .confirmation-modal, .suggestion-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            padding: 1rem;
        }
        .signature-modal-content, .confirmation-modal-content, .suggestion-modal-content {
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 1.5rem;
            width: 100%;
            max-width: 28rem;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #2563eb;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes slideInLeft {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .animate-slide-in-left { animation: slideInLeft 0.3s ease-out forwards; }
        .animate-slide-in-right { animation: slideInRight 0.3s ease-out forwards; }
        #delivery-cards-container {
            transition: transform 0.1s ease-out;
            will-change: transform;
        }
        #filter-buttons-container, #search-bar-container {
            position: fixed;
            left: 0;
            width: 100vw;
            will-change: transform, top;
        }
        /* ✨ 퀵-스크롤 핸들 스타일 시작 ✨ */
        #quick-scroll-container {
            position: fixed;
            top: 0;
            right: 0;
            height: 100%;
            width: 40px; /* 핸들 터치 영역 확장 */
            display: none; /* '배송중' 탭에서만 보이도록 JS로 제어 */
            z-index: 40;
            user-select: none;
            -webkit-user-select: none;
        }
        #quick-scroll-handle {
            position: absolute;
            right: 8px; /* 오른쪽 여백 확보 */
            top: 50%;
            width: 24px; /* 핸들 두께 */
            height: 50px; /* 핸들 길이 */
            background-color: rgba(0, 0, 0, 0.25);
            border-radius: 12px;
            cursor: grab;
            transition: background-color 0.2s; /* 드래그 중이 아닐때만 top 전환 효과 적용 */
        }
        #quick-scroll-handle:not(.active) {
            transition: background-color 0.2s, top 0.15s ease-out;
        }
        #quick-scroll-handle.active {
            background-color: rgba(37, 99, 235, 0.7); /* 활성화 시 파란색으로 변경 */
            cursor: grabbing;
        }
        #quick-scroll-bubble {
            position: absolute;
            right: 50px; /* 핸들 왼쪽으로 충분히 이동 */
            top: 50%;
            transform: translateY(-50%);
            padding: 10px 20px;
            background-color: rgba(0, 0, 0, 0.75);
            color: white;
            font-size: 1.5rem; /* 글자 크기 증가 */
            font-weight: 700;  /* 폰트 굵게 */
            border-radius: 16px;
            display: none;
            pointer-events: none; /* 버블이 터치를 방해하지 않도록 */
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        #quick-scroll-handle.active ~ #quick-scroll-bubble {
             transition: none; /* 드래그 중에는 부드러운 효과 제거 */
        }
        /* ✨ 퀵-스크롤 핸들 스타일 끝 ✨ */
    </style>
</head>
<body class="min-h-screen bg-gray-100 p-4 sm:p-6 lg:p-8 font-sans">
    <div id="search-bar-container" class="z-30">
        <div class="max-w-md mx-auto bg-white rounded-lg shadow-lg w-full min-w-[320px] p-4">
            <label for="invoiceNumber" class="block text-sm font-medium text-gray-700 sr-only">송장번호 검색</label>
            <div class="flex space-x-2 flex-nowrap">
                <input type="tel" id="invoiceNumber" name="invoiceNumber" placeholder="송장번호 검색" class="w-2/5 p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" inputmode="numeric" pattern="[0-9]*"/>
                <button id="searchButton" class="w-3/10 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">검색</button>
                <button id="resetButton" class="w-3/10 px-4 py-2 bg-gray-400 text-white rounded-md hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50">초기화</button>
            </div>
        </div>
    </div>

    <div id="filter-buttons-container" class="z-20">
        <div class="max-w-md mx-auto bg-white rounded-lg shadow-lg w-full min-w-[320px] p-4">
            <div class="flex justify-around space-x-2 overflow-x-auto" style="-webkit-overflow-scrolling: touch;">
                <button data-filter="배송준비" class="flex-shrink-0 px-3 py-1.5 rounded-full text-sm font-medium transition-colors duration-200 flex items-center justify-center space-x-1 whitespace-nowrap"><span>배송준비</span></button>
                <button data-filter="전체" class="flex-shrink-0 px-3 py-1.5 rounded-full text-sm font-medium transition-colors duration-200 flex items-center justify-center space-x-1 bg-transparent text-gray-700 border border-gray-300 hover:bg-gray-100 whitespace-nowrap"><span>전체</span><span class="text-xs font-semibold px-1.5 py-0.5 rounded-full bg-gray-200 text-gray-700" id="count-전체">0</span></button>
                <button data-filter="배송전" class="flex-shrink-0 px-3 py-1.5 rounded-full text-sm font-medium transition-colors duration-200 flex items-center justify-center space-x-1 bg-transparent text-gray-700 border border-gray-300 hover:bg-gray-100 whitespace-nowrap"><span>배송전</span><span class="text-xs font-semibold px-1.5 py-0.5 rounded-full bg-gray-200 text-gray-700" id="count-배송전">0</span></button>
                <button data-filter="배송중" class="flex-shrink-0 px-3 py-1.5 rounded-full text-sm font-medium transition-colors duration-200 flex items-center justify-center space-x-1 bg-transparent text-gray-700 border border-gray-300 hover:bg-gray-100 whitespace-nowrap"><span>배송중</span><span class="text-xs font-semibold px-1.5 py-0.5 rounded-full bg-gray-200 text-gray-700" id="count-배송중">0</span></button>
                <button data-filter="완료" class="flex-shrink-0 px-3 py-1.5 rounded-full text-sm font-medium transition-colors duration-200 flex items-center justify-center space-x-1 bg-transparent text-gray-700 border border-gray-300 hover:bg-gray-100 whitespace-nowrap"><span>완료</span><span class="text-xs font-semibold px-1.5 py-0.5 rounded-full bg-gray-200 text-gray-700" id="count-완료">0</span></button>
            </div>
        </div>
    </div>

    <div id="data-management-container" class="max-w-md mx-auto mb-6 p-4 bg-white rounded-lg shadow-lg w-full min-w-[320px] space-y-4 hidden">
        <div>
            <h3 class="text-lg font-semibold text-gray-800 mb-2">데이터 내보내기/가져오기</h3>
            <div class="flex space-x-2">
                <button id="exportDataButton" class="w-1/2 px-4 py-2 bg-teal-600 text-white rounded-md hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-teal-500">데이터 파일로 저장</button>
                <label for="importDataInput" class="w-1/2 px-4 py-2 bg-sky-600 text-white rounded-md hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-sky-500 text-center cursor-pointer">파일에서 불러오기</label>
                <input type="file" id="importDataInput" class="hidden" accept=".json"/>
            </div>
        </div>
        <div>
            <h3 class="text-lg font-semibold text-gray-800 mb-2">카드 초기화</h3>
            <button id="clearAllCardsButton" class="w-full px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">모든 카드 삭제</button>
        </div>
    </div>

    <div id="scan-section-container" class="max-w-md mx-auto mb-6 p-4 bg-white rounded-lg shadow-lg w-full min-w-[320px] hidden">
        <h3 class="text-lg font-semibold text-gray-800 mb-3">송장 스캔하여 카드 생성</h3>
        <div class="flex flex-col sm:flex-row items-center space-y-3 sm:space-y-0 sm:space-x-3">
            <input type="file" id="deliverySheetImage" accept="image/*" multiple class="hidden"/>
            <label for="deliverySheetImage" class="flex-1 w-full text-sm text-blue-700 py-2 px-4 rounded-md border border-blue-300 bg-blue-50 font-semibold cursor-pointer hover:bg-blue-100 text-center whitespace-nowrap">사진 선택</label>
            <button id="scanAndGenerateButton" class="w-full sm:w-auto px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50">스캔하여 카드 생성</button>
        </div>
        <div id="selected-files-display" class="mt-2 text-sm text-gray-600 text-center">선택된 파일 없음</div>
        <div id="scan-loading-indicator" class="hidden mt-3 text-center text-sm text-blue-600">
            <div class="spinner mx-auto mb-2"></div>
            <p id="scan-progress-text">송장 스캔 중...</p>
        </div>
        <div id="scan-error-message" class="hidden mt-3 text-center text-sm text-red-600">스캔 실패: <span id="scan-error-text"></span></div>
    </div>

    <div id="delivery-cards-container" class="max-w-md mx-auto"></div>
    
    <div id="quick-scroll-container">
        <div id="quick-scroll-handle"></div>
        <div id="quick-scroll-bubble">1</div>
    </div>

    <div id="signature-modal" class="signature-modal" style="display: none;">
        <div class="signature-modal-content">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">서명 입력</h2>
            <div class="signature-input-container">
                <textarea id="signature-text-input" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" rows="3" placeholder="여기에 서명 내용을 입력하세요."></textarea>
            </div>
            <div class="flex justify-end space-x-2 mt-4">
                <button id="clearSignature" class="px-4 py-2 rounded-md bg-gray-300 text-gray-800 text-sm font-medium hover:bg-gray-400">지우기</button>
                <button id="cancelSignature" class="px-4 py-2 rounded-md bg-red-500 text-white text-sm font-medium hover:bg-red-600">취소</button>
                <button id="saveSignature" class="px-4 py-2 rounded-md bg-blue-600 text-white text-sm font-medium hover:bg-blue-700">저장</button>
            </div>
        </div>
    </div>

    <div id="confirmation-modal" class="confirmation-modal" style="display: none;">
        <div class="confirmation-modal-content">
            <h2 class="text-xl font-semibold mb-4 text-gray-800" id="confirmation-modal-title">확인</h2>
            <p class="text-base text-gray-700 mb-6" id="confirmation-modal-message"></p>
            <div class="flex justify-between space-x-2 mt-4">
                <button id="confirmCancelButton" class="w-1/2 px-4 py-2 rounded-md bg-gray-300 text-gray-800 text-sm font-medium hover:bg-gray-400">취소</button>
                <button id="confirmOkButton" class="w-1/2 px-4 py-2 rounded-md bg-blue-600 text-white text-sm font-medium hover:bg-blue-700">확인</button>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        const GEMINI_PROMPT = `Your task is to extract delivery information from an invoice and convert the address into a standard Korean "Road Name Address" (도로명주소). Your primary goal is accuracy and faithfulness to the source text.

**Core Instruction:**
Combine the address parts found in the image into the correct Korean address format.
The standard format is: \`[시/도] [시/군/구] [도로명] [건물번호], [상세주소]\`.

**Mandatory Rules:**
1.  **NO HALLUCINATION:** You MUST NOT invent or add any address parts that are not explicitly written in the source text. Your only source of truth is the image.
2.  **INTELLIGENT ASSEMBLY:** You must intelligently identify address components (road name, building number, unit numbers) and assemble them in the correct order. Use your knowledge of the Korean address system to determine which number is the building number and which is the detailed unit number.
3.  **SAFE INFERENCE ONLY:** If a district (e.g., '강남구', '해운대구') is present without a city, you must prepend the corresponding city (e.g., '서울', '부산'). This is the only permitted type of inference.

**Execution Examples:**

*   **Scenario 1: Scattered Parts**
    *   **Source Text contains:** \`Gangdong-gu\`, \`Seoul\`, \`56-7\`, \`Cheonho-daero 168na-gil\`, \`202\`
    *   **Correct \`receiverAddressKorean\`:** "서울 강동구 천호대로168나길 56-7, 202"
    *   **Logic:** You identified \`Cheonho-daero 168na-gil\` as the road, recognized \`56-7\` is the building number that should follow it, and treated \`202\` as the detailed part. You correctly assembled these pieces.

*   **Scenario 2: Missing Road Name**
    *   **Source Text contains:** \`Songpagu\`, \`Jamsil the sharp starpark\`, \`101-2503\`
    *   **Correct \`receiverAddressKorean\`:** "서울 송파구 잠실 더샵 스타파크 101-2503"
    *   **Logic:** You correctly inferred '서울' from '송파구'. Since no road name was provided, you correctly did not invent one. You used the building name as the main address component.

*   **Scenario 3: Building Number before Road Name**
    *   **Source Text contains:** \`Gyeonggi-do\`, \`Hwaseong-si\`, \`14\`, \`Seja-ro442beon-gil\`
    *   **Correct \`receiverAddressKorean\`:** "경기 화성시 세자로442번길 14"
    *   **Logic:** You correctly identified that \`14\` is the building number and placed it *after* the road name, following the standard Korean format.

**Output JSON Format:**
Return a JSON array of objects. Each object must contain: \`no\`, \`hawbNo\`, \`receiverAddressKorean\`, \`receiverAddressOriginal\`, \`companyNameKorean\`, \`companyNameOriginal\`, \`receiverNameKorean\`, \`receiverNameOriginal\`, \`receiverTelephoneNo\`.
- \`receiverAddressOriginal\` must be the raw, concatenated text from the image.
- \`receiverTelephoneNo\` must contain only digits.
- Empty strings for missing fields.`;
        
        const dateTimeFormatOptions = { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };

        // --- Helper functions ---
        const cleanStringForDisplay = (str) => {
            if (typeof str !== 'string' || !str) return '';
            return str.replace(/[\n\\]/g, '').trim();
        };

        const formatSinglePhoneNumber = (phoneNumber) => {
            if (typeof phoneNumber !== 'string' || !phoneNumber) return '';
            let cleaned = phoneNumber.replace(/\D/g, '');

            if (cleaned.startsWith('+82010')) { cleaned = '010' + cleaned.substring(6); }
            else if (cleaned.startsWith('82010')) { cleaned = '010' + cleaned.substring(5); }
            else if (cleaned.startsWith('+8210')) { cleaned = '010' + cleaned.substring(5); }
            else if (cleaned.startsWith('8210')) { cleaned = '010' + cleaned.substring(4); }
            else if (cleaned.startsWith('8201') && cleaned.length > 4 && cleaned[4] !== '0') { cleaned = '010' + cleaned.substring(4); }
            else if (cleaned.startsWith('82') && cleaned.length > 2) { cleaned = '0' + cleaned.substring(2); }
            else if (cleaned.length >= 7 && cleaned.length <= 11 && !cleaned.startsWith('0')) { cleaned = '0' + cleaned; }
            
            if (cleaned.startsWith('010') && cleaned.length === 11) return cleaned.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
            if (cleaned.startsWith('02')) {
                if (cleaned.length === 9) return cleaned.replace(/(\d{2})(\d{3})(\d{4})/, '$1-$2-$3');
                if (cleaned.length === 10) return cleaned.replace(/(\d{2})(\d{4})(\d{4})/, '$1-$2-$3');
            }
            if (cleaned.startsWith('031') && cleaned.length === 11) return cleaned.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
            if (cleaned.startsWith('070') && cleaned.length === 11) return cleaned.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
            if (cleaned.length === 10) return cleaned.replace(/(\d{3})(\d{3})(\d{4})/, '$1-$2-$3');
            if (cleaned.length === 9) return cleaned.replace(/(\d{2})(\d{3})(\d{4})/, '$1-$2-$3');
            if (cleaned.length === 8) return cleaned.replace(/(\d{4})(\d{4})/, '$1-$2');
            if (cleaned.length === 7) return cleaned.replace(/(\d{3})(\d{4})/, '$1-$2');

            return cleaned;
        };

        const formatPhoneNumberForDisplay = (phoneNumber) => {
            if (typeof phoneNumber !== 'string' || !phoneNumber) return '';
            const rangeMatch = phoneNumber.match(/^(\d+)-(\d+)$/);
            if (rangeMatch) {
                const baseNumber = rangeMatch[1];
                const suffix = rangeMatch[2];
                if (baseNumber.length >= suffix.length) {
                    const num1 = formatSinglePhoneNumber(baseNumber);
                    const num2Raw = baseNumber.substring(0, baseNumber.length - suffix.length) + suffix;
                    const num2 = formatSinglePhoneNumber(num2Raw);
                    return `${num1} / ${num2}`;
                }
            }
            return formatSinglePhoneNumber(phoneNumber.replace(/\D/g, ''));
        };

        const getCleanPhoneNumber = (phoneNumber) => {
            if (typeof phoneNumber !== 'string' || !phoneNumber) return '';
            const rangeMatch = phoneNumber.match(/^(\d+)-(\d+)$/);
            if (rangeMatch) phoneNumber = rangeMatch[1];
            
            let cleaned = phoneNumber.replace(/\D/g, '');

            if (cleaned.startsWith('+82010')) { cleaned = '010' + cleaned.substring(6); }
            else if (cleaned.startsWith('82010')) { cleaned = '010' + cleaned.substring(5); }
            else if (cleaned.startsWith('+8210')) { cleaned = '010' + cleaned.substring(5); }
            else if (cleaned.startsWith('8210')) { cleaned = '010' + cleaned.substring(4); }
            else if (cleaned.startsWith('8201') && cleaned.length > 4 && cleaned[4] !== '0') { cleaned = '010' + cleaned.substring(4); }
            else if (cleaned.startsWith('82') && cleaned.length > 2) { cleaned = '0' + cleaned.substring(2); }
            else if (cleaned.length >= 7 && cleaned.length <= 11 && !cleaned.startsWith('0')) { cleaned = '0' + cleaned; }

            return cleaned;
        };

        const formatHawbNoForDisplay = (hawbNo) => {
            if (!hawbNo || hawbNo.length < 4) return hawbNo;
            const prefix = hawbNo.substring(0, hawbNo.length - 4);
            const suffix = hawbNo.substring(hawbNo.length - 4);
            return `${prefix} ${suffix}`;
        };

        const formatCompletionTime = (dateTimeString) => {
            if (!dateTimeString) return '';
            const parts = dateTimeString.split(' ');
            if (parts.length >= 4) {
                const [hour, minute] = parts[3].split(':');
                return `${hour}:${minute}`;
            }
            return '';
        };
        
        const extractClipboardAddressPart = (fullAddress) => {
            if (!fullAddress || typeof fullAddress !== 'string') return '';
            let matchDongHo = fullAddress.match(/(\d+동\s*\d+호)/);
            if (matchDongHo?.[1]) return matchDongHo[1].trim();

            const commaIndex = fullAddress.indexOf(',');
            if (commaIndex !== -1) {
                const detailedAddressPart = fullAddress.substring(commaIndex + 1).trim();
                let matchHyphenUnitInDetailed = detailedAddressPart.match(/(\b\d{1,4}-\d{1,4}\b)(?:호)?(?!\S)/);
                if (matchHyphenUnitInDetailed?.[1]) return matchHyphenUnitInDetailed[1].trim();
                return detailedAddressPart;
            }
            
            const unitMatch = fullAddress.match(/\s(\d{1,5}-\d{1,5}|\d+[동호])$/);
            if(unitMatch) {
                return unitMatch[1].trim();
            }

            return fullAddress;
        };

        const isValidAddressForMap = (address) => {
            return !!(address && address.trim().length > 0);
        };

        const extractMapSearchQuery = (address) => {
            if (!address) return '';

            // 1. 도로명 주소 패턴 (최우선)
            const roadAddrMatch = address.match(/([가-힣\d]+(?:로|길|대로|번길))\s*([\d\-]+)/);
            if (roadAddrMatch) {
                return `${roadAddrMatch[1]} ${roadAddrMatch[2]}`.trim();
            }

            // 2. 지번 주소 패턴
            const jibunAddrMatch = address.match(/([가-힣\d]+(?:동|리))\s*([\d\-]+)/);
            if (jibunAddrMatch) {
                return `${jibunAddrMatch[1]} ${jibunAddrMatch[2]}`.trim();
            }
            
            // 3. 동/리 이름만
            const dongRiMatch = address.match(/([가-힣\d]+(?:동|리))/);
            if (dongRiMatch) {
                return dongRiMatch[1].trim();
            }

            // 4. 위 패턴 모두 없을 시 안전한 폴백
            return address.trim();
        };

        // --- Global state and DOM elements ---
        let deliveryItems = [];
        let searchTerm = '';
        let activeFilter = '전체';
        const filterCategories = ['배송준비', '전체', '배송전', '배송중', '완료'];
        let filterScrollPositions = {};
        let currentFileToScan = null;
        let failedFileObjects = []; 
        let currentSignatureItemNo = null;
        let onConfirmCallback = null;

        const searchBarContainer = document.getElementById('search-bar-container');
        const invoiceNumberInput = document.getElementById('invoiceNumber');
        const searchButton = document.getElementById('searchButton');
        const resetButton = document.getElementById('resetButton');
        const filterButtonsContainer = document.getElementById('filter-buttons-container');
        const deliveryCardsContainer = document.getElementById('delivery-cards-container');
        const deliverySheetImageInput = document.getElementById('deliverySheetImage');
        const scanAndGenerateButton = document.getElementById('scanAndGenerateButton');
        const scanLoadingIndicator = document.getElementById('scan-loading-indicator');
        const scanErrorMessage = document.getElementById('scan-error-message');
        const scanErrorText = document.getElementById('scan-error-text');
        const scanSectionContainer = document.getElementById('scan-section-container');
        const clearAllCardsButton = document.getElementById('clearAllCardsButton');
        const dataManagementContainer = document.getElementById('data-management-container');
        const exportDataButton = document.getElementById('exportDataButton');
        const importDataInput = document.getElementById('importDataInput');
        const scanProgressText = document.getElementById('scan-progress-text');
        const selectedFilesDisplay = document.getElementById('selected-files-display');
        const signatureModal = document.getElementById('signature-modal');
        const signatureTextInput = document.getElementById('signature-text-input');
        const clearSignatureBtn = document.getElementById('clearSignature');
        const cancelSignatureBtn = document.getElementById('cancelSignature');
        const saveSignatureBtn = document.getElementById('saveSignature');
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmationModalTitle = document.getElementById('confirmation-modal-title');
        const confirmationModalMessage = document.getElementById('confirmation-modal-message');
        const confirmOkButton = document.getElementById('confirmOkButton');
        const confirmCancelButton = document.getElementById('confirmCancelButton');

        // --- Modal & Core Logic Functions ---
        const openSignatureModal = (itemNo) => { currentSignatureItemNo = itemNo; signatureModal.style.display = 'flex'; signatureTextInput.value = ''; signatureTextInput.focus(); };
        const closeSignatureModal = () => { signatureModal.style.display = 'none'; currentSignatureItemNo = null; };
        const saveSignature = () => {
            if (currentSignatureItemNo === null) return;
            const signatureText = signatureTextInput.value.trim();
            if (signatureText === '') { showMessage('서명 내용을 입력해주세요.'); return; }
            const currentTime = new Date().toLocaleString('ko-KR', dateTimeFormatOptions);
            handleStatusChange(currentSignatureItemNo, '완료', currentTime, '서명', signatureText);
            closeSignatureModal();
            showMessage('서명이 성공적으로 저장되었습니다.', '성공');
        };
        
        const openConfirmationModal = (message, onOk, okText = '확인', cancelText = '취소') => {
            confirmationModalTitle.textContent = '확인';
            confirmationModalMessage.textContent = message;
            confirmOkButton.textContent = okText;
            confirmCancelButton.textContent = cancelText;
            confirmCancelButton.style.display = '';
            onConfirmCallback = onOk;
            confirmationModal.style.display = 'flex';
        };

        const closeConfirmationModal = () => { 
            confirmationModal.style.display = 'none'; 
            onConfirmCallback = null; 
            confirmCancelButton.style.display = ''; 
            confirmOkButton.textContent = '확인';
            confirmCancelButton.textContent = '취소';
        };

        const showMessage = (message, title = '알림') => {
            confirmationModalTitle.textContent = title;
            confirmationModalMessage.textContent = message;
            confirmCancelButton.style.display = 'none';
            confirmOkButton.textContent = '확인';
            onConfirmCallback = closeConfirmationModal;
            confirmationModal.style.display = 'flex';
        };
        
        confirmOkButton.addEventListener('click', () => { if (onConfirmCallback) onConfirmCallback(); closeConfirmationModal(); });
        confirmCancelButton.addEventListener('click', closeConfirmationModal);
        clearSignatureBtn.addEventListener('click', () => signatureTextInput.value = '');
        cancelSignatureBtn.addEventListener('click', closeSignatureModal);
        saveSignatureBtn.addEventListener('click', saveSignature);

        const saveDeliveryItemsToLocalStorage = () => {
            localStorage.setItem('deliveryItems', JSON.stringify(deliveryItems));
            localStorage.setItem('filterScrollPositions', JSON.stringify(filterScrollPositions));
        };
        const handleStatusChange = (itemNo, newStatus, completionTime = null, completionType = null, completionDetail = null) => {
            deliveryItems = deliveryItems.map(item => item.no === itemNo ? { ...item, status: newStatus, deliveryCompletionTime: completionTime, completionType, completionDetail, isHawbConfirmed: newStatus !== '배송전' } : item);
            saveDeliveryItemsToLocalStorage();
            renderDeliveryCards();
            updateFilterCounts();
        };
        const handleCheckboxToggleAndResetSearch = (itemNo, newCheckboxState) => {
            deliveryItems = deliveryItems.map(item => item.no === itemNo ? { ...item, isHawbConfirmed: newCheckboxState, status: newCheckboxState ? '배송중' : '배송전', deliveryCompletionTime: newCheckboxState ? item.deliveryCompletionTime : null, completionType: newCheckboxState ? item.completionType : null, completionDetail: newCheckboxState ? item.completionDetail : null } : item);
            saveDeliveryItemsToLocalStorage();
            searchTerm = '';
            invoiceNumberInput.value = '';
            renderDeliveryCards();
            updateFilterCounts();
        };
        
        const openNaverMap = (address, no) => {
            const addressForMapSearch = extractMapSearchQuery(address);
            const textToCopy = `${no}. ${extractClipboardAddressPart(address)}`;
            const textarea = document.createElement('textarea');
            textarea.value = textToCopy;
            textarea.style.position = 'fixed';
            textarea.style.opacity = 0;
            document.body.appendChild(textarea);
            textarea.focus();
            textarea.select();
            try { document.execCommand('copy'); }
            catch (err) { console.error('클립보드 복사 실패:', err); showMessage('클립보드 복사에 실패했습니다.', '복사 실패'); }
            document.body.removeChild(textarea);
            window.location.href = `nmap://search?query=${encodeURIComponent(addressForMapSearch)}&appname=DeliveryApp`;
        };

        const highlightHawbNo = (hawbNo, term) => {
            if (!hawbNo) return '';
            const formattedHawbNo = formatHawbNoForDisplay(hawbNo);
            if (!term || !formattedHawbNo.includes(term)) return formattedHawbNo;
            const escapedTerm = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            return formattedHawbNo.split(new RegExp(`(${escapedTerm})`, 'gi')).map(part => part.toLowerCase() === term.toLowerCase() ? `<span class="bg-yellow-200 rounded px-0.5">${part}</span>` : part).join('');
        };
        
        // --- Render function ---
        const renderDeliveryCards = (animationClass = '') => {
            let currentFilteredData = deliveryItems;
            if (activeFilter === '배송준비') { deliveryCardsContainer.innerHTML = ''; return; }

            if (searchTerm) {
                const cleanedSearchTerm = searchTerm.replace(/\D/g, '');
                currentFilteredData = currentFilteredData.filter(item => item.hawbNo?.replace(/\D/g, '').includes(cleanedSearchTerm));
            }
            if (activeFilter !== '전체') {
                currentFilteredData = currentFilteredData.filter(item => item.status === activeFilter);
            }

            deliveryCardsContainer.classList.remove('animate-slide-in-left', 'animate-slide-in-right');
            deliveryCardsContainer.style.animation = '';

            if (currentFilteredData.length === 0) {
                deliveryCardsContainer.innerHTML = '<p class="text-center text-gray-600 px-4">해당하는 항목이 없습니다.</p>';
                return;
            }

            deliveryCardsContainer.innerHTML = currentFilteredData.map(data => {
                const isMapButtonActive = isValidAddressForMap(data.receiverAddressKorean);
                return `
                    <div class="${data.status === '배송중' ? 'bg-blue-100' : (data.status === '완료' ? 'bg-gray-200' : 'bg-white')} rounded-lg shadow-lg p-6 mb-4 border border-gray-200" data-no="${data.no}">
                        <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-200">
                            ${data.status !== '완료' ? `
                                <div class="flex items-center space-x-2 w-full justify-between">
                                    <h3 class="text-3xl font-semibold text-red-500">${data.no}</h3>
                                    <span class="text-base font-bold text-gray-600 whitespace-nowrap">${highlightHawbNo(data.hawbNo, searchTerm)}</span>
                                    <input type="checkbox" data-action="toggle-hawb-confirm" data-no="${data.no}" ${data.isHawbConfirmed ? 'checked' : ''} class="form-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded"/>
                                </div>
                            ` : `
                                <div class="text-xl font-semibold text-gray-700 text-left w-full">
                                    <span class="text-red-500 text-2xl mr-8">${data.no}</span>
                                    ${data.completionType === '서명' && data.completionDetail ? `<span class="text-lg font-semibold text-gray-800 p-1 border border-dashed border-gray-400 rounded-md bg-gray-50 inline-block">${data.completionDetail}</span>` : data.completionType === '본인확인' ? `${data.completionType} (${data.completionDetail})` : `${data.completionType || ''}`}
                                    <span class="ml-4">${formatCompletionTime(data.deliveryCompletionTime)}</span>
                                </div>
                            `}
                        </div>
                        <div class="space-y-3" data-details-container="${data.no}" ${data.status === '완료' ? 'style="display:none;"' : ''}>
                            <div><p class="text-sm font-medium text-gray-700">주소:</p><div class="flex items-center justify-between"><p class="text-base text-blue-600 font-semibold">${data.receiverAddressKorean}</p><button data-action="open-naver-map" data-address="${data.receiverAddressKorean}" data-no="${data.no}" class="${isMapButtonActive ? 'ml-2 px-3 py-1.5 rounded-full bg-green-500 text-white text-sm font-medium hover:bg-green-600' : 'ml-2 px-3 py-1.5 rounded-full bg-gray-300 text-gray-500 text-sm font-medium cursor-not-allowed opacity-50'}" ${isMapButtonActive ? '' : 'disabled'}>지도보기</button></div>${data.receiverAddressOriginal ? `<p class="text-xs text-gray-500 ml-1">(${data.receiverAddressOriginal})</p>` : ''}</div>
                            <div><p class="text-sm font-medium text-gray-700">회사명:</p><p class="text-base text-blue-600 font-semibold">${data.companyNameKorean || 'N/A'}</p>${data.companyNameOriginal && data.companyNameOriginal !== data.companyNameKorean ? `<p class="text-xs text-gray-500 ml-1">(${data.companyNameOriginal})</p>` : ''}</div>
                            <div><p class="text-sm font-medium text-gray-700">이름:</p><p class="text-base text-blue-600 font-semibold">${data.receiverNameKorean || 'N/A'}</p>${data.receiverNameOriginal && data.receiverNameOriginal !== data.receiverNameKorean ? `<p class="text-xs text-gray-500 ml-1">(${data.receiverNameOriginal})</p>` : ''}</div>
                            <div><p class="text-sm font-medium text-gray-700">전화번호:</p><div class="flex items-center space-x-2"><span class="text-base text-blue-600 font-semibold">${formatPhoneNumberForDisplay(data.receiverTelephoneNo)}</span><a href="tel:${getCleanPhoneNumber(data.receiverTelephoneNo)}" class="px-3 py-1.5 rounded-full bg-transparent text-orange-500 border border-orange-500 text-sm font-medium hover:bg-orange-100">전화</a><a href="sms:${getCleanPhoneNumber(data.receiverTelephoneNo)}" class="px-3 py-1.5 rounded-full bg-transparent text-blue-500 border border-blue-500 text-sm font-medium hover:bg-blue-100">문자</a></div></div>
                            ${data.status === '완료' ? `<div class="mt-4 pt-4 border-t border-gray-200 flex justify-center"><button data-action="revert-delivery" data-no="${data.no}" class="px-4 py-2 rounded-md bg-red-500 text-white text-sm font-medium hover:bg-red-600">되돌리기</button></div>` : ''}
                        </div>
                        ${data.status === '배송중' ? `<div class="mt-4 pt-4 border-t border-gray-200 flex justify-between space-x-2"><button data-action="identity-verification" data-no="${data.no}" class="w-2/5 px-3 py-1.5 rounded-md bg-green-600 text-white text-sm font-medium">본인확인</button><button data-action="front-door-delivery" data-no="${data.no}" class="w-2/5 px-3 py-1.5 rounded-md bg-purple-600 text-white text-sm font-medium">문앞배송</button><button data-action="sign-delivery" data-no="${data.no}" class="w-1/5 px-3 py-1.5 rounded-md bg-indigo-600 text-white text-sm font-medium">서명</button></div>` : ''}
                        ${data.status === '완료' ? `<div class="pt-4 flex flex-col items-center"><button data-action="toggle-details" data-no="${data.no}" class="px-4 py-2 rounded-md bg-gray-300 text-gray-800 text-sm font-medium">상세보기</button></div>` : ''}
                </div>
            `;
        }).join('');
        
        if (animationClass) {
            deliveryCardsContainer.style.transform = 'translateX(0px)';
            deliveryCardsContainer.classList.add(animationClass);
            setTimeout(() => { deliveryCardsContainer.classList.remove(animationClass); deliveryCardsContainer.style.animation = ''; }, 300);
        }
    };

    // --- UI Update & Event Listener Setup ---
    const updateFilterCounts = () => {
        document.getElementById('count-전체').textContent = deliveryItems.length;
        document.getElementById('count-배송전').textContent = deliveryItems.filter(item => item.status === '배송전').length;
        document.getElementById('count-배송중').textContent = deliveryItems.filter(item => item.status === '배송중').length;
        document.getElementById('count-완료').textContent = deliveryItems.filter(item => item.status === '완료').length;
    };
    
    const quickScrollContainer = document.getElementById('quick-scroll-container');
    const quickScrollHandle = document.getElementById('quick-scroll-handle');
    const quickScrollBubble = document.getElementById('quick-scroll-bubble');
    
    const updateStickyHeaderPositions = () => {
        requestAnimationFrame(() => {
            let topOffset = 0;
            const isSearchVisible = ['전체', '배송전'].includes(activeFilter);
            
            searchBarContainer.classList.toggle('hidden', !isSearchVisible);
            if (isSearchVisible) {
                searchBarContainer.style.top = `${topOffset}px`; 
                topOffset += searchBarContainer.offsetHeight;
            }
            
            filterButtonsContainer.style.top = `${topOffset}px`;
            topOffset += filterButtonsContainer.offsetHeight;
            document.body.style.paddingTop = `${topOffset}px`;

            const isScanVisible = activeFilter === '배송준비';
            scanSectionContainer.classList.toggle('hidden', !isScanVisible);
            dataManagementContainer.classList.toggle('hidden', !isScanVisible);

            const deliveryInProgressCount = deliveryItems.filter(item => item.status === '배송중').length;
            quickScrollContainer.style.display = (activeFilter === '배송중' && deliveryInProgressCount > 0) ? 'block' : 'none';
        });
    };
    
    filterButtonsContainer.addEventListener('click', (event) => {
        const button = event.target.closest('button[data-filter]');
        if (!button || button.dataset.filter === activeFilter) return;

        filterScrollPositions[activeFilter] = window.scrollY;
        activeFilter = button.dataset.filter;

        filterButtonsContainer.querySelectorAll('button').forEach(btn => {
            const isActive = btn.dataset.filter === activeFilter;
            btn.classList.remove('bg-blue-500', 'text-white', 'shadow', 'bg-transparent', 'text-gray-700', 'border', 'border-gray-300', 'hover:bg-gray-100');
            if (isActive) {
                btn.classList.add('bg-blue-500', 'text-white', 'shadow');
            } else {
                btn.classList.add('bg-transparent', 'text-gray-700', 'border', 'border-gray-300', 'hover:bg-gray-100');
            }
        });

        renderDeliveryCards();
        updateStickyHeaderPositions();
        button.scrollIntoView({ behavior: 'smooth', inline: 'center' });
        setTimeout(() => window.scrollTo({ top: filterScrollPositions[activeFilter] || 0, behavior: 'auto' }), 0);
    });

    searchButton.addEventListener('click', () => { searchTerm = invoiceNumberInput.value.replace(/\D/g, ''); renderDeliveryCards(); window.scrollTo({ top: 0, behavior: 'auto' }); filterScrollPositions[activeFilter] = 0; });
    resetButton.addEventListener('click', () => { filterScrollPositions[activeFilter] = window.scrollY; searchTerm = ''; invoiceNumberInput.value = ''; renderDeliveryCards(); setTimeout(() => window.scrollTo({ top: filterScrollPositions[activeFilter] || 0, behavior: 'auto' }), 0); });
    invoiceNumberInput.addEventListener('input', (event) => { searchTerm = event.target.value.replace(/\D/g, ''); renderDeliveryCards(); window.scrollTo({ top: 0, behavior: 'auto' }); filterScrollPositions[activeFilter] = 0; });

    deliverySheetImageInput.addEventListener('change', (event) => {
        currentFileToScan = event.target.files;
        selectedFilesDisplay.textContent = currentFileToScan.length > 0 ? `선택된 파일: ${Array.from(currentFileToScan).map(f => f.name).join(', ')}` : '선택된 파일 없음';
    });
    
    clearAllCardsButton.addEventListener('click', () => {
        openConfirmationModal("모든 카드를 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.", () => {
            deliveryItems = [];
            saveDeliveryItemsToLocalStorage();
            renderDeliveryCards();
            updateFilterCounts();
            showMessage("모든 카드가 삭제되었습니다.");
        });
    });

    // --- Scan, Import, Export Logic ---
    async function performScan(filesToScan) {
        const mergedResults = {};
        const failedFileObjectsForRetry = [];
        
        for (let i = 0; i < filesToScan.length; i++) {
            const file = filesToScan[i];
            scanProgressText.textContent = `이미지 분석 중 (${i + 1}/${filesToScan.length})...`;
            
            try {
                const base64ImageData = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });

                const payload = {
                    contents: [{ role: "user", parts: [{ text: GEMINI_PROMPT }, { inlineData: { mimeType: file.type, data: base64ImageData } }] }],
                    generationConfig: { 
                        temperature: 0,
                        responseMimeType: "application/json",
                        responseSchema: { type: "ARRAY", items: { type: "OBJECT", properties: { "no": { "type": "STRING" }, "hawbNo": { "type": "STRING" }, "receiverAddressKorean": { "type": "STRING" }, "receiverAddressOriginal": { "type": "STRING" }, "companyNameKorean": { "type": "STRING" }, "companyNameOriginal": { "type": "STRING" }, "receiverNameKorean": { "type": "STRING" }, "receiverNameOriginal": { "type": "STRING" }, "receiverTelephoneNo": { "type": "STRING" } } } } }
                };
                
                const tempApiKeyForLocalTest = "AIzaSyCNYPhrVzBC-wQoZU3ftYEznfUZv3vZEFs";
                const directApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${tempApiKeyForLocalTest}`;

                const response = await fetch(directApiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) { throw new Error(`API 요청 실패 (상태: ${response.status})`); }
                const result = await response.json();

                if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    const parsedData = JSON.parse(result.candidates[0].content.parts[0].text);
                    if (Array.isArray(parsedData) && parsedData.length > 0) {
                        parsedData.forEach(item => {
                            const no = parseInt(item.no || '0', 10);
                            const hawbNo = item.hawbNo || '';
                            if (no > 0 && hawbNo.trim() !== '') { mergedResults[no] = item; }
                        });
                    } else { throw new Error("이미지에서 유효한 데이터를 찾지 못했습니다."); }
                } else { throw new Error("API가 분석 가능한 텍스트를 반환하지 않았습니다."); }
            } catch (error) {
                console.error(`파일 스캔 오류 (${file.name}):`, error);
                failedFileObjectsForRetry.push(file);
                continue;
            }
        }

        let newCount = 0;
        let updateCount = 0;
        const allNewItems = Object.values(mergedResults);

        if (allNewItems.length > 0) {
            const finalItems = allNewItems.map(item => ({
                no: parseInt(item.no, 10),
                hawbNo: item.hawbNo || '',
                receiverAddressKorean: item.receiverAddressKorean || '',
                receiverAddressOriginal: cleanStringForDisplay(item.receiverAddressOriginal),
                companyNameKorean: item.companyNameKorean || '',
                companyNameOriginal: cleanStringForDisplay(item.companyNameOriginal),
                receiverNameKorean: item.receiverNameKorean || '',
                receiverNameOriginal: cleanStringForDisplay(item.receiverNameOriginal),
                receiverTelephoneNo: item.receiverTelephoneNo ? getCleanPhoneNumber(item.receiverTelephoneNo) : '',
                status: '배송전', isHawbConfirmed: false,
                deliveryCompletionTime: null, completionType: null, completionDetail: null,
            }));
            
            finalItems.forEach(newItem => {
                const existingItemIndex = deliveryItems.findIndex(item => item.no === newItem.no);
                if (existingItemIndex > -1) {
                    deliveryItems[existingItemIndex] = newItem;
                    updateCount++;
                } else {
                    deliveryItems.push(newItem);
                    newCount++;
                }
            });
            deliveryItems.sort((a, b) => a.no - b.no);
            saveDeliveryItemsToLocalStorage();
        }
        return { newCount, updateCount, failedFiles: failedFileObjectsForRetry };
    }

    scanAndGenerateButton.addEventListener('click', async () => {
        if (!currentFileToScan || currentFileToScan.length === 0) { showMessage('스캔할 이미지를 선택해주세요.'); return; }
        
        scanLoadingIndicator.style.display = 'block';
        scanErrorMessage.style.display = 'none';
        failedFileObjects = []; 

        try {
            const initialFiles = Array.from(currentFileToScan);
            const result = await performScan(initialFiles);

            if (result.failedFiles.length === 0) {
                showMessage(`${result.updateCount}개의 카드가 업데이트되고 ${result.newCount}개의 카드가 새로 생성되었습니다.`);
            } else {
                failedFileObjects = result.failedFiles;
                const successCount = initialFiles.length - failedFileObjects.length;
                const failedFileNames = failedFileObjects.map(f => f.name);
                
                const message = `총 ${initialFiles.length}개 중 ${successCount}개 파일 스캔 성공.\n\n실패한 ${failedFileObjects.length}개 파일을 다시 스캔하시겠습니까?\n- ${failedFileNames.join('\n- ')}`;

                const onRetry = async () => {
                    scanLoadingIndicator.style.display = 'block';
                    scanProgressText.textContent = '실패한 파일 재시도 중...';
                    
                    const retryResult = await performScan(failedFileObjects);

                    scanLoadingIndicator.style.display = 'none';

                    if (retryResult.failedFiles.length === 0) {
                        showMessage(`재시도 성공: ${retryResult.updateCount + retryResult.newCount}개의 카드가 추가/업데이트되었습니다.`);
                    } else {
                        const stillFailingNames = retryResult.failedFiles.map(f => f.name);
                        showMessage(`재시도 후에도 아래 ${stillFailingNames.length}개 파일이 실패했습니다.\n- ${stillFailingNames.join('\n- ')}`, '재시도 일부 실패');
                    }
                    renderDeliveryCards();
                    updateFilterCounts();
                };
                openConfirmationModal(message, onRetry, '실패 파일 재시도', '나중에');
            }
        } catch (error) {
            console.error("전체 스캔 프로세스 오류:", error);
            scanErrorText.textContent = error.message;
            scanErrorMessage.style.display = 'block';
        } finally {
            scanLoadingIndicator.style.display = 'none';
            deliverySheetImageInput.value = '';
            currentFileToScan = null;
            selectedFilesDisplay.textContent = '선택된 파일 없음';
            renderDeliveryCards();
            updateFilterCounts();
            updateStickyHeaderPositions();
        }
    });
    
    exportDataButton.addEventListener('click', () => {
        if (deliveryItems.length === 0) { showMessage("저장할 데이터가 없습니다."); return; }
        try {
            const today = new Date();
            const formattedDate = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            const fileName = `SF-${formattedDate}.json`;
            const dataStr = JSON.stringify(deliveryItems, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showMessage(`데이터가 '${fileName}' 파일로 저장되었습니다.`);
        } catch (error) {
            showMessage(`데이터 저장 중 오류가 발생했습니다: ${error.message}`, "오류");
        }
    });

    importDataInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;

        openConfirmationModal( `'${file.name}' 파일의 데이터로 현재 목록을 모두 덮어씁니다. 계속하시겠습니까?`, () => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (!Array.isArray(importedData)) throw new Error("파일 형식이 올바르지 않습니다 (배열이 아님).");
                        if (importedData.length > 0 && typeof importedData[0].no === 'undefined') throw new Error("파일 내용이 올바른 배송 데이터 형식이 아닙니다.");
                        deliveryItems = importedData;
                        saveDeliveryItemsToLocalStorage();
                        updateFilterCounts();
                        updateStickyHeaderPositions();
                        renderDeliveryCards();
                        showMessage(`'${file.name}' 파일에서 ${deliveryItems.length}개의 항목을 불러왔습니다.`);
                    } catch (error) {
                        showMessage(`파일을 불러오는 중 오류가 발생했습니다: ${error.message}`, "오류");
                    } finally {
                        importDataInput.value = '';
                    }
                };
                reader.onerror = () => { showMessage("파일을 읽는 데 실패했습니다.", "오류"); importDataInput.value = ''; };
                reader.readAsText(file);
            }
        );
    });

    // --- Swipe & Initial Load ---
    let touchStartX = 0, touchStartY = 0;
    document.body.addEventListener('touchstart', e => { touchStartX = e.touches[0].clientX; touchStartY = e.touches[0].clientY; }, { passive: true });
    document.body.addEventListener('touchmove', e => { if (Math.abs(e.touches[0].clientX - touchStartX) > 10 && Math.abs(e.touches[0].clientX - touchStartX) > Math.abs(e.touches[0].clientY - touchStartY)) e.preventDefault(); }, { passive: false });
    document.body.addEventListener('touchend', e => {
        const swipeDistanceX = e.changedTouches[0].clientX - touchStartX;
        if (Math.abs(swipeDistanceX) > 50 && Math.abs(swipeDistanceX) > Math.abs(e.changedTouches[0].clientY - touchStartY)) {
            const currentIndex = filterCategories.indexOf(activeFilter);
            const direction = swipeDistanceX > 0 ? -1 : 1;
            const newIndex = Math.max(0, Math.min(filterCategories.length - 1, currentIndex + direction));
            if (newIndex !== currentIndex) filterButtonsContainer.querySelector(`[data-filter="${filterCategories[newIndex]}"]`)?.click();
        }
    });
    
    // ✨ 퀵-스크롤 핸들 로직 ("디지털 다이얼" 최종 버전) ✨
    const setupQuickScroll = () => {
        let isDragging = false;
        let cardElementsCache = [];
        let cardPositionsCache = [];
        let lastScrolledIndex = -1;
        let headerHeight = 0;

        const onDragStart = (e) => {
            e.preventDefault();
            isDragging = true;
            quickScrollHandle.classList.add('active');
            quickScrollBubble.style.display = 'block';
            
            cardElementsCache = Array.from(deliveryCardsContainer.querySelectorAll('[data-no]'));
            if (cardElementsCache.length === 0) { onDragEnd(); return; }
            
            headerHeight = filterButtonsContainer.offsetTop + filterButtonsContainer.offsetHeight;
            cardPositionsCache = cardElementsCache.map(card => card.offsetTop - headerHeight);
            
            onDrag(e);
        };
        
        const onDragEnd = () => {
            if (!isDragging) return;
            isDragging = false;
            quickScrollHandle.classList.remove('active');
            quickScrollBubble.style.display = 'none';
            lastScrolledIndex = -1;
        };

        const onDrag = (e) => {
            if (!isDragging) return;
            e.preventDefault();
            
            const clientY = e.clientY || e.touches[0].clientY;
            
            const usableScreenHeight = window.innerHeight / 2;
            const usableScreenTop = window.innerHeight / 2;
            let percentage = (clientY - usableScreenTop) / usableScreenHeight;
            percentage = Math.max(0, Math.min(1, percentage));

            const targetIndex = Math.floor(percentage * (cardElementsCache.length - 1) + 0.5);

            const handleHeight = quickScrollHandle.offsetHeight;
            let handleTop = clientY - (handleHeight / 2);
            handleTop = Math.max(0, Math.min(window.innerHeight - handleHeight, handleTop));
            quickScrollHandle.style.top = `${handleTop}px`;
            quickScrollBubble.style.top = `${handleTop + (handleHeight / 2)}px`;

            if (targetIndex !== -1 && cardElementsCache[targetIndex]) {
                quickScrollBubble.textContent = cardElementsCache[targetIndex].dataset.no;

                if (targetIndex !== lastScrolledIndex) {
                    const targetPosition = cardPositionsCache[targetIndex];
                    window.scrollTo({ top: targetPosition, behavior: 'auto' });
                    
                    if (navigator.vibrate) navigator.vibrate(20); 
                    lastScrolledIndex = targetIndex;
                }
            }
        };

        const updateHandleOnScroll = () => {
            if (isDragging) return; 

            headerHeight = filterButtonsContainer.offsetTop + filterButtonsContainer.offsetHeight;
            const currentScroll = window.scrollY;
            
            cardPositionsCache = Array.from(deliveryCardsContainer.querySelectorAll('[data-no]')).map(card => card.offsetTop - headerHeight);
            if(cardPositionsCache.length === 0) return;

            let closestIndex = 0;
            for(let i=0; i<cardPositionsCache.length; i++) {
                if (cardPositionsCache[i] <= currentScroll + 1) {
                    closestIndex = i;
                } else {
                    break;
                }
            }
            
            const percentage = cardPositionsCache.length > 1 ? closestIndex / (cardPositionsCache.length - 1) : 0;
            
            const usableScreenHeight = window.innerHeight / 2;
            const usableScreenTop = window.innerHeight / 2;
            const handleHeight = quickScrollHandle.offsetHeight;

            let handleTop = usableScreenTop + (percentage * usableScreenHeight);
            handleTop = handleTop - (handleHeight / 2);
            handleTop = Math.max(0, Math.min(window.innerHeight - handleHeight, handleTop));
            
            quickScrollHandle.style.top = `${handleTop}px`;
        };

        quickScrollContainer.addEventListener('mousedown', onDragStart);
        quickScrollContainer.addEventListener('touchstart', onDragStart, { passive: false });

        window.addEventListener('mousemove', onDrag);
        window.addEventListener('touchmove', onDrag, { passive: false });
        
        window.addEventListener('mouseup', onDragEnd);
        window.addEventListener('touchend', onDragEnd);
        
        let scrollTimeout;
        window.addEventListener('scroll', () => {
             clearTimeout(scrollTimeout);
             scrollTimeout = setTimeout(updateHandleOnScroll, 100);
        });
    };

    const setupDelegatedEventListeners = () => {
        deliveryCardsContainer.addEventListener('click', (event) => {
            const button = event.target.closest('[data-action]');
            if (!button) return;
            const action = button.dataset.action;
            const itemNo = parseInt(button.dataset.no);
            const item = deliveryItems.find(i => i.no === itemNo);
            if (!item) return;
            
            switch (action) {
                case 'open-naver-map': if (!button.disabled) openNaverMap(button.dataset.address, itemNo); else showMessage('유효하지 않은 주소입니다.'); break;
                case 'identity-verification': 
                    openConfirmationModal(`HAWB ${item.hawbNo} 본인확인 처리하시겠습니까?`, () => handleStatusChange(itemNo, '완료', new Date().toLocaleString('ko-KR', dateTimeFormatOptions), '본인확인', item.receiverNameKorean)); 
                    break;
                case 'front-door-delivery': 
                    openConfirmationModal(`HAWB ${item.hawbNo} 문앞배송 처리하시겠습니까?`, () => handleStatusChange(itemNo, '완료', new Date().toLocaleString('ko-KR', dateTimeFormatOptions), '문앞배송')); 
                    break;
                case 'sign-delivery': openSignatureModal(itemNo); break;
                case 'revert-delivery': openConfirmationModal(`HAWB ${item.hawbNo} 상태를 되돌리시겠습니까?`, () => handleStatusChange(itemNo, '배송중')); break;
                case 'toggle-details': const details = document.querySelector(`[data-details-container="${itemNo}"]`); if (details) { details.style.display = details.style.display === 'none' ? '' : 'none'; button.textContent = details.style.display === 'none' ? '상세보기' : '접기'; } break;
            }
        });
        deliveryCardsContainer.addEventListener('change', (event) => {
            const checkbox = event.target.closest('[data-action="toggle-hawb-confirm"]');
            if (checkbox) handleCheckboxToggleAndResetSearch(parseInt(checkbox.dataset.no), checkbox.checked);
        });
    };

    document.addEventListener('DOMContentLoaded', () => {
        try {
            setupDelegatedEventListeners();
            setupQuickScroll();
            const storedItems = localStorage.getItem('deliveryItems');
            if (storedItems) deliveryItems = JSON.parse(storedItems).sort((a, b) => a.no - b.no);
            const storedScroll = localStorage.getItem('filterScrollPositions');
            if (storedScroll) filterScrollPositions = JSON.parse(storedScroll);
            updateFilterCounts();

            const initialBtn = filterButtonsContainer.querySelector(`[data-filter="배송준비"]`);
            if (initialBtn) {
                initialBtn.click();
            }

        } catch (error) {
            console.error("초기화 오류:", error);
            document.body.innerHTML = `<div class="p-4 text-red-500">앱 로딩 중 오류가 발생했습니다. 오류: ${error.message}</div>`;
        }
    });
</script>
</body>
</html>