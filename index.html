<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ë°°ì†¡ ì‹œíŠ¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- â–¼â–¼â–¼â–¼â–¼ ìˆ˜ì •ëœ ë¶€ë¶„: ë°”ì½”ë“œ ìŠ¤ìº” ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ â–¼â–¼â–¼â–¼â–¼ -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <!-- â–²â–²â–²â–²â–² ì—¬ê¸°ê¹Œì§€ ìˆ˜ì • â–²â–²â–²â–²â–² -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        html { scroll-behavior: smooth !important; }
        body { font-family: 'Inter', sans-serif; margin: 0; padding-bottom: 80px; overscroll-behavior-y: contain; }
        .signature-modal, .confirmation-modal, .smart-edit-modal, .number-jump-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        .signature-modal-content, .confirmation-modal-content, .smart-edit-modal-content, .number-jump-modal-content { background-color: white; border-radius: 0.5rem; box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); padding: 1.5rem; width: 100%; max-width: 32rem; max-height: 95vh; display: flex; flex-direction: column; }
        #smart-edit-scroll-area { flex-grow: 1; overflow-y: auto; margin-bottom: 1rem; }
        
        .key-button { position: relative; overflow: visible !important; -webkit-tap-highlight-color: transparent; }
        .key-pop {
            position: absolute;
            bottom: 80%;
            left: 50%;
            transform: translateX(-50%) scale(0.8);
            transform-origin: bottom center;
            background-color: #374151; /* gray-700 */
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 1.25rem;
            font-weight: 600;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s, transform 0.2s;
            z-index: 10;
            min-width: 100%;
            text-align: center;
            white-space: nowrap;
        }
        .key-button:active .key-pop {
            opacity: 1;
            transform: translateX(-50%) scale(1) translateY(-8px);
        }
        #address-pieces-container button { margin: 0.25rem; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.875rem; font-weight: 500; transition: background-color: 0.2s; }

        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); border-left-color: #2563eb; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .animate-slide-in-left { animation: slideInLeft 0.3s ease-out forwards; }
        @keyframes slideInLeft { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .animate-slide-in-right { animation: slideInRight 0.3s ease-out forwards; }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        #delivery-cards-container { transition: transform 0.1s ease-out; will-change: transform; }
        #filter-buttons-container { position: fixed; top: 0; left: 0; width: 100vw; will-change: transform, top; }
        #toast-container { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); z-index: 100; display: flex; flex-direction: column; align-items: center; gap: 8px; pointer-events: none; }
        .toast-message { background-color: rgba(0, 0, 0, 0.75); color: white; padding: 10px 20px; border-radius: 20px; font-size: 0.875rem; box-shadow: 0 2px 10px rgba(0,0,0,0.2); opacity: 0; transition: opacity 0.5s, transform 0.5s; transform: translateY(20px); }
        .toast-message.show { opacity: 1; transform: translateY(0); }
        .fab-container { position: fixed; bottom: 2rem; right: 1.5rem; z-index: 45; display: none; flex-direction: column; gap: 0.75rem; transition: opacity 0.15s ease-out; }
        .fab-container.visible { display: flex; }
        .fab-container.hidden { opacity: 0; pointer-events: none; }
        .fab-button { width: 56px; height: 56px; border-radius: 50%; background-color: #1f2937; color: white; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.2); border: none; cursor: pointer; transition: background-color 0.2s; font-size: 1.25rem; font-weight: 600; }
        .fab-button:hover { background-color: #374151; }
        .fab-button.sort-by-no { background-color: #4b5563; }
        .fab-button.sort-by-distance, .fab-button.sort-by-time { background-color: #2563eb; }
        #number-jump-list { display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.5rem; overflow-y: auto; padding: 0.5rem; margin: -0.5rem; max-height: 60vh; }
        .number-jump-item { min-width: 50px; padding: 0.75rem; border-radius: 0.5rem; font-weight: 600; text-align: center; transition: background-color 0.2s, color 0.2s; }
        .number-jump-item.active { background-color: #2563eb; color: white; cursor: pointer; }
        .number-jump-item.active:hover { background-color: #1d4ed8; }
        .number-jump-item.inactive { background-color: #f3f4f6; color: #9ca3af; cursor: not-allowed; }
        .number-jump-item.placeholder { background-color: transparent; }
        #search-bar-container { position: fixed; bottom: 0; left: 0; width: 100vw; z-index: 46; transition: transform 0.3s ease-out; background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); border-top: 1px solid #e5e7eb; }
        #search-bar-container.hidden { transform: translateY(100%); }
    </style>
</head>
<body class="min-h-screen bg-gray-100 p-4 sm:p-6 lg:p-8 font-sans">
    <div id="filter-buttons-container" class="z-20">
        <div class="max-w-md mx-auto bg-white rounded-lg shadow-lg w-full min-w-[320px] p-4">
            <div class="flex justify-around space-x-2 overflow-x-auto" style="-webkit-overflow-scrolling: touch;">
                <button data-filter="ë°°ì†¡ì¤€ë¹„" class="flex-shrink-0 px-3 py-1.5 rounded-full text-sm font-medium transition-colors duration-200 flex items-center justify-center space-x-1 whitespace-nowrap"><span>ë°°ì†¡ì¤€ë¹„</span></button>
                <button data-filter="ì „ì²´" class="flex-shrink-0 px-3 py-1.5 rounded-full text-sm font-medium transition-colors duration-200 flex items-center justify-center space-x-1 bg-transparent text-gray-700 border border-gray-300 hover:bg-gray-100 whitespace-nowrap"><span>ì „ì²´</span><span class="text-xs font-semibold px-1.5 py-0.5 rounded-full bg-gray-200 text-gray-700" id="count-ì „ì²´">0</span></button>
                <button data-filter="ë°°ì†¡ì „" class="flex-shrink-0 px-3 py-1.5 rounded-full text-sm font-medium transition-colors duration-200 flex items-center justify-center space-x-1 bg-transparent text-gray-700 border border-gray-300 hover:bg-gray-100 whitespace-nowrap"><span>ë°°ì†¡ì „</span><span class="text-xs font-semibold px-1.5 py-0.5 rounded-full bg-gray-200 text-gray-700" id="count-ë°°ì†¡ì „">0</span></button>
                <button data-filter="ë°°ì†¡ì¤‘" class="flex-shrink-0 px-3 py-1.5 rounded-full text-sm font-medium transition-colors duration-200 flex items-center justify-center space-x-1 bg-transparent text-gray-700 border border-gray-300 hover:bg-gray-100 whitespace-nowrap"><span>ë°°ì†¡ì¤‘</span><span class="text-xs font-semibold px-1.5 py-0.5 rounded-full bg-gray-200 text-gray-700" id="count-ë°°ì†¡ì¤‘">0</span></button>
                <button data-filter="ì™„ë£Œ" class="flex-shrink-0 px-3 py-1.5 rounded-full text-sm font-medium transition-colors duration-200 flex items-center justify-center space-x-1 bg-transparent text-gray-700 border border-gray-300 hover:bg-gray-100 whitespace-nowrap"><span>ì™„ë£Œ</span><span class="text-xs font-semibold px-1.5 py-0.5 rounded-full bg-gray-200 text-gray-700" id="count-ì™„ë£Œ">0</span></button>
            </div>
        </div>
    </div>

    <div id="data-management-container" class="max-w-md mx-auto mb-6 p-4 bg-white rounded-lg shadow-lg w-full min-w-[320px] space-y-4 hidden">
        <div>
            <h3 class="text-lg font-semibold text-gray-800 mb-2">ë°ì´í„° ë‚´ë³´ë‚´ê¸°/ê°€ì ¸ì˜¤ê¸°</h3>
            <div class="flex space-x-2">
                <button id="exportDataButton" class="w-1/2 px-4 py-2 bg-teal-600 text-white rounded-md hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-teal-500">ë°ì´í„° íŒŒì¼ë¡œ ì €ì¥</button>
                <label for="importDataInput" class="w-1/2 px-4 py-2 bg-sky-600 text-white rounded-md hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-sky-500 text-center cursor-pointer">íŒŒì¼ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°</label>
                <input type="file" id="importDataInput" class="hidden" accept=".json"/>
            </div>
        </div>
        <div>
            <h3 class="text-lg font-semibold text-gray-800 mb-2">ì¹´ë“œ ì´ˆê¸°í™”</h3>
            <button id="clearAllCardsButton" class="w-full px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">ëª¨ë“  ì¹´ë“œ ì‚­ì œ</button>
        </div>
    </div>

    <div id="scan-section-container" class="max-w-md mx-auto mb-6 p-4 bg-white rounded-lg shadow-lg w-full min-w-[320px] hidden">
        <h3 class="text-lg font-semibold text-gray-800 mb-3">ì†¡ì¥ ìŠ¤ìº”í•˜ì—¬ ì¹´ë“œ ìƒì„±</h3>
        <div class="flex flex-col sm:flex-row items-center space-y-3 sm:space-y-0 sm:space-x-3">
            <input type="file" id="deliverySheetImage" accept="image/*" multiple class="hidden"/>
            <label for="deliverySheetImage" class="flex-1 w-full text-sm text-blue-700 py-2 px-4 rounded-md border border-blue-300 bg-blue-50 font-semibold cursor-pointer hover:bg-blue-100 text-center whitespace-nowrap">ì‚¬ì§„ ì„ íƒ</label>
            <button id="scanAndGenerateButton" class="w-full sm:w-auto px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50">ìŠ¤ìº”í•˜ì—¬ ì¹´ë“œ ìƒì„±</button>
        </div>
        <div id="selected-files-display" class="mt-2 text-sm text-gray-600 text-center">ì„ íƒëœ íŒŒì¼ ì—†ìŒ</div>
        <div id="scan-loading-indicator" class="hidden mt-3 text-center text-sm text-blue-600">
            <div class="spinner mx-auto mb-2"></div>
            <p id="scan-progress-text">ì†¡ì¥ ìŠ¤ìº” ì¤‘...</p>
        </div>
        <div id="scan-error-message" class="hidden mt-3 text-center text-sm text-red-600">ìŠ¤ìº” ì‹¤íŒ¨: <span id="scan-error-text"></span></div>
    </div>
    
    <div id="version-info-container" class="max-w-md mx-auto mb-6 text-center hidden">
        <p id="version-text" class="text-xs text-gray-600 font-mono"></p>
        <p id="version-changelog" class="text-xs text-gray-500"></p>
    </div>

    <div id="delivery-cards-container" class="max-w-md mx-auto"></div>
    
    <div id="toast-container"></div>

    <div id="fab-container-inprogress" class="fab-container">
        <button id="fab-sort-distance" class="fab-button sort-by-distance" title="ê±°ë¦¬ìˆœ ì •ë ¬">@</button>
        <button id="fab-sort-no" class="fab-button sort-by-no" title="ìˆœë²ˆìˆœ ì •ë ¬">#</button>
        <button id="fab-jump-no" class="fab-button" title="ë²ˆí˜¸ë¡œ ì´ë™">1</button>
    </div>
    <div id="fab-container-completed" class="fab-container">
        <button id="fab-sort-time" class="fab-button sort-by-time" title="ì™„ë£Œì‹œê°„ìˆœ ì •ë ¬">æ™‚</button>
        <button id="fab-sort-no-completed" class="fab-button sort-by-no" title="ìˆœë²ˆìˆœ ì •ë ¬">1</button>
    </div>

    <div id="search-bar-container">
        <div class="max-w-md mx-auto w-full min-w-[320px] p-4">
            <label for="invoiceNumber" class="block text-sm font-medium text-gray-700 sr-only">ì†¡ì¥ë²ˆí˜¸ ê²€ìƒ‰</label>
            <!-- â–¼â–¼â–¼â–¼â–¼ ìˆ˜ì •ëœ ë¶€ë¶„: ê²€ìƒ‰ ë°” ë ˆì´ì•„ì›ƒ ë° ë²„íŠ¼ ë³€ê²½ â–¼â–¼â–¼â–¼â–¼ -->
            <div class="flex space-x-2 flex-nowrap items-center">
                <input type="tel" id="invoiceNumber" name="invoiceNumber" placeholder="ì†¡ì¥ë²ˆí˜¸ ê²€ìƒ‰ ë˜ëŠ” ìŠ¤ìº”" class="flex-grow p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" inputmode="numeric" pattern="[0-9]*"/>
                <button id="scanButton" title="ë°”ì½”ë“œ ìŠ¤ìº”" class="flex-shrink-0 w-12 h-10 bg-gray-600 text-white rounded-md hover:bg-gray-700 flex items-center justify-center text-2xl">ğŸ“·</button>
                <button id="searchButton" title="ê²€ìƒ‰" class="flex-shrink-0 w-12 h-10 bg-blue-600 text-white rounded-md hover:bg-blue-700 flex items-center justify-center text-2xl">ğŸ”</button>
                <button id="resetButton" title="ì§€ìš°ê¸°" class="flex-shrink-0 w-12 h-10 bg-red-500 text-white rounded-md hover:bg-red-600 flex items-center justify-center text-xl">âœ•</button>
            </div>
            <!-- â–²â–²â–²â–²â–² ì—¬ê¸°ê¹Œì§€ ìˆ˜ì • â–²â–²â–²â–²â–² -->
        </div>
    </div>

    <div id="number-jump-modal" class="number-jump-modal" style="display: none;">
        <div class="number-jump-modal-content">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">ë²ˆí˜¸ë¡œ ì´ë™</h2>
            <div id="number-jump-list">
                <!-- ë²ˆí˜¸ ë²„íŠ¼ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤. -->
            </div>
            <div class="flex justify-end mt-6">
                <button id="number-jump-close" class="px-4 py-2 bg-gray-400 text-white rounded-md hover:bg-gray-500 text-sm font-medium">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <div id="signature-modal" class="signature-modal" style="display: none;">
        <div class="signature-modal-content">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">ì„œëª… ì…ë ¥</h2>
            <div class="signature-input-container">
                <textarea id="signature-text-input" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" rows="3" placeholder="ì—¬ê¸°ì— ì„œëª… ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”."></textarea>
            </div>
            <div class="flex justify-end space-x-2 mt-4">
                <button id="clearSignature" class="px-4 py-2 rounded-md bg-gray-300 text-gray-800 text-sm font-medium hover:bg-gray-400">ì§€ìš°ê¸°</button>
                <button id="cancelSignature" class="px-4 py-2 rounded-md bg-red-500 text-white text-sm font-medium hover:bg-red-600">ì·¨ì†Œ</button>
                <button id="saveSignature" class="px-4 py-2 rounded-md bg-blue-600 text-white text-sm font-medium hover:bg-blue-700">ì €ì¥</button>
            </div>
        </div>
    </div>

    <div id="confirmation-modal" class="confirmation-modal" style="display: none;">
        <div class="confirmation-modal-content">
            <h2 class="text-xl font-semibold mb-4 text-gray-800" id="confirmation-modal-title">í™•ì¸</h2>
            <div id="confirmation-modal-body">
                <p class="text-base text-gray-700 mb-6" id="confirmation-modal-message"></p>
            </div>
            <div class="flex justify-between space-x-2 mt-4" id="confirmation-modal-buttons">
                <button id="confirmCancelButton" class="w-1/2 px-4 py-2 rounded-md bg-gray-300 text-gray-800 text-sm font-medium hover:bg-gray-400">ì·¨ì†Œ</button>
                <button id="confirmOkButton" class="w-1/2 px-4 py-2 rounded-md bg-blue-600 text-white text-sm font-medium hover:bg-blue-700">í™•ì¸</button>
            </div>
        </div>
    </div>

    <!-- ìŠ¤ë§ˆíŠ¸ í¸ì§‘ ëª¨ë‹¬ -->
    <div id="smart-edit-modal" class="smart-edit-modal" style="display: none;">
        <div class="smart-edit-modal-content">
            <div id="smart-edit-scroll-area">
                <div class="mb-4">
                    <h3 class="text-sm font-semibold text-gray-600 mb-1">AI ì¶”ì¶œ ì›ë³¸ (ì°¸ì¡°ìš©)</h3>
                    <p id="original-address-display" class="p-2 bg-gray-100 rounded-md text-gray-800 text-sm font-mono break-all"></p>
                </div>

                <div class="mb-2">
                    <h3 class="text-sm font-semibold text-gray-600 mb-1">ì£¼ì†Œ ì¡°ê° (í´ë¦­í•˜ì—¬ ì¶”ê°€)</h3>
                    <div id="address-pieces-container" class="flex flex-wrap p-2 bg-gray-50 rounded-md border border-gray-200 min-h-[40px]"></div>
                </div>
                
                <div id="fixed-buttons-container" class="mt-2 grid grid-cols-2 gap-4">
                    <div id="number-keypad" class="grid grid-cols-3 gap-2"></div>
                    <div id="unit-keypad" class="grid grid-cols-2 gap-2"></div>
                </div>

                <hr class="my-4 border-gray-300"/>

                <div class="mt-4">
                    <div class="flex justify-between items-center mb-2">
                         <h3 class="text-lg font-semibold text-gray-800">ì£¼ì†Œ ì¡°ê° í¸ì§‘</h3>
                         <div class="flex items-center space-x-2">
                            <button id="reset-pieces-btn" class="p-1.5 text-gray-500 hover:bg-gray-200 rounded-full">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                            </button>
                            <button id="apply-pieces-btn" class="px-4 py-1.5 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm font-medium">ìˆ˜ì • ì™„ë£Œ</button>
                         </div>
                    </div>
                    <textarea id="pieces-address-input" class="w-full p-2 border border-gray-300 rounded-md bg-gray-50 focus:ring-blue-500 focus:border-blue-500 resize-none overflow-hidden" rows="1" readonly></textarea>
                </div>
                
                <div class="mt-4">
                     <div class="flex justify-between items-center mb-2">
                         <h3 class="text-lg font-semibold text-gray-800">ì§ì ‘ ì£¼ì†Œ í¸ì§‘</h3>
                         <div class="flex items-center space-x-2">
                             <button id="revert-direct-btn" class="p-1.5 text-gray-500 hover:bg-gray-200 rounded-full">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.354 1.646a.5.5 0 010 .708L2.707 8l5.647 5.646a.5.5 0 01-.708.708l-6-6a.5.5 0 010-.708l6-6a.5.5 0 01.708 0z" clip-rule="evenodd" /><path fill-rule="evenodd" d="M12.5 8a.5.5 0 01.5-.5h5a.5.5 0 010 1h-5a.5.5 0 01-.5-.5z" clip-rule="evenodd" /></svg>
                            </button>
                            <button id="apply-direct-btn" class="px-4 py-1.5 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm font-medium">ìˆ˜ì • ì™„ë£Œ</button>
                         </div>
                    </div>
                    <textarea id="direct-address-input" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 resize-none overflow-hidden" rows="2"></textarea>
                </div>

            </div>
            <div class="flex justify-end mt-auto pt-4 border-t border-gray-200">
                <button id="smart-edit-exit" class="px-4 py-2 bg-gray-400 text-white rounded-md hover:bg-gray-500 text-sm font-medium">ë‚˜ê°€ê¸°</button>
            </div>
        </div>
    </div>

    <!-- â–¼â–¼â–¼â–¼â–¼ ì¶”ê°€ëœ ë¶€ë¶„: ì‹¤ì‹œê°„ ìŠ¤ìºë„ˆ ëª¨ë‹¬ â–¼â–¼â–¼â–¼â–¼ -->
    <div id="scanner-modal" class="fixed inset-0 bg-black z-50" style="display: none;">
        <div id="reader" class="w-full h-full"></div>
        <button id="scanner-close-button" class="absolute top-4 right-4 bg-white/70 text-black rounded-full w-10 h-10 text-2xl font-bold flex items-center justify-center hover:bg-white">Ã—</button>
    </div>
    <!-- â–²â–²â–²â–²â–² ì—¬ê¸°ê¹Œì§€ ì¶”ê°€ â–²â–²â–²â–²â–² -->

    <script type="text/javascript">
        const GEMINI_PROMPT = `Analyze the provided image containing one or more delivery invoices. Your task is to identify each distinct invoice block and extract its key information into a valid JSON array.

**CRITICAL INSTRUCTIONS:**

1.  **IDENTIFY EACH INVOICE:** Treat each logical invoice area as a separate item. An "no" is essential for each item.

2.  **EXTRACT KEY-VALUE PAIRS:** For each invoice, extract the following fields: "no", "hawbNo", "receiverAddress", "receiverPhone", "receiverCompanyName", and "receiverName".

3.  **SEPARATE COMPANY AND PERSONAL NAME:**
    *   **Scenario A (Separate Columns):** If the invoice has distinct columns like "Company Name of Receiver" and "Name of receiver", extract the text from each column into "receiverCompanyName" and "receiverName" respectively.
    *   **Scenario B (Combined Field):** If the recipient information is in a single combined field, intelligently separate the company/organization name and the personal name.
    *   **Handling Edge Cases:**
        *   If only a personal name is found, put it in "receiverName" and omit "receiverCompanyName".
        *   If only a company name is found (e.g., "ABC Mart", "(ì£¼)DEF"), put it in "receiverCompanyName" and repeat it in "receiverName".
        *   If you cannot separate them, put the entire text into both "receiverCompanyName" and "receiverName".

4.  **TRANSLATE AND SEPARATE ADDRESS:**
    *   Translate "receiverName" and "receiverCompanyName" to Korean if they are in English/Romanized Korean. Store them in "receiverNameKorean" and "receiverCompanyNameKorean". If already in Korean, just copy them.
    *   Translate "receiverAddress" to a standard Korean address format.
    *   **Separate the translated Korean address into "baseAddressKorean" and "detailAddressKorean".**
        *   "baseAddressKorean" should contain the main, searchable part of the address (e.g., "ì„œìš¸ ì†¡íŒŒêµ¬ ì–‘ì¬ëŒ€ë¡œ 1300").
        *   "detailAddressKorean" should contain the rest (e.g., "ì˜¬ë¦¼í”½íŒŒí¬í¬ë ˆì˜¨ 319ë™ 307í˜¸"). Omit if not present.

5.  **OUTPUT A JSON ARRAY:** Your entire output MUST be a single, valid JSON array of objects.

**Example Output:**
[
  {
    "no": "40",
    "hawbNo": "SF028452891 8577",
    "receiverCompanyName": "Techfiber.Co.,-Ltd",
    "receiverCompanyNameKorean": "í…Œí¬íŒŒì´ë²„",
    "receiverName": "Richard Kim",
    "receiverNameKorean": "ê¹€ë¦¬ì°¨ë“œ",
    "receiverPhone": "24080670",
    "receiverAddress": "No.601, 422-dong, yangjae-daero 1300",
    "baseAddressKorean": "ì„œìš¸ ê°•ë™êµ¬ ì–‘ì¬ëŒ€ë¡œ 1300",
    "detailAddressKorean": "422ë™ 601í˜¸"
  },
  {
    "no": "1",
    "hawbNo": "SF319999130 4534",
    "receiverCompanyName": "Jiyoung Her",
    "receiverCompanyNameKorean": "í—ˆì§€ì˜",
    "receiverName": "Jiyoung Her",
    "receiverNameKorean": "í—ˆì§€ì˜",
    "receiverPhone": "01025190714",
    "receiverAddress": "Songpagu Olympic-ro 102-408",
    "baseAddressKorean": "ì„œìš¸ ì†¡íŒŒêµ¬ ì˜¬ë¦¼í”½ë¡œ",
    "detailAddressKorean": "102-408"
  }
]
`;
        
        const KAKAO_API_KEY = '2342aad8b15d534cb60fb824f71a97f1';

        const dateTimeFormatOptions = { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };

        // --- Helper functions ---

        const setVersionInfo = () => {
            const version = "v1.0.3 - 2024-05-25";
            const changelog = "ì‹¤ì‹œê°„ ë°”ì½”ë“œ ìŠ¤ìº” ê¸°ëŠ¥ ì¶”ê°€ ë° ê²€ìƒ‰ ë°” UI ê°œì„ ";
            if (versionText) versionText.textContent = version;
            if (versionChangelog) versionChangelog.textContent = changelog;
        };

        const setupDelegatedEventListeners = () => {
            deliveryCardsContainer.addEventListener('click', (event) => {
                const target = event.target.closest('button, input[type="checkbox"], p[data-action="open-smart-edit"]');
                if (!target) return;

                const action = target.dataset.action;
                const itemNo = parseInt(target.dataset.no, 10);

                switch (action) {
                    case 'toggle-hawb-confirm':
                        handleCheckboxToggleAndResetSearch(itemNo, target.checked);
                        break;
                    case 'open-naver-map':
                        {
                            const item = deliveryItems.find(i => i.no === itemNo);
                            if (item) openNaverMap(item);
                        }
                        break;
                    case 'revert-delivery':
                        openConfirmationModal(`${itemNo}ë²ˆ í•­ëª©ì„ 'ë°°ì†¡ì „' ìƒíƒœë¡œ ë˜ëŒë¦¬ì‹œê² ìŠµë‹ˆê¹Œ?`, () => {
                            handleStatusChange(itemNo, 'ë°°ì†¡ì „');
                            showToastMessage(`${itemNo}ë²ˆ í•­ëª©ì´ ë˜ëŒë ¤ì¡ŒìŠµë‹ˆë‹¤.`);
                        });
                        break;
                    case 'identity-verification':
                        openConfirmationModal(`${itemNo}ë²ˆ í•­ëª©ì„ 'ë³¸ì¸í™•ì¸'ìœ¼ë¡œ ì™„ë£Œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, () => {
                            const currentTime = new Date().toLocaleString('ko-KR', dateTimeFormatOptions);
                            handleStatusChange(itemNo, 'ì™„ë£Œ', currentTime, 'ë³¸ì¸í™•ì¸', 'ì‹ ë¶„ì¦');
                        });
                        break;
                    case 'front-door-delivery':
                        openConfirmationModal(`${itemNo}ë²ˆ í•­ëª©ì„ 'ë¬¸ì•ë°°ì†¡'ìœ¼ë¡œ ì™„ë£Œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, () => {
                            const currentTime = new Date().toLocaleString('ko-KR', dateTimeFormatOptions);
                            handleStatusChange(itemNo, 'ì™„ë£Œ', currentTime, 'ë¬¸ì•ë°°ì†¡');
                        });
                        break;
                    case 'sign-delivery':
                        openSignatureModal(itemNo);
                        break;
                    case 'toggle-details':
                        {
                            const detailsContainer = document.querySelector(`div[data-details-container="${itemNo}"]`);
                            if (detailsContainer) {
                                const isHidden = detailsContainer.style.display === 'none';
                                detailsContainer.style.display = isHidden ? 'block' : 'none';
                                target.textContent = isHidden ? 'ìƒì„¸ ë‹«ê¸°' : 'ìƒì„¸ë³´ê¸°';
                            }
                        }
                        break;
                    case 'open-smart-edit':
                        openSmartEditModal(itemNo);
                        break;
                }
            });
        };

        const resizeImage = (file) => {
            return new Promise((resolve, reject) => {
                const MAX_WIDTH = 1920;
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        let width = img.width;
                        let height = img.height;
                        if (width > MAX_WIDTH) {
                            height = (MAX_WIDTH / width) * height;
                            width = MAX_WIDTH;
                        }
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
                        resolve({ file, data: dataUrl.split(',')[1] });
                    };
                    img.onerror = (error) => reject(error);
                };
                reader.onerror = (error) => reject(error);
                reader.readAsDataURL(file);
            });
        };

        const getCurrentLocation = (timeout = 10000) => {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    return reject(new Error('Geolocation is not supported by this browser.'));
                }
                navigator.geolocation.getCurrentPosition(
                    (position) => resolve({ lat: position.coords.latitude, lng: position.coords.longitude }),
                    (error) => reject(error),
                    { enableHighAccuracy: true, timeout, maximumAge: 0 }
                );
            });
        };

        const getCoordsFromAddress = async (address) => {
            if (!address) throw new Error("Address is empty.");
            const response = await fetch(`https://dapi.kakao.com/v2/local/search/address.json?query=${encodeURIComponent(address)}`, {
                headers: { 'Authorization': `KakaoAK ${KAKAO_API_KEY}` }
            });
            if (!response.ok) throw new Error('Kakao Geocoding API call failed');
            const data = await response.json();
            if (data.documents && data.documents.length > 0) {
                const location = data.documents[0];
                return { lat: parseFloat(location.y), lng: parseFloat(location.x) };
            }
            throw new Error("Could not find coordinates for the address.");
        };

        const calculateDistance = (pos1, pos2) => {
            if (!pos1 || !pos2) return Infinity;
            const R = 6371; // Radius of the Earth in km
            const dLat = (pos2.lat - pos1.lat) * Math.PI / 180;
            const dLon = (pos2.lng - pos1.lng) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(pos1.lat * Math.PI / 180) * Math.cos(pos2.lat * Math.PI / 180) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // Distance in km
        };

        const formatSinglePhoneNumber = (phoneNumber) => {
            if (typeof phoneNumber !== 'string' || !phoneNumber) return '';
            let cleaned = phoneNumber.replace(/\D/g, '');

            if (cleaned.startsWith('+82010')) { cleaned = '010' + cleaned.substring(6); }
            else if (cleaned.startsWith('82010')) { cleaned = '010' + cleaned.substring(5); }
            else if (cleaned.startsWith('+8210')) { cleaned = '010' + cleaned.substring(5); }
            else if (cleaned.startsWith('8210')) { cleaned = '010' + cleaned.substring(4); }
            else if (cleaned.startsWith('8201') && cleaned.length > 4 && cleaned[4] !== '0') { cleaned = '010' + cleaned.substring(4); }
            else if (cleaned.startsWith('82') && cleaned.length > 2) { cleaned = '0' + cleaned.substring(2); }
            else if (cleaned.length >= 7 && cleaned.length <= 11 && !cleaned.startsWith('0')) { cleaned = '0' + cleaned; }
            
            if (cleaned.startsWith('010') && cleaned.length === 11) return cleaned.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
            if (cleaned.startsWith('02')) {
                if (cleaned.length === 9) return cleaned.replace(/(\d{2})(\d{3})(\d{4})/, '$1-$2-$3');
                if (cleaned.length === 10) return cleaned.replace(/(\d{2})(\d{4})(\d{4})/, '$1-$2-$3');
            }
            if (cleaned.startsWith('031') && cleaned.length === 11) return cleaned.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
            if (cleaned.startsWith('070') && cleaned.length === 11) return cleaned.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
            if (cleaned.length === 10) return cleaned.replace(/(\d{3})(\d{3})(\d{4})/, '$1-$2-$3');
            if (cleaned.length === 9) return cleaned.replace(/(\d{2})(\d{3})(\d{4})/, '$1-$2-$3');
            if (cleaned.length === 8) return cleaned.replace(/(\d{4})(\d{4})/, '$1-$2');
            if (cleaned.length === 7) return cleaned.replace(/(\d{3})(\d{4})/, '$1-$2');

            return cleaned;
        };

        const formatPhoneNumberForDisplay = (phoneNumber) => {
            if (typeof phoneNumber !== 'string' || !phoneNumber) return '';
            const rangeMatch = phoneNumber.match(/^(\d+)-(\d+)$/);
            if (rangeMatch) {
                const baseNumber = rangeMatch[1];
                const suffix = rangeMatch[2];
                if (baseNumber.length >= suffix.length) {
                    const num1 = formatSinglePhoneNumber(baseNumber);
                    const num2Raw = baseNumber.substring(0, baseNumber.length - suffix.length) + suffix;
                    const num2 = formatSinglePhoneNumber(num2Raw);
                    return `${num1} / ${num2}`;
                }
            }
            return formatSinglePhoneNumber(phoneNumber.replace(/\D/g, ''));
        };

        const getCleanPhoneNumber = (phoneNumber) => {
            if (typeof phoneNumber !== 'string' || !phoneNumber) return '';
            const rangeMatch = phoneNumber.match(/^(\d+)-(\d+)$/);
            if (rangeMatch) phoneNumber = rangeMatch[1];
            
            let cleaned = phoneNumber.replace(/\D/g, '');

            if (cleaned.startsWith('+82010')) { cleaned = '010' + cleaned.substring(6); }
            else if (cleaned.startsWith('82010')) { cleaned = '010' + cleaned.substring(5); }
            else if (cleaned.startsWith('+8210')) { cleaned = '010' + cleaned.substring(5); }
            else if (cleaned.startsWith('8210')) { cleaned = '010' + cleaned.substring(4); }
            else if (cleaned.startsWith('8201') && cleaned.length > 4 && cleaned[4] !== '0') { cleaned = '010' + cleaned.substring(4); }
            else if (cleaned.startsWith('82') && cleaned.length > 2) { cleaned = '0' + cleaned.substring(2); }
            else if (cleaned.length >= 7 && cleaned.length <= 11 && !cleaned.startsWith('0')) { cleaned = '0' + cleaned; }

            return cleaned;
        };

        const formatHawbNoForDisplay = (hawbNo) => {
            if (!hawbNo || hawbNo.length < 4) return hawbNo;
            const prefix = hawbNo.substring(0, hawbNo.length - 4);
            const suffix = hawbNo.substring(hawbNo.length - 4);
            return `${prefix} ${suffix}`;
        };

        const formatCompletionTime = (dateTimeString) => {
            if (!dateTimeString) return '';
            const parts = dateTimeString.split(' ');
            if (parts.length >= 4) {
                const [hour, minute] = parts[3].split(':');
                return `${hour}:${minute}`;
            }
            return '';
        };
        
        const extractClipboardAddressPart = (item) => {
            if (!item) return '';
            const { baseAddress, detailAddress } = item;
            if (detailAddress) {
                const hyphenMatch = detailAddress.match(/\b(\d{2,4}-\d{2,4})\b/);
                if (hyphenMatch) return hyphenMatch[1];
                const dongHoMatch = detailAddress.match(/(\d+)\s*ë™\s*(\d+)\s*í˜¸/);
                if (dongHoMatch) return `${dongHoMatch[1]}-${dongHoMatch[2]}`;
            }
            return baseAddress || '';
        };

        const isValidAddressForMap = (address) => {
            return !!(address && address.trim().length > 0);
        };
        
        const validateAddressWithKakao = async (baseAddress, detailAddress) => {
            if (!baseAddress) {
                return { baseAddress: '', detailAddress: detailAddress || '' };
            }
            try {
                const response = await fetch(`https://dapi.kakao.com/v2/local/search/address.json?query=${encodeURIComponent(baseAddress)}`, {
                    headers: { 'Authorization': `KakaoAK ${KAKAO_API_KEY}` }
                });
                if (!response.ok) throw new Error('Kakao API call failed');
                const data = await response.json();
                if (data.documents && data.documents.length > 0) {
                    const doc = data.documents[0];
                    const kakaoBaseAddress = doc.road_address ? doc.road_address.address_name : doc.address.address_name;
                    return { baseAddress: kakaoBaseAddress, detailAddress: detailAddress || '' };
                }
                return { baseAddress, detailAddress: detailAddress || '' }; // ì¹´ì¹´ì˜¤ê°€ ëª»ì°¾ìœ¼ë©´ ì›ë³¸ ìœ ì§€
            } catch (error) {
                console.error('Error validating address with Kakao API:', error);
                return { baseAddress, detailAddress: detailAddress || '' }; // ì—ëŸ¬ë‚˜ë„ ì›ë³¸ ìœ ì§€
            }
        };

        // --- Global state and DOM elements ---
        let deliveryItems = [];
        let searchTerm = '';
        let activeFilter = 'ì „ì²´';
        const filterCategories = ['ë°°ì†¡ì¤€ë¹„', 'ì „ì²´', 'ë°°ì†¡ì „', 'ë°°ì†¡ì¤‘', 'ì™„ë£Œ'];
        let filterScrollPositions = {};
        let currentFileToScan = null;
        let failedFileObjects = []; 
        let currentSignatureItemNo = null;
        let onConfirmCallback = null;
        let currentEditItemNo = null; 
        let currentSortOrder = 'no'; // 'no' or 'distance' or 'time'
        let lastScrollY = 0; // For scroll direction detection
        // â–¼â–¼â–¼â–¼â–¼ ì¶”ê°€ëœ ë¶€ë¶„: ìŠ¤ìºë„ˆ ì¸ìŠ¤í„´ìŠ¤ ë³€ìˆ˜ â–¼â–¼â–¼â–¼â–¼
        let html5QrCodeScanner;
        // â–²â–²â–²â–²â–² ì—¬ê¸°ê¹Œì§€ ì¶”ê°€ â–²â–²â–²â–²â–²

        const searchBarContainer = document.getElementById('search-bar-container');
        const invoiceNumberInput = document.getElementById('invoiceNumber');
        const searchButton = document.getElementById('searchButton');
        const resetButton = document.getElementById('resetButton');
        const filterButtonsContainer = document.getElementById('filter-buttons-container');
        const deliveryCardsContainer = document.getElementById('delivery-cards-container');
        const deliverySheetImageInput = document.getElementById('deliverySheetImage');
        const scanAndGenerateButton = document.getElementById('scanAndGenerateButton');
        const scanLoadingIndicator = document.getElementById('scan-loading-indicator');
        const scanErrorMessage = document.getElementById('scan-error-message');
        const scanErrorText = document.getElementById('scan-error-text');
        const scanSectionContainer = document.getElementById('scan-section-container');
        const clearAllCardsButton = document.getElementById('clearAllCardsButton');
        const dataManagementContainer = document.getElementById('data-management-container');
        const exportDataButton = document.getElementById('exportDataButton');
        const importDataInput = document.getElementById('importDataInput');
        const scanProgressText = document.getElementById('scan-progress-text');
        const selectedFilesDisplay = document.getElementById('selected-files-display');
        
        const signatureModal = document.getElementById('signature-modal');
        const signatureTextInput = document.getElementById('signature-text-input');
        const clearSignatureBtn = document.getElementById('clearSignature');
        const cancelSignatureBtn = document.getElementById('cancelSignature');
        const saveSignatureBtn = document.getElementById('saveSignature');
        
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmationModalTitle = document.getElementById('confirmation-modal-title');
        const confirmationModalMessage = document.getElementById('confirmation-modal-message');
        const confirmationModalBody = document.getElementById('confirmation-modal-body');
        const confirmationModalButtons = document.getElementById('confirmation-modal-buttons');
        const confirmOkButton = document.getElementById('confirmOkButton');
        const confirmCancelButton = document.getElementById('confirmCancelButton');
        
        const versionInfoContainer = document.getElementById('version-info-container');
        const versionText = document.getElementById('version-text');
        const versionChangelog = document.getElementById('version-changelog');
        
        const smartEditModal = document.getElementById('smart-edit-modal');
        const originalAddressDisplay = document.getElementById('original-address-display');
        const piecesAddressInput = document.getElementById('pieces-address-input');
        const directAddressInput = document.getElementById('direct-address-input');
        const applyPiecesBtn = document.getElementById('apply-pieces-btn');
        const resetPiecesBtn = document.getElementById('reset-pieces-btn');
        const applyDirectBtn = document.getElementById('apply-direct-btn');
        const revertDirectBtn = document.getElementById('revert-direct-btn');
        const smartEditExitBtn = document.getElementById('smart-edit-exit');
        
        const toastContainer = document.getElementById('toast-container');
        const fabContainerInProgress = document.getElementById('fab-container-inprogress');
        const fabSortNo = document.getElementById('fab-sort-no');
        const fabSortDistance = document.getElementById('fab-sort-distance');
        const fabJumpNo = document.getElementById('fab-jump-no');
        const fabContainerCompleted = document.getElementById('fab-container-completed');
        const fabSortTime = document.getElementById('fab-sort-time');
        const fabSortNoCompleted = document.getElementById('fab-sort-no-completed');
        
        const numberJumpModal = document.getElementById('number-jump-modal');
        const numberJumpList = document.getElementById('number-jump-list');
        const numberJumpClose = document.getElementById('number-jump-close');

        // â–¼â–¼â–¼â–¼â–¼ ì¶”ê°€ëœ ë¶€ë¶„: ìŠ¤ìºë„ˆ ê´€ë ¨ DOM ìš”ì†Œ â–¼â–¼â–¼â–¼â–¼
        const scanButton = document.getElementById('scanButton');
        const scannerModal = document.getElementById('scanner-modal');
        const scannerCloseButton = document.getElementById('scanner-close-button');
        // â–²â–²â–²â–²â–² ì—¬ê¸°ê¹Œì§€ ì¶”ê°€ â–²â–²â–²â–²â–²

        // --- Modal & Core Logic Functions ---
        const openSignatureModal = (itemNo) => { currentSignatureItemNo = itemNo; signatureModal.style.display = 'flex'; signatureTextInput.value = ''; signatureTextInput.focus(); };
        const closeSignatureModal = () => { signatureModal.style.display = 'none'; currentSignatureItemNo = null; };
        const saveSignature = () => {
            if (currentSignatureItemNo === null) return;
            const signatureText = signatureTextInput.value.trim();
            if (signatureText === '') { showToastMessage('ì„œëª… ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
            const currentTime = new Date().toLocaleString('ko-KR', dateTimeFormatOptions);
            handleStatusChange(currentSignatureItemNo, 'ì™„ë£Œ', currentTime, 'ì„œëª…', signatureText);
            closeSignatureModal();
            showToastMessage('ì„œëª…ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        };
        
        const openConfirmationModal = (message, onOk, okText = 'í™•ì¸', cancelText = 'ì·¨ì†Œ') => {
            confirmationModalTitle.textContent = 'í™•ì¸';
            confirmationModalBody.innerHTML = `<p class="text-base text-gray-700 mb-6" id="confirmation-modal-message">${message}</p>`;
            confirmOkButton.textContent = okText;
            confirmCancelButton.textContent = cancelText;
            confirmCancelButton.style.display = '';
            confirmationModalButtons.style.display = 'flex';
            onConfirmCallback = onOk;
            confirmationModal.style.display = 'flex';
        };

        const closeConfirmationModal = () => { 
            confirmationModal.style.display = 'none'; 
            onConfirmCallback = null; 
        };

        const showMessage = (message, title = 'ì•Œë¦¼') => {
            confirmationModalTitle.textContent = title;
            confirmationModalBody.innerHTML = `<p class="text-base text-gray-700 mb-6">${message}</p>`;
            confirmCancelButton.style.display = 'none';
            confirmOkButton.textContent = 'í™•ì¸';
            confirmationModalButtons.style.display = 'flex';
            onConfirmCallback = closeConfirmationModal;
            confirmationModal.style.display = 'flex';
        };

        const showLoadingMessage = (message) => {
            confirmationModalTitle.textContent = 'ì²˜ë¦¬ ì¤‘';
            confirmationModalBody.innerHTML = `<div class="flex flex-col items-center justify-center p-4"><div class="spinner mb-4"></div><p class="text-base text-gray-700">${message}</p></div>`;
            confirmationModalButtons.style.display = 'none';
            confirmationModal.style.display = 'flex';
        };

        const showToastMessage = (message, duration = 1200) => {
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.className = 'toast-message';
            toastContainer.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('show');
            }, 10);

            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                });
            }, duration);
        };
        
        const autoResizeTextarea = (event) => {
            const textarea = event.target;
            textarea.style.height = 'auto';
            textarea.style.height = (textarea.scrollHeight) + 'px';
        };
        
        const triggerHapticFeedback = () => {
            if (navigator.vibrate) {
                navigator.vibrate(10); // 10ms ì§„ë™
            }
        };

        const openSmartEditModal = (itemNo) => {
            currentEditItemNo = itemNo;
            const item = deliveryItems.find(i => i.no === itemNo);
            if (!item) { showMessage('ì¹´ë“œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
            
            const originalFullAddress = item.baseAddress + (item.detailAddress ? `, ${item.detailAddress}` : '');
            
            originalAddressDisplay.textContent = item.receiverAddressOriginal || 'ì›ë³¸ ì£¼ì†Œ ì—†ìŒ';
            piecesAddressInput.value = '';
            directAddressInput.value = originalFullAddress;
            setTimeout(() => {
                autoResizeTextarea({target: piecesAddressInput});
                autoResizeTextarea({target: directAddressInput});
            }, 0);

            const addressPiecesContainer = document.getElementById('address-pieces-container');
            const numberKeypad = document.getElementById('number-keypad');
            const unitKeypad = document.getElementById('unit-keypad');
            [addressPiecesContainer, numberKeypad, unitKeypad].forEach(c => c.innerHTML = '');
            
            const createKeyButton = (text, colorClass, value, action = 'add') => {
                const button = document.createElement('button');
                button.className = `key-button flex-shrink-0 font-semibold m-1 text-sm rounded-md py-3 flex items-center justify-center ${colorClass}`;
                button.dataset.value = value !== undefined ? value : text;
                button.dataset.action = action;
                
                const buttonText = document.createElement('span');
                buttonText.textContent = text;
                button.appendChild(buttonText);

                const keyPop = document.createElement('span');
                keyPop.className = 'key-pop';
                keyPop.textContent = text;
                button.appendChild(keyPop);

                return button;
            };

            const basePieces = (item.baseAddress || '').split(/[\s,]+/).filter(Boolean);
            basePieces.forEach(piece => addressPiecesContainer.appendChild(createKeyButton(piece, 'bg-blue-100 text-blue-800 hover:bg-blue-200 px-3 !py-1.5 rounded-full', undefined, 'add-space')));

            if (item.detailAddress) {
                addressPiecesContainer.appendChild(createKeyButton(',', 'bg-gray-200 text-gray-800 hover:bg-gray-300 px-3 !py-1.5 rounded-full', undefined, 'add-comma'));
                const detailPieces = (item.detailAddress || '').split(/[\s,]+/).filter(Boolean);
                detailPieces.forEach(piece => addressPiecesContainer.appendChild(createKeyButton(piece, 'bg-green-100 text-green-800 hover:bg-green-200 px-3 !py-1.5 rounded-full', undefined, 'add-space')));
            }

            // Number Keypad
            ['1', '2', '3', '4', '5', '6', '7', '8', '9', ',', '0', '-'].forEach(key => {
                let action = 'add';
                let colorClass = 'bg-gray-200 hover:bg-gray-300';
                if (['1', '2', '3', '4', '5', '6', '7', '8', '9', '0'].includes(key)) {
                    colorClass = 'bg-green-100 text-green-800 hover:bg-green-200';
                }
                if (key === ',') action = 'add-comma';
                if (key === '-') action = 'add-hyphen';
                numberKeypad.appendChild(createKeyButton(key, colorClass, key, action));
            });

            // Unit Keypad
            unitKeypad.appendChild(createKeyButton('ê¸¸', 'bg-blue-100 hover:bg-blue-200', 'ê¸¸', 'add-unit'));
            unitKeypad.appendChild(createKeyButton('ë²ˆê¸¸', 'bg-blue-100 hover:bg-blue-200', 'ë²ˆê¸¸', 'add-unit'));
            unitKeypad.appendChild(createKeyButton('ë™', 'bg-blue-100 hover:bg-blue-200', 'ë™', 'add-unit'));
            unitKeypad.appendChild(createKeyButton('ë¦¬', 'bg-blue-100 hover:bg-blue-200', 'ë¦¬', 'add-unit'));
            unitKeypad.appendChild(createKeyButton('\u00A0', 'bg-gray-200 hover:bg-gray-300', ' ', 'add')); // ê³µë°±
            unitKeypad.appendChild(createKeyButton('<', 'bg-gray-400 hover:bg-gray-500 text-white', '<', 'backspace-char'));
            const backspaceWordBtn = createKeyButton('<<', 'bg-red-500 hover:bg-red-600 text-white', '<<', 'backspace-word');
            backspaceWordBtn.classList.add('col-span-2');
            unitKeypad.appendChild(backspaceWordBtn);

            smartEditModal.style.display = 'flex';
            history.pushState({ smartEditModalOpen: true }, "");
        };

        const closeSmartEditModal = () => {
            if (history.state && history.state.smartEditModalOpen) {
                history.back();
            }
            smartEditModal.style.display = 'none';
            currentEditItemNo = null;
        };
        
        smartEditModal.addEventListener('click', (event) => {
            const button = event.target.closest('.key-button');
            if (!button) return;

            triggerHapticFeedback();

            const action = button.dataset.action;
            const value = button.dataset.value;
            const input = piecesAddressInput;
            let currentValue = input.value;
            
            switch (action) {
                case 'add':
                    input.value += value;
                    break;
                case 'add-space':
                    input.value += (currentValue.length > 0 && !/\s$/.test(currentValue) ? ' ' : '') + value;
                    break;
                case 'add-unit':
                    input.value += value + ' ';
                    break;
                case 'add-comma':
                    input.value += (currentValue.length > 0 && !/\s$/.test(currentValue) ? '' : '') + ', ';
                    break;
                case 'add-hyphen':
                    input.value += '-';
                    break;
                case 'backspace-char':
                    input.value = currentValue.slice(0, -1);
                    break;
                case 'backspace-word':
                    const lastSpaceIndex = currentValue.trimEnd().lastIndexOf(' ');
                    if (lastSpaceIndex > -1) {
                        input.value = currentValue.substring(0, lastSpaceIndex).trimEnd();
                    } else {
                        input.value = '';
                    }
                    break;
            }
            autoResizeTextarea({ target: input });
        });

        const applyAddressEdit = (fullAddress) => {
             if (currentEditItemNo === null) return;
            const itemIndex = deliveryItems.findIndex(item => item.no === currentEditItemNo);
            if (itemIndex > -1) {
                const commaIndex = fullAddress.indexOf(',');
                if (commaIndex > -1) {
                    deliveryItems[itemIndex].baseAddress = fullAddress.substring(0, commaIndex).trim();
                    deliveryItems[itemIndex].detailAddress = fullAddress.substring(commaIndex + 1).trim();
                } else {
                    deliveryItems[itemIndex].baseAddress = fullAddress;
                    deliveryItems[itemIndex].detailAddress = '';
                }
                deliveryItems[itemIndex].addressLocation = null;
                saveDeliveryItemsToLocalStorage();
                renderDeliveryCards(activeFilter); 
                showToastMessage('ì£¼ì†Œê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
                closeSmartEditModal();
            }
        };
        
        applyPiecesBtn.addEventListener('click', () => applyAddressEdit(piecesAddressInput.value.trim()));
        applyDirectBtn.addEventListener('click', () => applyAddressEdit(directAddressInput.value.trim()));
        
        resetPiecesBtn.addEventListener('click', () => {
            piecesAddressInput.value = '';
            autoResizeTextarea({target: piecesAddressInput});
        });
        
        revertDirectBtn.addEventListener('click', () => {
            const item = deliveryItems.find(i => i.no === currentEditItemNo);
            if(item) {
                directAddressInput.value = item.baseAddress + (item.detailAddress ? `, ${item.detailAddress}` : '');
                autoResizeTextarea({target: directAddressInput});
            }
        });
        
        smartEditExitBtn.addEventListener('click', closeSmartEditModal);

        piecesAddressInput.addEventListener('input', autoResizeTextarea);
        directAddressInput.addEventListener('input', autoResizeTextarea);
        
        confirmOkButton.addEventListener('click', () => { if (onConfirmCallback) onConfirmCallback(); closeConfirmationModal(); });
        confirmCancelButton.addEventListener('click', closeConfirmationModal);
        clearSignatureBtn.addEventListener('click', () => signatureTextInput.value = '');
        cancelSignatureBtn.addEventListener('click', closeSignatureModal);
        saveSignatureBtn.addEventListener('click', saveSignature);

        const saveDeliveryItemsToLocalStorage = () => {
            localStorage.setItem('deliveryItems', JSON.stringify(deliveryItems));
            localStorage.setItem('filterScrollPositions', JSON.stringify(filterScrollPositions));
        };
        const handleStatusChange = (itemNo, newStatus, completionTime = null, completionType = null, completionDetail = null) => {
            deliveryItems = deliveryItems.map(item => item.no === itemNo ? { ...item, status: newStatus, deliveryCompletionTime: completionTime, completionType, completionDetail, isHawbConfirmed: newStatus !== 'ë°°ì†¡ì „' } : item);
            saveDeliveryItemsToLocalStorage();
            renderDeliveryCards(activeFilter);
            updateFilterCounts();
        };

        const handleCheckboxToggleAndResetSearch = async (itemNo, newCheckboxState) => {
            const checkbox = document.querySelector(`input[data-action="toggle-hawb-confirm"][data-no="${itemNo}"]`);
            if (!checkbox) return;

            const itemIndex = deliveryItems.findIndex(item => item.no === itemNo);
            if (itemIndex === -1) return;

            if (newCheckboxState) { // ì²´í¬ë°•ìŠ¤ë¥¼ ì¼¤ ë•Œ (ì²´í¬ì¸)
                checkbox.disabled = true;
                
                if (deliveryItems[itemIndex].addressLocation) {
                    showToastMessage('ì´ë¯¸ ì¢Œí‘œê°€ ì €ì¥ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
                } else {
                    showLoadingMessage('ì£¼ì†Œ ì¢Œí‘œ í™•ì¸ ì¤‘...');
                    try {
                        const coords = await getCoordsFromAddress(deliveryItems[itemIndex].baseAddress);
                        deliveryItems[itemIndex].addressLocation = coords;
                        closeConfirmationModal();
                        showToastMessage('ì£¼ì†Œ ì¢Œí‘œ ì €ì¥ ì™„ë£Œ!');
                    } catch (error) {
                        console.error("ì²´í¬ì¸ ì‹¤íŒ¨ (ì£¼ì†Œ ì¢Œí‘œ íšë“ ì˜¤ë¥˜):", error.message);
                        closeConfirmationModal();
                        showMessage(`ì£¼ì†Œ ì¢Œí‘œë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${error.message}\nì£¼ì†Œë¥¼ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.`, 'ì˜¤ë¥˜');
                        checkbox.checked = false;
                        checkbox.disabled = false;
                        return;
                    }
                }

                deliveryItems[itemIndex].isHawbConfirmed = true;
                deliveryItems[itemIndex].status = 'ë°°ì†¡ì¤‘';
                
                saveDeliveryItemsToLocalStorage();
                searchTerm = '';
                invoiceNumberInput.value = '';
                renderDeliveryCards(activeFilter);
                updateFilterCounts();
                checkbox.disabled = false;

            } else { // ì²´í¬ë°•ìŠ¤ë¥¼ ëŒ ë•Œ (ì²´í¬ì¸ ì·¨ì†Œ)
                deliveryItems[itemIndex].isHawbConfirmed = false;
                deliveryItems[itemIndex].status = 'ë°°ì†¡ì „';
                
                saveDeliveryItemsToLocalStorage();
                searchTerm = '';
                invoiceNumberInput.value = '';
                renderDeliveryCards(activeFilter);
                updateFilterCounts();
                showToastMessage('ì²´í¬ì¸ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
        };
        
        const openNaverMap = (item) => {
            const addressForMapSearch = item.baseAddress || '';
            const textToCopy = `${item.no}. ${extractClipboardAddressPart(item)}`;
            const textarea = document.createElement('textarea');
            textarea.value = textToCopy;
            textarea.style.position = 'fixed';
            textarea.style.opacity = 0;
            document.body.appendChild(textarea);
            textarea.focus();
            textarea.select();
            try { document.execCommand('copy'); }
            catch (err) { console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', err); showMessage('í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'ë³µì‚¬ ì‹¤íŒ¨'); }
            document.body.removeChild(textarea);
            window.location.href = `nmap://search?query=${encodeURIComponent(addressForMapSearch)}&appname=DeliveryApp`;
        };

        const highlightHawbNo = (hawbNo, term) => {
            if (!hawbNo) return '';
            const formattedHawbNo = formatHawbNoForDisplay(hawbNo);
            if (!term || !formattedHawbNo.toLowerCase().includes(term.toLowerCase())) return formattedHawbNo;
            const escapedTerm = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const regex = new RegExp(`(${escapedTerm})`, 'gi');
            return formattedHawbNo.replace(regex, `<span class="bg-yellow-200 rounded px-0.5">$1</span>`);
        };
        
        // --- Render function ---
        const renderDeliveryCards = (currentFilter, animationClass = '') => {
            if (currentFilter === 'ë°°ì†¡ì¤€ë¹„') { deliveryCardsContainer.innerHTML = ''; return; }

            let dataToRender = [];
            if (searchTerm) {
                const cleanedSearchTerm = searchTerm.trim().toLowerCase();
                dataToRender = deliveryItems.filter(item => item.hawbNo?.toLowerCase().includes(cleanedSearchTerm));
            } else if (currentFilter !== 'ì „ì²´') {
                dataToRender = deliveryItems.filter(item => item.status === currentFilter);
            } else {
                dataToRender = [...deliveryItems];
            }
            
            if (dataToRender.length === 0) {
                deliveryCardsContainer.innerHTML = '<p class="text-center text-gray-600 px-4">í•´ë‹¹í•˜ëŠ” í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            deliveryCardsContainer.innerHTML = dataToRender.map(data => {
                const isAllFilter = currentFilter === 'ì „ì²´';

                const fullAddress = data.baseAddress + (data.detailAddress ? `, ${data.detailAddress}` : '');
                const isMapButtonActive = isValidAddressForMap(data.baseAddress);
                const showMapButton = ['ì „ì²´', 'ë°°ì†¡ì „'].includes(currentFilter);

                const distanceInfo = (currentSortOrder === 'distance' && data.distanceFromMe !== undefined)
                    ? `<span class="block text-sm font-medium text-purple-600 -mt-1">(${data.distanceFromMe.toFixed(2)} km)</span>`
                    : '';
                
                const mapButtonHtml = showMapButton ? `
                    <button data-action="open-naver-map" data-no="${data.no}" class="${isMapButtonActive ? 'ml-2 px-3 py-1.5 rounded-full bg-green-500 text-white text-sm font-medium hover:bg-green-600' : 'ml-2 px-3 py-1.5 rounded-full bg-gray-300 text-gray-500 text-sm font-medium cursor-not-allowed opacity-50'}" ${isMapButtonActive ? '' : 'disabled'}>ì§€ë„ë³´ê¸°</button>
                ` : '';

                const cardBg = isAllFilter ? 'bg-white' : (data.status === 'ë°°ì†¡ì¤‘' ? 'bg-blue-100' : (data.status === 'ì™„ë£Œ' ? 'bg-gray-200' : 'bg-white'));
                const showCompletedHeader = !isAllFilter && data.status === 'ì™„ë£Œ';
                const detailsHidden = !isAllFilter && data.status === 'ì™„ë£Œ';
                const showInProgressButtons = !isAllFilter && data.status === 'ë°°ì†¡ì¤‘';
                const showToggleDetailsButton = !isAllFilter && data.status === 'ì™„ë£Œ';

                return `
                    <div class="${cardBg} rounded-lg shadow-lg p-6 mb-4 border border-gray-200" data-no="${data.no}">
                        <div class="flex justify-between items-start mb-4 pb-2 border-b border-gray-200">
                            ${!showCompletedHeader ? `
                                <div class="flex justify-between items-start w-full">
                                    <div class="flex items-start space-x-4">
                                        <div>
                                            <h3 class="text-3xl font-semibold text-red-500">${data.no}</h3>
                                            ${distanceInfo}
                                        </div>
                                        <div class="pt-1.5">
                                            <span class="text-base font-bold text-gray-600 whitespace-nowrap">${highlightHawbNo(data.hawbNo, searchTerm)}</span>
                                        </div>
                                    </div>
                                    <div class="pt-1.5">
                                        <input type="checkbox" data-action="toggle-hawb-confirm" data-no="${data.no}" ${data.isHawbConfirmed ? 'checked' : ''} class="form-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded ml-2"/>
                                    </div>
                                </div>
                            ` : `
                                <div class="text-xl font-semibold text-gray-700 text-left w-full">
                                    <span class="text-red-500 text-2xl mr-8">${data.no}</span>
                                    ${data.completionType === 'ì„œëª…' && data.completionDetail ? `<span class="text-lg font-semibold text-gray-800 p-1 border border-dashed border-gray-400 rounded-md bg-gray-50 inline-block">${data.completionDetail}</span>` : data.completionType === 'ë³¸ì¸í™•ì¸' ? `${data.completionType} (${data.completionDetail})` : `${data.completionType || ''}`}
                                    <span class="ml-4">${formatCompletionTime(data.deliveryCompletionTime)}</span>
                                </div>
                            `}
                        </div>
                        <div class="space-y-3" data-details-container="${data.no}" ${detailsHidden ? 'style="display:none;"' : ''}>
                            <div><p class="text-sm font-medium text-gray-700">ì£¼ì†Œ:</p><div class="flex items-center justify-between">
                                <p class="text-base text-blue-600 font-semibold cursor-pointer" data-action="open-smart-edit" data-no="${data.no}">${fullAddress}</p>
                                ${mapButtonHtml}
                            </div>${data.receiverAddressOriginal ? `<p class="text-xs text-gray-500 ml-1">(${data.receiverAddressOriginal})</p>` : ''}</div>
                            <div><p class="text-sm font-medium text-gray-700">íšŒì‚¬ëª…:</p><p class="text-base text-blue-600 font-semibold">${data.companyNameKorean || 'N/A'}</p>${data.companyNameOriginal && data.companyNameOriginal !== data.companyNameKorean ? `<p class="text-xs text-gray-500 ml-1">(${data.companyNameOriginal})</p>` : ''}</div>
                            <div><p class="text-sm font-medium text-gray-700">ì´ë¦„:</p><p class="text-base text-blue-600 font-semibold">${data.receiverNameKorean || 'N/A'}</p>${data.receiverNameOriginal && data.receiverNameOriginal !== data.receiverNameKorean ? `<p class="text-xs text-gray-500 ml-1">(${data.receiverNameOriginal})</p>` : ''}</div>
                            <div><p class="text-sm font-medium text-gray-700">ì „í™”ë²ˆí˜¸:</p><div class="flex items-center space-x-2"><span class="text-base text-blue-600 font-semibold">${formatPhoneNumberForDisplay(data.receiverTelephoneNo)}</span><a href="tel:${getCleanPhoneNumber(data.receiverTelephoneNo)}" class="px-3 py-1.5 rounded-full bg-transparent text-orange-500 border border-orange-500 text-sm font-medium hover:bg-orange-100">ì „í™”</a><a href="sms:${getCleanPhoneNumber(data.receiverTelephoneNo)}" class="px-3 py-1.5 rounded-full bg-transparent text-blue-500 border border-blue-500 text-sm font-medium hover:bg-blue-100">ë¬¸ì</a></div></div>
                            ${data.status === 'ì™„ë£Œ' ? `<div class="mt-4 pt-4 border-t border-gray-200 flex justify-center"><button data-action="revert-delivery" data-no="${data.no}" class="px-4 py-2 rounded-md bg-red-500 text-white text-sm font-medium">ë˜ëŒë¦¬ê¸°</button></div>` : ''}
                        </div>
                        ${showInProgressButtons ? `<div class="mt-4 pt-4 border-t border-gray-200 flex justify-start space-x-2 w-10/12"><button data-action="identity-verification" data-no="${data.no}" class="flex-1 px-3 py-1.5 rounded-md bg-green-600 text-white text-sm font-medium">ë³¸ì¸í™•ì¸</button><button data-action="front-door-delivery" data-no="${data.no}" class="flex-1 px-3 py-1.5 rounded-md bg-purple-600 text-white text-sm font-medium">ë¬¸ì•ë°°ì†¡</button><button data-action="sign-delivery" data-no="${data.no}" class="flex-1 px-3 py-1.5 rounded-md bg-indigo-600 text-white text-sm font-medium">ì„œëª…</button></div>` : ''}
                        ${showToggleDetailsButton ? `<div class="pt-4 flex flex-col items-center"><button data-action="toggle-details" data-no="${data.no}" class="px-4 py-2 rounded-md bg-gray-300 text-gray-800 text-sm font-medium">ìƒì„¸ë³´ê¸°</button></div>` : ''}
                </div>
            `;
        }).join('');
        
        if (animationClass) {
            deliveryCardsContainer.style.transform = 'translateX(0px)';
            deliveryCardsContainer.classList.add(animationClass);
            setTimeout(() => { deliveryCardsContainer.classList.remove(animationClass); animation = ''; }, 300);
        }
    };

    // --- UI Update & Event Listener Setup ---
    const updateFilterCounts = () => {
        document.getElementById('count-ì „ì²´').textContent = deliveryItems.length;
        document.getElementById('count-ë°°ì†¡ì „').textContent = deliveryItems.filter(item => item.status === 'ë°°ì†¡ì „').length;
        document.getElementById('count-ë°°ì†¡ì¤‘').textContent = deliveryItems.filter(item => item.status === 'ë°°ì†¡ì¤‘').length;
        document.getElementById('count-ì™„ë£Œ').textContent = deliveryItems.filter(item => item.status === 'ì™„ë£Œ').length;
    };
    
    const updateStickyHeaderPositions = () => {
        requestAnimationFrame(() => {
            const topOffset = filterButtonsContainer.offsetHeight;
            document.body.style.paddingTop = `${topOffset}px`;

            const isScanVisible = activeFilter === 'ë°°ì†¡ì¤€ë¹„';
            scanSectionContainer.classList.toggle('hidden', !isScanVisible);
            dataManagementContainer.classList.toggle('hidden', !isScanVisible);
            versionInfoContainer.classList.toggle('hidden', !isScanVisible); 

            const inProgressCount = deliveryItems.filter(item => item.status === 'ë°°ì†¡ì¤‘').length;
            fabContainerInProgress.classList.toggle('visible', activeFilter === 'ë°°ì†¡ì¤‘' && inProgressCount > 0);
            
            const completedCount = deliveryItems.filter(item => item.status === 'ì™„ë£Œ').length;
            fabContainerCompleted.classList.toggle('visible', activeFilter === 'ì™„ë£Œ' && completedCount > 0);

            const isSearchVisible = ['ì „ì²´', 'ë°°ì†¡ì „'].includes(activeFilter);
            searchBarContainer.style.display = isSearchVisible ? 'block' : 'none';
            if (isSearchVisible) {
                searchBarContainer.classList.remove('hidden');
            } else {
                searchBarContainer.classList.add('hidden');
            }
        });
    };
    
    filterButtonsContainer.addEventListener('click', (event) => {
        const button = event.target.closest('button[data-filter]');
        if (!button || button.dataset.filter === activeFilter) return;

        filterScrollPositions[activeFilter] = window.scrollY;
        activeFilter = button.dataset.filter;

        filterButtonsContainer.querySelectorAll('button').forEach(btn => {
            const isActive = btn.dataset.filter === activeFilter;
            btn.classList.remove('bg-blue-500', 'text-white', 'shadow', 'bg-transparent', 'text-gray-700', 'border', 'border-gray-300', 'hover:bg-gray-100');
            if (isActive) {
                btn.classList.add('bg-blue-500', 'text-white', 'shadow');
            } else {
                btn.classList.add('bg-transparent', 'text-gray-700', 'border', 'border-gray-300', 'hover:bg-gray-100');
            }
        });
        
        if (activeFilter === 'ë°°ì†¡ì¤‘' || activeFilter === 'ì™„ë£Œ' || activeFilter === 'ì „ì²´') {
            currentSortOrder = 'no';
            deliveryItems.sort((a, b) => a.no - b.no);
        }

        renderDeliveryCards(activeFilter);
        updateStickyHeaderPositions();
        button.scrollIntoView({ behavior: 'smooth', inline: 'center' });
        setTimeout(() => window.scrollTo({ top: filterScrollPositions[activeFilter] || 0, behavior: 'auto' }), 0);
    });

    searchButton.addEventListener('click', () => { searchTerm = invoiceNumberInput.value.trim(); renderDeliveryCards(activeFilter); window.scrollTo({ top: 0, behavior: 'auto' }); filterScrollPositions[activeFilter] = 0; });
    resetButton.addEventListener('click', () => { filterScrollPositions[activeFilter] = window.scrollY; searchTerm = ''; invoiceNumberInput.value = ''; renderDeliveryCards(activeFilter); setTimeout(() => window.scrollTo({ top: filterScrollPositions[activeFilter] || 0, behavior: 'auto' }), 0); });
    invoiceNumberInput.addEventListener('input', (event) => { searchTerm = event.target.value.trim(); renderDeliveryCards(activeFilter); window.scrollTo({ top: 0, behavior: 'auto' }); filterScrollPositions[activeFilter] = 0; });

    deliverySheetImageInput.addEventListener('change', (event) => {
        currentFileToScan = event.target.files;
        selectedFilesDisplay.textContent = currentFileToScan.length > 0 ? `ì„ íƒëœ íŒŒì¼: ${Array.from(currentFileToScan).map(f => f.name).join(', ')}` : 'ì„ íƒëœ íŒŒì¼ ì—†ìŒ';
    });
    
    clearAllCardsButton.addEventListener('click', () => {
        openConfirmationModal("ëª¨ë“  ì¹´ë“œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", () => {
            deliveryItems = [];
            saveDeliveryItemsToLocalStorage();
            renderDeliveryCards(activeFilter);
            updateFilterCounts();
            showToastMessage("ëª¨ë“  ì¹´ë“œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        });
    });

    async function performScan(filesToScan) {
        const CONCURRENT_LIMIT = 4;
        const totalFiles = filesToScan.length;
        let completedCount = 0;

        scanProgressText.textContent = `ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì§• ì¤‘ (0/${totalFiles})...`;
        const resizePromises = filesToScan.map((file, index) => 
            resizeImage(file).then(resizedObject => {
                scanProgressText.textContent = `ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì§• ì¤‘ (${index + 1}/${totalFiles})...`;
                return resizedObject;
            })
        );
        const resizedImageObjects = await Promise.all(resizePromises);
        scanProgressText.textContent = `ë¦¬ì‚¬ì´ì§• ì™„ë£Œ, API ìš”ì²­ ì‹œì‘...`;
        
        const tempMergedResults = new Map();
        const failedFileObjectsForRetry = [];
        const requestQueue = [...resizedImageObjects]; 

        const updateApiProgress = () => {
            completedCount++;
            scanProgressText.textContent = `API ì²˜ë¦¬ ì¤‘ (${completedCount}/${totalFiles})...`;
        };

        const processApiRequest = async (resizedObject) => {
            const { file, data: base64ImageData } = resizedObject;
            let lastError = null;

            for (let attempt = 1; attempt <= 3; attempt++) {
                try {
                    const payload = {
                        contents: [{ role: "user", parts: [{ text: GEMINI_PROMPT }, { inlineData: { mimeType: 'image/jpeg', data: base64ImageData } }] }],
                        generationConfig: { temperature: 0, responseMimeType: "application/json" }
                    };
                    const tempApiKeyForLocalTest = "AIzaSyCNYPhrVzBC-wQoZU3ftYEznfUZv3vZEFs";
                    const directApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${tempApiKeyForLocalTest}`;

                    const response = await fetch(directApiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) { throw new Error(`API ìš”ì²­ ì‹¤íŒ¨ (ìƒíƒœ: ${response.status})`); }
                    
                    const result = await response.json();

                    if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                        const parsedData = JSON.parse(result.candidates[0].content.parts[0].text);
                        if (Array.isArray(parsedData) && parsedData.length > 0) {
                             return parsedData;
                        }
                    }
                    throw new Error("AIê°€ ìœ íš¨í•œ ë°°ì—´ í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                } catch (error) {
                    lastError = error;
                    console.warn(`íŒŒì¼(${file.name}) ì²˜ë¦¬ ì‹œë„ ${attempt} ì‹¤íŒ¨:`, error);
                    if (attempt < 3) {
                        await new Promise(resolve => setTimeout(resolve, 200));
                    }
                }
            }
            throw lastError;
        };
        
        const worker = async () => {
            while (requestQueue.length > 0) {
                const requestObject = requestQueue.shift(); 
                if (requestObject) {
                    try {
                        const apiResultArray = await processApiRequest(requestObject);
                        for (const geminiItem of apiResultArray) {
                            const no = parseInt(geminiItem.no || '0', 10);
                            if (no === 0) continue;
                            
                            const { baseAddress, detailAddress } = await validateAddressWithKakao(geminiItem.baseAddressKorean, geminiItem.detailAddressKorean);
                            geminiItem.baseAddressKorean = baseAddress;
                            geminiItem.detailAddressKorean = detailAddress;

                            tempMergedResults.set(no, geminiItem);
                        }
                    } catch (error) {
                        console.error(`íŒŒì¼ ìŠ¤ìº” ì˜¤ë¥˜ (${requestObject.file.name}):`, error);
                        failedFileObjectsForRetry.push(requestObject.file);
                    } finally {
                        updateApiProgress();
                    }
                }
            }
        };

        const workerPromises = Array.from({ length: CONCURRENT_LIMIT }, () => worker());
        await Promise.all(workerPromises);

        let newCount = 0;
        let updateCount = 0;
        const allNewItems = Array.from(tempMergedResults.values()); 

        if (allNewItems.length > 0) {
            const finalItems = allNewItems.map(item => ({
                no: parseInt(item.no, 10),
                hawbNo: item.hawbNo || '',
                baseAddress: item.baseAddressKorean || '',
                detailAddress: item.detailAddressKorean || '',
                receiverAddressOriginal: item.receiverAddress || '',
                companyNameOriginal: item.receiverCompanyName || '',
                receiverNameOriginal: item.receiverName || '',
                companyNameKorean: item.receiverCompanyNameKorean || item.receiverCompanyName || '',
                receiverNameKorean: item.receiverNameKorean || item.receiverName || '',
                receiverTelephoneNo: item.receiverPhone ? getCleanPhoneNumber(item.receiverPhone) : '',
                status: 'ë°°ì†¡ì „', isHawbConfirmed: false,
                deliveryCompletionTime: null, completionType: null, completionDetail: null,
                addressLocation: null
            }));
            
            finalItems.forEach(newItem => {
                const existingItemIndex = deliveryItems.findIndex(item => item.no === newItem.no);
                if (existingItemIndex > -1) {
                    deliveryItems[existingItemIndex] = { ...deliveryItems[existingItemIndex], ...newItem };
                    updateCount++;
                } else {
                    deliveryItems.push(newItem);
                    newCount++;
                }
            });
            deliveryItems.sort((a, b) => a.no - b.no);
            saveDeliveryItemsToLocalStorage();
        }
        return { newCount, updateCount, failedFiles: failedFileObjectsForRetry };
    }
    
    scanAndGenerateButton.addEventListener('click', async () => {
        if (!currentFileToScan || currentFileToScan.length === 0) { showMessage('ìŠ¤ìº”í•  ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
        
        const startTime = Date.now();
        scanLoadingIndicator.style.display = 'block';
        scanErrorMessage.style.display = 'none';
        failedFileObjects = []; 

        try {
            const initialFiles = Array.from(currentFileToScan);
            const result = await performScan(initialFiles);
            const endTime = Date.now();
            const elapsedTime = Math.round((endTime - startTime) / 1000);
            const minutes = Math.floor(elapsedTime / 60);
            const seconds = elapsedTime % 60;
            const timeString = `(ì†Œìš” ì‹œê°„: ${minutes}ë¶„ ${seconds}ì´ˆ)`;

            if (result.failedFiles.length === 0) {
                showMessage(`${result.updateCount}ê°œì˜ ì¹´ë“œê°€ ì—…ë°ì´íŠ¸ë˜ê³  ${result.newCount}ê°œì˜ ì¹´ë“œê°€ ìƒˆë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ${timeString}`);
            } else {
                failedFileObjects = result.failedFiles;
                const successCount = initialFiles.length - failedFileObjects.length;
                const failedFileNames = failedFileObjects.map(f => f.name);
                
                const message = `ì´ ${initialFiles.length}ê°œ ì¤‘ ${successCount}ê°œ íŒŒì¼ ìŠ¤ìº” ì„±ê³µ. ${timeString}\n\nì‹¤íŒ¨í•œ ${failedFileObjects.length}ê°œ íŒŒì¼ì„ ë‹¤ì‹œ ìŠ¤ìº”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n- ${failedFileNames.join('\n- ')}`;

                const onRetry = async () => {
                    scanLoadingIndicator.style.display = 'block';
                    
                    const retryResult = await performScan(failedFileObjects);

                    scanLoadingIndicator.style.display = 'none';

                    if (retryResult.failedFiles.length === 0) {
                        showMessage(`ì¬ì‹œë„ ì„±ê³µ: ${retryResult.updateCount + retryResult.newCount}ê°œì˜ ì¹´ë“œê°€ ì¶”ê°€/ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    } else {
                        const stillFailingNames = retryResult.failedFiles.map(f => f.name);
                        showMessage(`ì¬ì‹œë„ í›„ì—ë„ ì•„ë˜ ${stillFailingNames.length}ê°œ íŒŒì¼ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n- ${stillFailingNames.join('\n- ')}`, 'ì¬ì‹œë„ ì¼ë¶€ ì‹¤íŒ¨');
                    }
                    renderDeliveryCards(activeFilter);
                    updateFilterCounts();
                };
                openConfirmationModal(message, onRetry, 'ì‹¤íŒ¨ íŒŒì¼ ì¬ì‹œë„', 'ë‚˜ì¤‘ì—');
            }
        } catch (error) {
            console.error("ì „ì²´ ìŠ¤ìº” í”„ë¡œì„¸ìŠ¤ ì˜¤ë¥˜:", error);
            scanErrorText.textContent = error.message;
            scanErrorMessage.style.display = 'block';
        } finally {
            scanLoadingIndicator.style.display = 'none';
            deliverySheetImageInput.value = '';
            currentFileToScan = null;
            selectedFilesDisplay.textContent = 'ì„ íƒëœ íŒŒì¼ ì—†ìŒ';
            renderDeliveryCards(activeFilter);
            updateFilterCounts();
            updateStickyHeaderPositions();
        }
    });
    
    exportDataButton.addEventListener('click', () => {
        if (deliveryItems.length === 0) { showMessage("ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }
        try {
            const today = new Date();
            const formattedDate = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            const fileName = `SF-${formattedDate}.json`;
            const dataStr = JSON.stringify(deliveryItems, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToastMessage(`ë°ì´í„°ê°€ '${fileName}' íŒŒì¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        } catch (error) {
            showMessage(`ë°ì´í„° ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`, "ì˜¤ë¥˜");
        }
    });

    importDataInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;

        openConfirmationModal( `'${file.name}' íŒŒì¼ì˜ ë°ì´í„°ë¡œ í˜„ì¬ ëª©ë¡ì„ ëª¨ë‘ ë®ì–´ì”ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, () => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (!Array.isArray(importedData)) throw new Error("íŒŒì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤ (ë°°ì—´ì´ ì•„ë‹˜).");
                        
                        const firstItem = importedData[0];
                        if (importedData.length > 0 && typeof firstItem.no === 'undefined' && typeof firstItem.baseAddress === 'undefined') {
                           throw new Error("íŒŒì¼ ë‚´ìš©ì´ ì˜¬ë°”ë¥¸ ë°°ì†¡ ë°ì´í„° í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.");
                        }
                        
                        deliveryItems = importedData;

                        saveDeliveryItemsToLocalStorage();
                        updateFilterCounts();
                        updateStickyHeaderPositions();
                        renderDeliveryCards(activeFilter);
                        showMessage(`'${file.name}' íŒŒì¼ì—ì„œ ${deliveryItems.length}ê°œì˜ í•­ëª©ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
                    } catch (error) {
                        showMessage(`íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`, "ì˜¤ë¥˜");
                    } finally {
                        importDataInput.value = '';
                    }
                };
                reader.onerror = () => { showMessage("íŒŒì¼ì„ ì½ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", "ì˜¤ë¥˜"); importDataInput.value = ''; };
                reader.readAsText(file);
            }
        );
    });

    // â–¼â–¼â–¼â–¼â–¼ ì¶”ê°€ëœ ë¶€ë¶„: ìŠ¤ìºë„ˆ ì œì–´ í•¨ìˆ˜ â–¼â–¼â–¼â–¼â–¼
    const startScanner = () => {
        scannerModal.style.display = 'block';
        html5QrCodeScanner = new Html5Qrcode("reader");
        
        const config = { fps: 10, qrbox: { width: 280, height: 100 } };

        const onScanSuccess = (decodedText, decodedResult) => {
            stopScanner();
            invoiceNumberInput.value = decodedText;
            searchButton.click();
            showToastMessage(`ìŠ¤ìº” ì„±ê³µ: ${decodedText}`);
            triggerHapticFeedback();
        };

        const onScanFailure = (error) => {
            // ìŠ¤ìº” ì‹¤íŒ¨ëŠ” ë¬´ì‹œ (ê³„ì† ìŠ¤ìº” ì‹œë„)
        };

        html5QrCodeScanner.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure)
            .catch(err => {
                console.error("ì¹´ë©”ë¼ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", err);
                showMessage("ì¹´ë©”ë¼ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.", "ì˜¤ë¥˜");
                stopScanner();
            });
    };

    const stopScanner = () => {
        if (html5QrCodeScanner) {
            html5QrCodeScanner.stop().then(ignore => {
                // ìŠ¤ìºë„ˆê°€ ì„±ê³µì ìœ¼ë¡œ ì¤‘ì§€ë¨
            }).catch(err => {
                console.error("ìŠ¤ìºë„ˆ ì¤‘ì§€ ì‹¤íŒ¨.", err);
            }).finally(() => {
                scannerModal.style.display = 'none';
                html5QrCodeScanner = null;
            });
        } else {
             scannerModal.style.display = 'none';
        }
    };
    // â–²â–²â–²â–²â–² ì—¬ê¸°ê¹Œì§€ ì¶”ê°€ â–²â–²â–²â–²â–²

    document.addEventListener('DOMContentLoaded', () => {
        try {
            setVersionInfo();
            setupDelegatedEventListeners();

            // í‚¤ë³´ë“œ 'ì´ë™' í‚¤ë¡œ ê²€ìƒ‰ ì‹¤í–‰ ë° í‚¤íŒ¨ë“œ ìˆ¨ê¸°ê¸°
            invoiceNumberInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    searchButton.click();
                    invoiceNumberInput.blur();
                }
            });

            // --- ì™¸ë¶€ ìŠ¤ìºë„ˆ ì•± ì—°ë™ ë¡œì§ ---
            const urlParams = new URLSearchParams(window.location.search);
            const hawbFromUrl = urlParams.get('hawb');
            const filterFromUrl = urlParams.get('filter');

            if (filterFromUrl && filterCategories.includes(filterFromUrl)) {
                const targetFilterButton = filterButtonsContainer.querySelector(`[data-filter="${filterFromUrl}"]`);
                if (targetFilterButton) targetFilterButton.click();
            } else {
                const initialBtn = filterButtonsContainer.querySelector(`[data-filter="ë°°ì†¡ì¤€ë¹„"]`);
                if (initialBtn) initialBtn.click();
            }

            if (hawbFromUrl) {
                invoiceNumberInput.value = hawbFromUrl;
                searchButton.click();
            }
            // ------------------------------------

            // â–¼â–¼â–¼â–¼â–¼ ì¶”ê°€ëœ ë¶€ë¶„: ìŠ¤ìºë„ˆ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ â–¼â–¼â–¼â–¼â–¼
            scanButton.addEventListener('click', startScanner);
            scannerCloseButton.addEventListener('click', stopScanner);
            // â–²â–²â–²â–²â–² ì—¬ê¸°ê¹Œì§€ ì¶”ê°€ â–²â–²â–²â–²â–²

            // 'ë°°ì†¡ì¤‘' FAB ì´ë²¤íŠ¸
            fabSortNo.addEventListener('click', () => {
                currentSortOrder = 'no';
                deliveryItems.sort((a, b) => a.no - b.no);
                renderDeliveryCards(activeFilter);
                showToastMessage('ìˆœë²ˆìˆœìœ¼ë¡œ ì •ë ¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
            });

            fabSortDistance.addEventListener('click', async () => {
                showLoadingMessage('í˜„ì¬ ìœ„ì¹˜ í™•ì¸ ì¤‘...');
                try {
                    const myLocation = await getCurrentLocation();
                    
                    const inProgressItems = deliveryItems.filter(item => item.status === 'ë°°ì†¡ì¤‘');
                    const otherItems = deliveryItems.filter(item => item.status !== 'ë°°ì†¡ì¤‘');

                    const itemsWithCoords = inProgressItems.filter(item => item.addressLocation);
                    const itemsWithoutCoords = inProgressItems.filter(item => !item.addressLocation);

                    if (itemsWithoutCoords.length > 0) {
                        showToastMessage(`${itemsWithoutCoords.length}ê°œì˜ ì¹´ë“œì— ì¢Œí‘œ ì •ë³´ê°€ ì—†ì–´ ì •ë ¬ì—ì„œ ì œì™¸ë©ë‹ˆë‹¤.`);
                    }

                    itemsWithCoords.forEach(item => {
                        item.distanceFromMe = calculateDistance(myLocation, item.addressLocation);
                    });

                    itemsWithCoords.sort((a, b) => a.distanceFromMe - b.distanceFromMe);
                    
                    deliveryItems = [...itemsWithCoords, ...itemsWithoutCoords, ...otherItems];
                    
                    currentSortOrder = 'distance';
                    renderDeliveryCards(activeFilter);
                    closeConfirmationModal();
                    showToastMessage('ê°€ê¹Œìš´ ê±°ë¦¬ìˆœìœ¼ë¡œ ì •ë ¬ë˜ì—ˆìŠµë‹ˆë‹¤.');

                } catch (error) {
                    closeConfirmationModal();
                    showMessage(`í˜„ì¬ ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${error.message}`, 'ì˜¤ë¥˜');
                }
            });

            fabJumpNo.addEventListener('click', () => {
                numberJumpList.innerHTML = '';
                if (deliveryItems.length === 0) {
                    numberJumpList.innerHTML = '<p class="text-gray-500 col-span-5 text-center">ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                    numberJumpModal.style.display = 'flex';
                    return;
                }

                const maxNo = Math.max(0, ...deliveryItems.map(item => item.no));
                const itemsMap = new Map(deliveryItems.map(item => [item.no, item.status]));

                for (let i = 1; i <= maxNo; i++) {
                    const status = itemsMap.get(i);
                    const btn = document.createElement('div');
                    btn.textContent = i;
                    
                    if (status === 'ë°°ì†¡ì¤‘') {
                        btn.className = 'number-jump-item active';
                        btn.dataset.no = i;
                        btn.onclick = () => {
                            const targetCard = document.querySelector(`[data-no="${i}"]`);
                            if (targetCard) {
                                const headerOffset = filterButtonsContainer.offsetHeight;
                                const elementPosition = targetCard.getBoundingClientRect().top;
                                const offsetPosition = elementPosition + window.pageYOffset - headerOffset - 10;
                                
                                window.scrollTo({
                                    top: offsetPosition,
                                    behavior: 'smooth'
                                });
                            }
                            numberJumpModal.style.display = 'none';
                        };
                    } else if (status) { // ë°°ì†¡ì „ ë˜ëŠ” ì™„ë£Œ
                        btn.className = 'number-jump-item inactive';
                    } else { // ëˆ„ë½ëœ ë²ˆí˜¸
                        btn.className = 'number-jump-item placeholder';
                        btn.innerHTML = 'Â ';
                    }
                    numberJumpList.appendChild(btn);
                }
                numberJumpModal.style.display = 'flex';
            });

            numberJumpClose.addEventListener('click', () => {
                numberJumpModal.style.display = 'none';
            });

            // 'ì™„ë£Œ' FAB ì´ë²¤íŠ¸
            fabSortNoCompleted.addEventListener('click', () => {
                currentSortOrder = 'no';
                deliveryItems.sort((a, b) => a.no - b.no);
                renderDeliveryCards(activeFilter);
                showToastMessage('ìˆœë²ˆìˆœìœ¼ë¡œ ì •ë ¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
            });

            fabSortTime.addEventListener('click', () => {
                currentSortOrder = 'time';
                const completedItems = deliveryItems.filter(item => item.status === 'ì™„ë£Œ');
                const otherItems = deliveryItems.filter(item => item.status !== 'ì™„ë£Œ');
                
                completedItems.sort((a, b) => {
                    if (!a.deliveryCompletionTime) return 1;
                    if (!b.deliveryCompletionTime) return -1;
                    return a.deliveryCompletionTime.localeCompare(b.deliveryCompletionTime);
                });

                deliveryItems = [...completedItems, ...otherItems];
                renderDeliveryCards(activeFilter);
                showToastMessage('ë¹ ë¥¸ ì™„ë£Œì‹œê°„ìˆœìœ¼ë¡œ ì •ë ¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
            });

            // ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸
            window.addEventListener('scroll', () => {
                const currentScrollY = window.scrollY;
                if (currentScrollY > lastScrollY) { // Scrolling down
                    searchBarContainer.classList.add('hidden');
                    fabContainerInProgress.classList.add('hidden');
                    fabContainerCompleted.classList.add('hidden');
                } else { // Scrolling up
                    searchBarContainer.classList.remove('hidden');
                    fabContainerInProgress.classList.remove('hidden');
                    fabContainerCompleted.classList.remove('hidden');
                }
                lastScrollY = currentScrollY <= 0 ? 0 : currentScrollY;
            });

            window.addEventListener('popstate', (event) => {
                if (smartEditModal.style.display === 'flex') {
                    smartEditModal.style.display = 'none';
                    currentEditItemNo = null;
                }
            });

            const storedItems = localStorage.getItem('deliveryItems');
            if (storedItems) {
                let parsedItems = JSON.parse(storedItems);
                deliveryItems = parsedItems.map(item => {
                    if (typeof item.addressLocation === 'undefined') {
                        item.addressLocation = null;
                    }
                    return item;
                }).sort((a, b) => a.no - b.no);
            }
            const storedScroll = localStorage.getItem('filterScrollPositions');
            if (storedScroll) filterScrollPositions = JSON.parse(storedScroll);
            updateFilterCounts();
            
            if (!hawbFromUrl && !filterFromUrl) {
                const initialBtn = filterButtonsContainer.querySelector(`[data-filter="ë°°ì†¡ì¤€ë¹„"]`);
                if (initialBtn) initialBtn.click();
            }

        } catch (error) {
            console.error("ì´ˆê¸°í™” ì˜¤ë¥˜:", error);
            document.body.innerHTML = `<div class="p-4 text-red-500">ì•± ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì˜¤ë¥˜: ${error.message}</div>`;
        }
    });
    </script>
</body>
</html>