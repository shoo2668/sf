<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>배송 시트</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        html { scroll-behavior: smooth !important; overflow-x: hidden; scroll-padding-top: 88px; /* JS가 동적으로 변경 */ }
        body { font-family: 'Inter', sans-serif; margin: 0; padding-bottom: 80px; overscroll-behavior: contain; overflow-x: hidden; padding-top: 88px; /* JS가 동적으로 변경 */ }
        .signature-modal, .confirmation-modal, .smart-edit-modal, .number-jump-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        .signature-modal-content, .confirmation-modal-content, .smart-edit-modal-content, .number-jump-modal-content { background-color: white; border-radius: 0.5rem; box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); padding: 1.5rem; width: 100%; max-width: 32rem; max-height: 95vh; display: flex; flex-direction: column; }
        #smart-edit-scroll-area { flex-grow: 1; overflow-y: auto; margin-bottom: 1rem; }
        
        .key-button { position: relative; overflow: visible !important; -webkit-tap-highlight-color: transparent; }
        .key-pop {
            position: absolute;
            bottom: 80%;
            left: 50%;
            transform: translateX(-50%) scale(0.8);
            transform-origin: bottom center;
            background-color: #374151; /* gray-700 */
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 1.25rem;
            font-weight: 600;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s, transform 0.2s;
            z-index: 10;
            min-width: 100%;
            text-align: center;
            white-space: nowrap;
        }
        .key-button:active .key-pop {
            opacity: 1;
            transform: translateX(-50%) scale(1) translateY(-8px);
        }
        #address-pieces-container button { margin: 0.25rem; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.875rem; font-weight: 500; transition: background-color: 0.2s; }

        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); border-left-color: #2563eb; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .animate-slide-in-left { animation: slideInLeft 0.3s ease-out forwards; }
        @keyframes slideInLeft { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .animate-slide-in-right { animation: slideInRight 0.3s ease-out forwards; }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        #delivery-cards-container { transition: transform 0.1s ease-out; will-change: transform; }
        #filter-buttons-container { position: fixed; top: 0; left: 0; width: 100%; will-change: transform, top; }
        #toast-container { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); z-index: 100; display: flex; flex-direction: column; align-items: center; gap: 8px; pointer-events: none; }
        .toast-message { background-color: rgba(0, 0, 0, 0.75); color: white; padding: 10px 20px; border-radius: 20px; font-size: 0.875rem; box-shadow: 0 2px 10px rgba(0,0,0,0.2); opacity: 0; transition: opacity 0.5s, transform 0.5s; transform: translateY(20px); }
        .toast-message.show { opacity: 1; transform: translateY(0); }
        #number-jump-list { display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.5rem; overflow-y: auto; padding: 0.5rem; margin: -0.5rem; max-height: 60vh; }
        .number-jump-item { min-width: 50px; padding: 0.75rem; border-radius: 0.5rem; font-weight: 600; text-align: center; transition: background-color: 0.2s, color 0.2s; }
        .number-jump-item.active { background-color: #2563eb; color: white; cursor: pointer; }
        .number-jump-item.active:hover { background-color: #1d4ed8; }
        .number-jump-item.inactive { background-color: #f3f4f6; color: #9ca3af; cursor: not-allowed; }
        .number-jump-item.placeholder { background-color: transparent; }
        .bottom-bar { position: fixed; bottom: 0; left: 0; width: 100vw; z-index: 46; transition: transform 0.3s ease-out; background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); border-top: 1px solid #e5e7eb; }
        .bottom-bar.hidden { transform: translateY(100%); }
    </style>
</head>
<body class="min-h-screen bg-gray-100 p-4 sm:p-6 lg:p-8 font-sans">
    <div id="filter-buttons-container" class="z-20">
        <div class="max-w-md mx-auto bg-white rounded-lg shadow-lg w-full min-w-[320px] p-4">
            <div class="flex justify-around space-x-2 overflow-x-auto" style="-webkit-overflow-scrolling: touch;">
                <button data-filter="배송준비" class="flex-shrink-0 px-3 py-1.5 rounded-full text-sm font-medium transition-colors duration-200 flex items-center justify-center space-x-1 whitespace-nowrap"><span>배송준비</span></button>
                <button data-filter="전체" class="flex-shrink-0 px-3 py-1.5 rounded-full text-sm font-medium transition-colors duration-200 flex items-center justify-center space-x-1 bg-transparent text-gray-700 border border-gray-300 hover:bg-gray-100 whitespace-nowrap"><span>전체</span><span class="text-xs font-semibold px-1.5 py-0.5 rounded-full bg-gray-200 text-gray-700" id="count-전체">0</span></button>
                <button data-filter="배송전" class="flex-shrink-0 px-3 py-1.5 rounded-full text-sm font-medium transition-colors duration-200 flex items-center justify-center space-x-1 bg-transparent text-gray-700 border border-gray-300 hover:bg-gray-100 whitespace-nowrap"><span>배송전</span><span class="text-xs font-semibold px-1.5 py-0.5 rounded-full bg-gray-200 text-gray-700" id="count-배송전">0</span></button>
                <button data-filter="배송중" class="flex-shrink-0 px-3 py-1.5 rounded-full text-sm font-medium transition-colors duration-200 flex items-center justify-center space-x-1 bg-transparent text-gray-700 border border-gray-300 hover:bg-gray-100 whitespace-nowrap"><span>배송중</span><span class="text-xs font-semibold px-1.5 py-0.5 rounded-full bg-gray-200 text-gray-700" id="count-배송중">0</span></button>
                <button data-filter="완료" class="flex-shrink-0 px-3 py-1.5 rounded-full text-sm font-medium transition-colors duration-200 flex items-center justify-center space-x-1 bg-transparent text-gray-700 border border-gray-300 hover:bg-gray-100 whitespace-nowrap"><span>완료</span><span class="text-xs font-semibold px-1.5 py-0.5 rounded-full bg-gray-200 text-gray-700" id="count-완료">0</span></button>
            </div>
        </div>
    </div>

    <div id="data-management-container" class="max-w-md mx-auto mb-6 p-4 bg-white rounded-lg shadow-lg w-full min-w-[320px] space-y-4 hidden">
        <div>
            <h3 class="text-lg font-semibold text-gray-800 mb-2">데이터 내보내기/가져오기</h3>
            <div class="flex space-x-2">
                <button id="exportDataButton" class="w-1/2 px-4 py-2 bg-teal-600 text-white rounded-md hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-teal-500">데이터 파일로 저장</button>
                <label for="importDataInput" class="w-1/2 px-4 py-2 bg-sky-600 text-white rounded-md hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-sky-500 text-center cursor-pointer">파일에서 불러오기</label>
                <input type="file" id="importDataInput" class="hidden" accept=".json"/>
            </div>
        </div>
        <div>
            <h3 class="text-lg font-semibold text-gray-800 mb-2">카드 초기화</h3>
            <button id="clearAllCardsButton" class="w-full px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">모든 카드 삭제</button>
        </div>
    </div>

    <div id="scan-section-container" class="max-w-md mx-auto mb-6 p-4 bg-white rounded-lg shadow-lg w-full min-w-[320px] hidden">
        <h3 class="text-lg font-semibold text-gray-800 mb-3">송장 스캔하여 카드 생성</h3>
        <div class="flex flex-col sm:flex-row items-center space-y-3 sm:space-y-0 sm:space-x-3">
            <input type="file" id="deliverySheetImage" accept="image/*" multiple class="hidden"/>
            <label for="deliverySheetImage" class="flex-1 w-full text-sm text-blue-700 py-2 px-4 rounded-md border border-blue-300 bg-blue-50 font-semibold cursor-pointer hover:bg-blue-100 text-center whitespace-nowrap">사진 선택</label>
            <button id="scanAndGenerateButton" class="w-full sm:w-auto px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50">스캔하여 카드 생성</button>
        </div>
        <div id="selected-files-display" class="mt-2 text-sm text-gray-600 text-center">선택된 파일 없음</div>
        <div id="scan-loading-indicator" class="hidden mt-3 text-center text-sm text-blue-600">
            <div class="spinner mx-auto mb-2"></div>
            <p id="scan-progress-text">송장 스캔 중...</p>
        </div>
        <div id="scan-error-message" class="hidden mt-3 text-center text-sm text-red-600">스캔 실패: <span id="scan-error-text"></span></div>
    </div>
    
    <div id="version-info-container" class="max-w-md mx-auto mb-6 text-center hidden">
        <p id="version-text" class="text-xs text-gray-600 font-mono"></p>
        <p id="version-changelog" class="text-xs text-gray-500"></p>
    </div>

    <div id="delivery-cards-container" class="max-w-md mx-auto"></div>
    
    <div id="toast-container"></div>

    <div id="search-bar-container" class="bottom-bar">
        <div class="max-w-md mx-auto w-full min-w-[320px] p-4">
            <label for="invoiceNumber" class="block text-sm font-medium text-gray-700 sr-only">송장번호 검색</label>
            <div class="flex space-x-2 flex-nowrap">
                <input type="tel" id="invoiceNumber" name="invoiceNumber" placeholder="송장번호 검색" class="w-1/2 p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" inputmode="numeric" pattern="[0-9]*"/>
                <button id="searchButton" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">검색</button>
                <button id="resetButton" class="flex-1 px-4 py-2 bg-gray-400 text-white rounded-md hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50">지움</button>
            </div>
        </div>
    </div>

    <div id="action-bar-container" class="bottom-bar">
        <div class="max-w-md mx-auto w-full min-w-[320px] p-4">
            <div id="action-buttons" class="flex space-x-2 flex-nowrap">
                <!-- 액션 버튼들이 여기에 동적으로 추가됩니다. -->
            </div>
        </div>
    </div>

    <div id="number-jump-modal" class="number-jump-modal" style="display: none;">
        <div class="number-jump-modal-content">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">번호로 이동</h2>
            <div id="number-jump-list">
                <!-- 번호 버튼들이 여기에 동적으로 추가됩니다. -->
            </div>
            <div class="flex justify-end mt-6">
                <button id="number-jump-close" class="px-4 py-2 bg-gray-400 text-white rounded-md hover:bg-gray-500 text-sm font-medium">닫기</button>
            </div>
        </div>
    </div>

    <div id="signature-modal" class="signature-modal" style="display: none;">
        <div class="signature-modal-content">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">서명 입력</h2>
            <div class="signature-input-container">
                <textarea id="signature-text-input" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" rows="3" placeholder="여기에 서명 내용을 입력하세요."></textarea>
            </div>
            <div class="flex justify-end space-x-2 mt-4">
                <button id="clearSignature" class="px-4 py-2 rounded-md bg-gray-300 text-gray-800 text-sm font-medium hover:bg-gray-400">지우기</button>
                <button id="cancelSignature" class="px-4 py-2 rounded-md bg-red-500 text-white text-sm font-medium hover:bg-red-600">취소</button>
                <button id="saveSignature" class="px-4 py-2 rounded-md bg-blue-600 text-white text-sm font-medium hover:bg-blue-700">저장</button>
            </div>
        </div>
    </div>

    <div id="confirmation-modal" class="confirmation-modal" style="display: none;">
        <div class="confirmation-modal-content">
            <h2 class="text-xl font-semibold mb-4 text-gray-800" id="confirmation-modal-title">확인</h2>
            <div id="confirmation-modal-body">
                <p class="text-base text-gray-700 mb-6" id="confirmation-modal-message"></p>
            </div>
            <div class="flex justify-between space-x-2 mt-4" id="confirmation-modal-buttons">
                <button id="confirmCancelButton" class="w-1/2 px-4 py-2 rounded-md bg-gray-300 text-gray-800 text-sm font-medium hover:bg-gray-400">취소</button>
                <button id="confirmOkButton" class="w-1/2 px-4 py-2 rounded-md bg-blue-600 text-white text-sm font-medium hover:bg-blue-700">확인</button>
            </div>
        </div>
    </div>

    <!-- 스마트 편집 모달 -->
    <div id="smart-edit-modal" class="smart-edit-modal" style="display: none;">
        <div class="smart-edit-modal-content">
            <div id="smart-edit-scroll-area">
                <div class="mb-4">
                    <h3 class="text-sm font-semibold text-gray-600 mb-1">AI 추출 원본 (참조용)</h3>
                    <p id="original-address-display" class="p-2 bg-gray-100 rounded-md text-gray-800 text-sm font-mono break-all"></p>
                </div>

                <div class="mb-2">
                    <h3 class="text-sm font-semibold text-gray-600 mb-1">주소 조각 (클릭하여 추가)</h3>
                    <div id="address-pieces-container" class="flex flex-wrap p-2 bg-gray-50 rounded-md border border-gray-200 min-h-[40px]"></div>
                </div>
                
                <div id="fixed-buttons-container" class="mt-2 grid grid-cols-2 gap-4">
                    <div id="number-keypad" class="grid grid-cols-3 gap-2"></div>
                    <div id="unit-keypad" class="grid grid-cols-2 gap-2"></div>
                </div>

                <hr class="my-4 border-gray-300"/>

                <div class="mt-4">
                    <div class="flex justify-between items-center mb-2">
                         <h3 class="text-lg font-semibold text-gray-800">주소 조각 편집</h3>
                         <div class="flex items-center space-x-2">
                            <button id="reset-pieces-btn" class="p-1.5 text-gray-500 hover:bg-gray-200 rounded-full">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                            </button>
                            <button id="apply-pieces-btn" class="px-4 py-1.5 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm font-medium">수정 완료</button>
                         </div>
                    </div>
                    <textarea id="pieces-address-input" class="w-full p-2 border border-gray-300 rounded-md bg-gray-50 focus:ring-blue-500 focus:border-blue-500 resize-none overflow-hidden" rows="1" readonly></textarea>
                </div>
                
                <div class="mt-4">
                     <div class="flex justify-between items-center mb-2">
                         <h3 class="text-lg font-semibold text-gray-800">직접 주소 편집</h3>
                         <div class="flex items-center space-x-2">
                             <button id="revert-direct-btn" class="p-1.5 text-gray-500 hover:bg-gray-200 rounded-full">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.354 1.646a.5.5 0 010 .708L2.707 8l5.647 5.646a.5.5 0 01-.708.708l-6-6a.5.5 0 010-.708l6-6a.5.5 0 01.708 0z" clip-rule="evenodd" /><path fill-rule="evenodd" d="M12.5 8a.5.5 0 01.5-.5h5a.5.5 0 010 1h-5a.5.5 0 01-.5-.5z" clip-rule="evenodd" /></svg>
                            </button>
                            <button id="apply-direct-btn" class="px-4 py-1.5 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm font-medium">수정 완료</button>
                         </div>
                    </div>
                    <textarea id="direct-address-input" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 resize-none overflow-hidden" rows="2"></textarea>
                </div>

            </div>
            <div class="flex justify-end mt-auto pt-4 border-t border-gray-200">
                <button id="smart-edit-exit" class="px-4 py-2 bg-gray-400 text-white rounded-md hover:bg-gray-500 text-sm font-medium">나가기</button>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        const GEMINI_PROMPT = `Analyze the provided image of a delivery invoice page. Your task is to extract all key information and follow the specified format precisely based on the carrier.

**PRIMARY INSTRUCTIONS:**

1.  **IDENTIFY CARRIER:** First, identify the carrier ("SF Express" or "United Parcel Service"). The entire output structure depends on this.

2.  **EXTRACT PAGE NUMBER (MANDATORY):**
    *   This is critical for ordering. **You MUST NOT skip this.**
    *   Find the page number (e.g., 'Page: 1', 'Page 1') from the top right.
    *   Store this number in a top-level "pageNo" field.
    *   If a page number is absolutely not visible, use \`"pageNo": 9999\`.

3.  **TRANSLATE & SEPARATE (MANDATORY FOR ALL DATA):**
    *   For all extracted names and addresses, you MUST translate them into standard Korean.
    *   **Names:** Translate "receiverName" and "receiverCompanyName" to Korean. Store them in "receiverNameKorean" and "receiverCompanyNameKorean". If already Korean, just copy.
    *   **Addresses:** Translate "receiverAddress" to a standard Korean address format. Then, separate it into "baseAddressKorean" (main part, e.g., "서울 송파구 양재대로 1300") and "detailAddressKorean" (the rest, e.g., "올림픽파크포레온 319동 307호").

**OUTPUT FORMAT BY CARRIER:**

*   **If carrier is "SF Express":**
    *   Output a **JSON array of objects**.
    *   Each object represents one delivery item and MUST contain:
        *   "carrier": "SF"
        *   "no", "hawbNo"
        *   "receiverCompanyName", "receiverCompanyNameKorean"
        *   "receiverName", "receiverNameKorean"
        *   "receiverPhone"
        *   "receiverAddress" (original full address)
        *   "baseAddressKorean", "detailAddressKorean"
    *   Include the "pageNo" in the **first object only** of the array.

*   **If carrier is "United Parcel Service" (UPS):**
    *   Output a **SINGLE JSON OBJECT**.
    *   This object will contain the top-level "pageNo" and "carrier": "UPS".
    *   It will also contain several arrays of data. **Go down the page and extract all instances of each field type into its corresponding array, maintaining the strict top-to-bottom order.**
    *   The required arrays are:
        *   \`trackingNumbers\`: All "TrackingNumber" values (starting with "1Z...").
        *   \`companyNames\`: All texts next to "Total:".
        *   \`receiverNames\`: All texts next to "NDOC".
        *   \`addresses\`: All texts next to "운임:".
        *   \`phoneNumbers\`: All texts next to "참고료:".
    *   **CRITICAL FOR DATA INTEGRITY:** The number of elements in ALL these arrays **MUST BE EXACTLY THE SAME**. If a field is missing for an item (e.g., no phone number), you MUST add an empty string "" to its corresponding array at the correct index to maintain alignment. Do not skip it.

**Example Output for UPS (SINGLE OBJECT):**
\`\`\`json
{
  "carrier": "UPS",
  "pageNo": 1,
  "trackingNumbers": ["1Z...", "1Z...", "1Z..."],
  "companyNames": ["Company A", "Company B", "Company C"],
  "receiverNames": ["Receiver A", "Receiver B", "Receiver C"],
  "addresses": ["Address A...", "Address B...", "Address C..."],
  "phoneNumbers": ["Phone A", "", "Phone C"]
}
\`\`\`
`;
        
        const KAKAO_API_KEY = '2342aad8b15d534cb60fb824f71a97f1';

        const dateTimeFormatOptions = { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };

        // --- Helper functions ---

        const setVersionInfo = () => {
            const version = "v1.9.05 - 2024-05-28";
            const changelog = "한글 번역 및 주소 분리 기능 복원. UPS 데이터 밀림 현상 해결 및 스캔 안정성 강화.";
            if (versionText) versionText.textContent = version;
            if (versionChangelog) versionChangelog.textContent = changelog;
        };

        const setupDelegatedEventListeners = () => {
            deliveryCardsContainer.addEventListener('click', (event) => {
                const target = event.target.closest('button, input[type="checkbox"], p[data-action="open-smart-edit"]');
                if (!target) return;

                const action = target.dataset.action;
                const itemNo = parseInt(target.dataset.no, 10);

                switch (action) {
                    case 'toggle-hawb-confirm':
                        handleCheckboxToggleAndResetSearch(itemNo, target);
                        break;
                    case 'open-naver-map':
                        {
                            const item = deliveryItems.find(i => i.no === itemNo);
                            if (item) openNaverMap(item);
                        }
                        break;
                    case 'revert-delivery':
                        openConfirmationModal(`${itemNo}번 항목을 '배송전' 상태로 되돌리시겠습니까?`, () => {
                            handleStatusChange(itemNo, '배송전');
                            showToastMessage(`${itemNo}번 항목이 되돌려졌습니다.`);
                        });
                        break;
                    case 'identity-verification':
                        openConfirmationModal(`${itemNo}번 항목을 '본인확인'으로 완료 처리하시겠습니까?`, () => {
                            const currentTime = new Date().toLocaleString('ko-KR', dateTimeFormatOptions);
                            handleStatusChange(itemNo, '완료', currentTime, '본인확인', '신분증');
                        });
                        break;
                    case 'front-door-delivery':
                        openConfirmationModal(`${itemNo}번 항목을 '문앞배송'으로 완료 처리하시겠습니까?`, () => {
                            const currentTime = new Date().toLocaleString('ko-KR', dateTimeFormatOptions);
                            handleStatusChange(itemNo, '완료', currentTime, '문앞배송');
                        });
                        break;
                    case 'sign-delivery':
                        openSignatureModal(itemNo);
                        break;
                    case 'toggle-details':
                        {
                            const detailsContainer = document.querySelector(`div[data-details-container="${itemNo}"]`);
                            const iconButton = target.closest('button');
                            const iconSvg = iconButton.querySelector('svg');

                            if (detailsContainer && iconSvg) {
                                const isHidden = detailsContainer.style.display === 'none';
                                detailsContainer.style.display = isHidden ? 'block' : 'none';
                                
                                if (isHidden) {
                                    iconSvg.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" />`; // Up arrow
                                } else {
                                    iconSvg.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />`; // Down arrow
                                }
                            }
                        }
                        break;
                    case 'open-smart-edit':
                        openSmartEditModal(itemNo);
                        break;
                }
            });
        };

        const resizeImage = (file) => {
            return new Promise((resolve, reject) => {
                const MAX_WIDTH = 1920;
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        let width = img.width;
                        let height = img.height;
                        if (width > MAX_WIDTH) {
                            height = (MAX_WIDTH / width) * height;
                            width = MAX_WIDTH;
                        }
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
                        resolve({ file, data: dataUrl.split(',')[1] });
                    };
                    img.onerror = (error) => reject(error);
                };
                reader.onerror = (error) => reject(error);
                reader.readAsDataURL(file);
            });
        };

        const getCurrentLocation = (timeout = 10000) => {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    return reject(new Error('Geolocation is not supported by this browser.'));
                }
                navigator.geolocation.getCurrentPosition(
                    (position) => resolve({ lat: position.coords.latitude, lng: position.coords.longitude }),
                    (error) => reject(error),
                    { enableHighAccuracy: true, timeout, maximumAge: 0 }
                );
            });
        };

        const getCoordsFromAddress = async (address) => {
            if (!address) throw new Error("Address is empty.");
            const response = await fetch(`https://dapi.kakao.com/v2/local/search/address.json?query=${encodeURIComponent(address)}`, {
                headers: { 'Authorization': `KakaoAK ${KAKAO_API_KEY}` }
            });
            if (!response.ok) throw new Error('Kakao Geocoding API call failed');
            const data = await response.json();
            if (data.documents && data.documents.length > 0) {
                const location = data.documents[0];
                return { lat: parseFloat(location.y), lng: parseFloat(location.x) };
            }
            throw new Error("Could not find coordinates for the address.");
        };

        const calculateDistance = (pos1, pos2) => {
            if (!pos1 || !pos2) return Infinity;
            const R = 6371; // Radius of the Earth in km
            const dLat = (pos2.lat - pos1.lat) * Math.PI / 180;
            const dLon = (pos2.lng - pos1.lng) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(pos1.lat * Math.PI / 180) * Math.cos(pos2.lat * Math.PI / 180) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // Distance in km
        };

        const formatSinglePhoneNumber = (phoneNumber) => {
            if (typeof phoneNumber !== 'string' || !phoneNumber) return '';
            let cleaned = phoneNumber.replace(/\D/g, '');

            if (cleaned.startsWith('+82010')) { cleaned = '010' + cleaned.substring(6); }
            else if (cleaned.startsWith('82010')) { cleaned = '010' + cleaned.substring(5); }
            else if (cleaned.startsWith('+8210')) { cleaned = '010' + cleaned.substring(5); }
            else if (cleaned.startsWith('8210')) { cleaned = '010' + cleaned.substring(4); }
            else if (cleaned.startsWith('8201') && cleaned.length > 4 && cleaned[4] !== '0') { cleaned = '010' + cleaned.substring(4); }
            else if (cleaned.startsWith('82') && cleaned.length > 2) { cleaned = '0' + cleaned.substring(2); }
            else if (cleaned.length >= 7 && cleaned.length <= 11 && !cleaned.startsWith('0')) { cleaned = '0' + cleaned; }
            
            if (cleaned.startsWith('010') && cleaned.length === 11) return cleaned.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
            if (cleaned.startsWith('02')) {
                if (cleaned.length === 9) return cleaned.replace(/(\d{2})(\d{3})(\d{4})/, '$1-$2-$3');
                if (cleaned.length === 10) return cleaned.replace(/(\d{2})(\d{4})(\d{4})/, '$1-$2-$3');
            }
            if (cleaned.startsWith('031') && cleaned.length === 11) return cleaned.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
            if (cleaned.startsWith('070') && cleaned.length === 11) return cleaned.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
            if (cleaned.length === 10) return cleaned.replace(/(\d{3})(\d{3})(\d{4})/, '$1-$2-$3');
            if (cleaned.length === 9) return cleaned.replace(/(\d{2})(\d{3})(\d{4})/, '$1-$2-$3');
            if (cleaned.length === 8) return cleaned.replace(/(\d{4})(\d{4})/, '$1-$2');
            if (cleaned.length === 7) return cleaned.replace(/(\d{3})(\d{4})/, '$1-$2');

            return cleaned;
        };

        const formatPhoneNumberForDisplay = (phoneNumber) => {
            if (typeof phoneNumber !== 'string' || !phoneNumber) return '';
            const rangeMatch = phoneNumber.match(/^(\d+)-(\d+)$/);
            if (rangeMatch) {
                const baseNumber = rangeMatch[1];
                const suffix = rangeMatch[2];
                if (baseNumber.length >= suffix.length) {
                    const num1 = formatSinglePhoneNumber(baseNumber);
                    const num2Raw = baseNumber.substring(0, baseNumber.length - suffix.length) + suffix;
                    const num2 = formatSinglePhoneNumber(num2Raw);
                    return `${num1} / ${num2}`;
                }
            }
            return formatSinglePhoneNumber(phoneNumber.replace(/\D/g, ''));
        };

        const getCleanPhoneNumber = (phoneNumber) => {
            if (typeof phoneNumber !== 'string' || !phoneNumber) return '';
            const rangeMatch = phoneNumber.match(/^(\d+)-(\d+)$/);
            if (rangeMatch) phoneNumber = rangeMatch[1];
            
            let cleaned = phoneNumber.replace(/\D/g, '');

            if (cleaned.startsWith('+82010')) { cleaned = '010' + cleaned.substring(6); }
            else if (cleaned.startsWith('82010')) { cleaned = '010' + cleaned.substring(5); }
            else if (cleaned.startsWith('+8210')) { cleaned = '010' + cleaned.substring(5); }
            else if (cleaned.startsWith('8210')) { cleaned = '010' + cleaned.substring(4); }
            else if (cleaned.startsWith('8201') && cleaned.length > 4 && cleaned[4] !== '0') { cleaned = '010' + cleaned.substring(4); }
            else if (cleaned.startsWith('82') && cleaned.length > 2) { cleaned = '0' + cleaned.substring(2); }
            else if (cleaned.length >= 7 && cleaned.length <= 11 && !cleaned.startsWith('0')) { cleaned = '0' + cleaned; }

            return cleaned;
        };

        const formatHawbNoForDisplay = (hawbNo, carrier) => {
            if (!hawbNo) return '';
            if (carrier === 'SF' && hawbNo.length > 4) {
                const prefix = hawbNo.substring(0, hawbNo.length - 4);
                const suffix = hawbNo.substring(hawbNo.length - 4);
                return `${prefix} ${suffix}`;
            }
            return hawbNo;
        };

        const formatCompletionTime = (dateTimeString) => {
            if (!dateTimeString) return '';
            const parts = dateTimeString.split(' ');
            if (parts.length >= 4) {
                const [hour, minute] = parts[3].split(':');
                return `${hour}:${minute}`;
            }
            return '';
        };
        
        const extractClipboardAddressPart = (item) => {
            if (!item) return '';
            const { baseAddress, detailAddress } = item;
            if (detailAddress) {
                const hyphenMatch = detailAddress.match(/\b(\d{2,4}-\d{2,4})\b/);
                if (hyphenMatch) return hyphenMatch[1];
                const dongHoMatch = detailAddress.match(/(\d+)\s*동\s*(\d+)\s*호/);
                if (dongHoMatch) return `${dongHoMatch[1]}-${dongHoMatch[2]}`;
            }
            return baseAddress || '';
        };

        const isValidAddressForMap = (address) => {
            return !!(address && address.trim().length > 0);
        };
        
        const validateAddressWithKakao = async (baseAddress, detailAddress) => {
            if (!baseAddress) {
                return { baseAddress: '', detailAddress: detailAddress || '' };
            }
            try {
                const response = await fetch(`https://dapi.kakao.com/v2/local/search/address.json?query=${encodeURIComponent(baseAddress)}`, {
                    headers: { 'Authorization': `KakaoAK ${KAKAO_API_KEY}` }
                });
                if (!response.ok) throw new Error('Kakao Geocoding API call failed');
                const data = await response.json();
                if (data.documents && data.documents.length > 0) {
                    const doc = data.documents[0];
                    const kakaoBaseAddress = doc.road_address ? doc.road_address.address_name : doc.address.address_name;
                    return { baseAddress: kakaoBaseAddress, detailAddress: detailAddress || '' };
                }
                return { baseAddress, detailAddress: detailAddress || '' }; // 카카오가 못찾으면 원본 유지
            } catch (error) {
                console.error('Error validating address with Kakao API:', error);
                return { baseAddress, detailAddress: detailAddress || '' }; // 에러나도 원본 유지
            }
        };

        // --- Global state and DOM elements ---
        let deliveryItems = [];
        let searchTerm = '';
        let activeFilter = '전체';
        const filterCategories = ['배송준비', '전체', '배송전', '배송중', '완료'];
        let filterScrollPositions = {};
        let currentFileToScan = null;
        let failedFileObjects = []; 
        let currentSignatureItemNo = null;
        let onConfirmCallback = null;
        let currentEditItemNo = null; 
        let currentSortOrder = 'no'; // 'no' or 'distance' or 'time'
        let lastScrollY = 0; // For scroll direction detection
        let touchStartX = 0;
        let touchStartY = 0;
        let touchStartTime = 0;
        let backButtonPressedOnce = false;
        let justReturnedFromExternalApp = false;

        const searchBarContainer = document.getElementById('search-bar-container');
        const invoiceNumberInput = document.getElementById('invoiceNumber');
        const searchButton = document.getElementById('searchButton');
        const resetButton = document.getElementById('resetButton');
        const filterButtonsContainer = document.getElementById('filter-buttons-container');
        const deliveryCardsContainer = document.getElementById('delivery-cards-container');
        const deliverySheetImageInput = document.getElementById('deliverySheetImage');
        const scanAndGenerateButton = document.getElementById('scanAndGenerateButton');
        const scanLoadingIndicator = document.getElementById('scan-loading-indicator');
        const scanErrorMessage = document.getElementById('scan-error-message');
        const scanErrorText = document.getElementById('scan-error-text');
        const scanSectionContainer = document.getElementById('scan-section-container');
        const clearAllCardsButton = document.getElementById('clearAllCardsButton');
        const dataManagementContainer = document.getElementById('data-management-container');
        const exportDataButton = document.getElementById('exportDataButton');
        const importDataInput = document.getElementById('importDataInput');
        const scanProgressText = document.getElementById('scan-progress-text');
        const selectedFilesDisplay = document.getElementById('selected-files-display');
        
        const signatureModal = document.getElementById('signature-modal');
        const signatureTextInput = document.getElementById('signature-text-input');
        const clearSignatureBtn = document.getElementById('clearSignature');
        const cancelSignatureBtn = document.getElementById('cancelSignature');
        const saveSignatureBtn = document.getElementById('saveSignature');
        
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmationModalTitle = document.getElementById('confirmation-modal-title');
        const confirmationModalMessage = document.getElementById('confirmation-modal-message');
        const confirmationModalBody = document.getElementById('confirmation-modal-body');
        const confirmationModalButtons = document.getElementById('confirmation-modal-buttons');
        const confirmOkButton = document.getElementById('confirmOkButton');
        const confirmCancelButton = document.getElementById('confirmCancelButton');
        
        const versionInfoContainer = document.getElementById('version-info-container');
        const versionText = document.getElementById('version-text');
        const versionChangelog = document.getElementById('version-changelog');
        
        const smartEditModal = document.getElementById('smart-edit-modal');
        const originalAddressDisplay = document.getElementById('original-address-display');
        const piecesAddressInput = document.getElementById('pieces-address-input');
        const directAddressInput = document.getElementById('direct-address-input');
        const applyPiecesBtn = document.getElementById('apply-pieces-btn');
        const resetPiecesBtn = document.getElementById('reset-pieces-btn');
        const applyDirectBtn = document.getElementById('apply-direct-btn');
        const revertDirectBtn = document.getElementById('revert-direct-btn');
        const smartEditExitBtn = document.getElementById('smart-edit-exit');
        
        const toastContainer = document.getElementById('toast-container');
        
        const numberJumpModal = document.getElementById('number-jump-modal');
        const numberJumpList = document.getElementById('number-jump-list');
        const numberJumpClose = document.getElementById('number-jump-close');

        const actionBarContainer = document.getElementById('action-bar-container');
        const actionButtons = document.getElementById('action-buttons');

        // --- Modal & Core Logic Functions ---
        const openSignatureModal = (itemNo) => { currentSignatureItemNo = itemNo; signatureModal.style.display = 'flex'; signatureTextInput.value = ''; signatureTextInput.focus(); };
        const closeSignatureModal = () => { signatureModal.style.display = 'none'; currentSignatureItemNo = null; };
        const saveSignature = () => {
            if (currentSignatureItemNo === null) return;
            const signatureText = signatureTextInput.value.trim();
            if (signatureText === '') { showToastMessage('서명 내용을 입력해주세요.'); return; }
            const currentTime = new Date().toLocaleString('ko-KR', dateTimeFormatOptions);
            handleStatusChange(currentSignatureItemNo, '완료', currentTime, '서명', signatureText);
            closeSignatureModal();
            showToastMessage('서명이 성공적으로 저장되었습니다.');
        };
        
        const openConfirmationModal = (message, onOk, okText = '확인', cancelText = '취소') => {
            confirmationModalTitle.textContent = '확인';
            confirmationModalBody.innerHTML = `<p class="text-base text-gray-700 mb-6" id="confirmation-modal-message">${message}</p>`;
            confirmOkButton.textContent = okText;
            confirmCancelButton.textContent = cancelText;
            confirmCancelButton.style.display = '';
            confirmationModalButtons.style.display = 'flex';
            onConfirmCallback = onOk;
            confirmationModal.style.display = 'flex';
        };

        const closeConfirmationModal = () => { 
            confirmationModal.style.display = 'none'; 
            onConfirmCallback = null; 
        };

        const showMessage = (message, title = '알림') => {
            confirmationModalTitle.textContent = title;
            confirmationModalBody.innerHTML = `<p class="text-base text-gray-700 mb-6">${message}</p>`;
            confirmCancelButton.style.display = 'none';
            confirmOkButton.textContent = '확인';
            confirmationModalButtons.style.display = 'flex';
            onConfirmCallback = closeConfirmationModal;
            confirmationModal.style.display = 'flex';
        };

        const showLoadingMessage = (message) => {
            confirmationModalTitle.textContent = '처리 중';
            confirmationModalBody.innerHTML = `<div class="flex flex-col items-center justify-center p-4"><div class="spinner mb-4"></div><p class="text-base text-gray-700">${message}</p></div>`;
            confirmationModalButtons.style.display = 'none';
            confirmationModal.style.display = 'flex';
        };

        const showToastMessage = (message, duration = 1200) => {
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.className = 'toast-message';
            toastContainer.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('show');
            }, 10);

            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                });
            }, duration);
        };
        
        const autoResizeTextarea = (event) => {
            const textarea = event.target;
            textarea.style.height = 'auto';
            textarea.style.height = (textarea.scrollHeight) + 'px';
        };
        
        const triggerHapticFeedback = () => {
            if (navigator.vibrate) {
                navigator.vibrate(10); // 10ms 진동
            }
        };

        const openSmartEditModal = (itemNo) => {
            currentEditItemNo = itemNo;
            const item = deliveryItems.find(i => i.no === itemNo);
            if (!item) { showMessage('카드 정보를 찾을 수 없습니다.'); return; }
            
            const originalFullAddress = item.baseAddress + (item.detailAddress ? `, ${item.detailAddress}` : '');
            
            originalAddressDisplay.textContent = item.receiverAddressOriginal || '원본 주소 없음';
            piecesAddressInput.value = '';
            directAddressInput.value = originalFullAddress;
            setTimeout(() => {
                autoResizeTextarea({target: piecesAddressInput});
                autoResizeTextarea({target: directAddressInput});
            }, 0);

            const addressPiecesContainer = document.getElementById('address-pieces-container');
            const numberKeypad = document.getElementById('number-keypad');
            const unitKeypad = document.getElementById('unit-keypad');
            [addressPiecesContainer, numberKeypad, unitKeypad].forEach(c => c.innerHTML = '');
            
            const createKeyButton = (text, colorClass, value, action = 'add') => {
                const button = document.createElement('button');
                button.className = `key-button flex-shrink-0 font-semibold m-1 text-sm rounded-md py-1.5 flex items-center justify-center ${colorClass}`;
                button.dataset.value = value !== undefined ? value : text;
                button.dataset.action = action;
                
                const buttonText = document.createElement('span');
                buttonText.textContent = text;
                button.appendChild(buttonText);

                const keyPop = document.createElement('span');
                keyPop.className = 'key-pop';
                keyPop.textContent = text;
                button.appendChild(keyPop);

                return button;
            };

            const basePieces = (item.baseAddress || '').split(/[\s,]+/).filter(Boolean);
            basePieces.forEach(piece => addressPiecesContainer.appendChild(createKeyButton(piece, 'bg-blue-100 text-blue-800 hover:bg-blue-200 px-3 !py-1.5 rounded-full', undefined, 'add-space')));

            if (item.detailAddress) {
                addressPiecesContainer.appendChild(createKeyButton(',', 'bg-gray-200 text-gray-800 hover:bg-gray-300 px-3 !py-1.5 rounded-full', undefined, 'add-comma'));
                const detailPieces = (item.detailAddress || '').split(/[\s,]+/).filter(Boolean);
                detailPieces.forEach(piece => addressPiecesContainer.appendChild(createKeyButton(piece, 'bg-green-100 text-green-800 hover:bg-green-200 px-3 !py-1.5 rounded-full', undefined, 'add-space')));
            }

            // Number Keypad
            ['1', '2', '3', '4', '5', '6', '7', '8', '9', ',', '0', '-'].forEach(key => {
                let action = 'add';
                let colorClass = 'bg-gray-200 hover:bg-gray-300';
                if (['1', '2', '3', '4', '5', '6', '7', '8', '9', '0'].includes(key)) {
                    colorClass = 'bg-green-100 text-green-800 hover:bg-green-200';
                }
                if (key === ',') action = 'add-comma';
                if (key === '-') action = 'add-hyphen';
                numberKeypad.appendChild(createKeyButton(key, colorClass, key, action));
            });

            // Unit Keypad
            unitKeypad.appendChild(createKeyButton('길', 'bg-blue-100 hover:bg-blue-200', '길', 'add-unit'));
            unitKeypad.appendChild(createKeyButton('번길', 'bg-blue-100 hover:bg-blue-200', '번길', 'add-unit'));
            unitKeypad.appendChild(createKeyButton('동', 'bg-blue-100 hover:bg-blue-200', '동', 'add-unit'));
            unitKeypad.appendChild(createKeyButton('리', 'bg-blue-100 hover:bg-blue-200', '리', 'add-unit'));
            unitKeypad.appendChild(createKeyButton('\u00A0', 'bg-gray-200 hover:bg-gray-300', ' ', 'add')); // 공백
            unitKeypad.appendChild(createKeyButton('<', 'bg-gray-400 hover:bg-gray-500 text-white', '<', 'backspace-char'));
            const backspaceWordBtn = createKeyButton('<<', 'bg-red-500 hover:bg-red-600 text-white', '<<', 'backspace-word');
            backspaceWordBtn.classList.add('col-span-2');
            unitKeypad.appendChild(backspaceWordBtn);

            smartEditModal.style.display = 'flex';
            history.pushState({ smartEditModalOpen: true }, "");
        };

        const closeSmartEditModal = () => {
            if (history.state && history.state.smartEditModalOpen) {
                history.back();
            }
            smartEditModal.style.display = 'none';
            currentEditItemNo = null;
        };
        
        smartEditModal.addEventListener('click', (event) => {
            const button = event.target.closest('.key-button');
            if (!button) return;

            triggerHapticFeedback();

            const action = button.dataset.action;
            const value = button.dataset.value;
            const input = piecesAddressInput;
            let currentValue = input.value;
            
            switch (action) {
                case 'add':
                    input.value += value;
                    break;
                case 'add-space':
                    input.value += (currentValue.length > 0 && !/\s$/.test(currentValue) ? ' ' : '') + value;
                    break;
                case 'add-unit':
                    input.value += value + ' ';
                    break;
                case 'add-comma':
                    input.value += (currentValue.length > 0 && !/\s$/.test(currentValue) ? '' : '') + ', ';
                    break;
                case 'add-hyphen':
                    input.value += '-';
                    break;
                case 'backspace-char':
                    input.value = currentValue.slice(0, -1);
                    break;
                case 'backspace-word':
                    const lastSpaceIndex = currentValue.trimEnd().lastIndexOf(' ');
                    if (lastSpaceIndex > -1) {
                        input.value = currentValue.substring(0, lastSpaceIndex).trimEnd();
                    } else {
                        input.value = '';
                    }
                    break;
            }
            autoResizeTextarea({ target: input });
        });

        const applyAddressEdit = (fullAddress) => {
             if (currentEditItemNo === null) return;
            const itemIndex = deliveryItems.findIndex(item => item.no === currentEditItemNo);
            if (itemIndex > -1) {
                const commaIndex = fullAddress.indexOf(',');
                if (commaIndex > -1) {
                    deliveryItems[itemIndex].baseAddress = fullAddress.substring(0, commaIndex).trim();
                    deliveryItems[itemIndex].detailAddress = fullAddress.substring(commaIndex + 1).trim();
                } else {
                    deliveryItems[itemIndex].baseAddress = fullAddress;
                    deliveryItems[itemIndex].detailAddress = '';
                }
                deliveryItems[itemIndex].addressLocation = null;
                saveDeliveryItemsToLocalStorage();
                renderDeliveryCards(activeFilter); 
                showToastMessage('주소가 성공적으로 변경되었습니다.');
                closeSmartEditModal();
            }
        };
        
        applyPiecesBtn.addEventListener('click', () => applyAddressEdit(piecesAddressInput.value.trim()));
        applyDirectBtn.addEventListener('click', () => applyAddressEdit(directAddressInput.value.trim()));
        
        resetPiecesBtn.addEventListener('click', () => {
            piecesAddressInput.value = '';
            autoResizeTextarea({target: piecesAddressInput});
        });
        
        revertDirectBtn.addEventListener('click', () => {
            const item = deliveryItems.find(i => i.no === currentEditItemNo);
            if(item) {
                directAddressInput.value = item.baseAddress + (item.detailAddress ? `, ${item.detailAddress}` : '');
                autoResizeTextarea({target: directAddressInput});
            }
        });
        
        smartEditExitBtn.addEventListener('click', closeSmartEditModal);

        piecesAddressInput.addEventListener('input', autoResizeTextarea);
        directAddressInput.addEventListener('input', autoResizeTextarea);
        
        confirmOkButton.addEventListener('click', () => { if (onConfirmCallback) onConfirmCallback(); closeConfirmationModal(); });
        confirmCancelButton.addEventListener('click', closeConfirmationModal);
        clearSignatureBtn.addEventListener('click', () => signatureTextInput.value = '');
        cancelSignatureBtn.addEventListener('click', closeSignatureModal);
        saveSignatureBtn.addEventListener('click', saveSignature);

        const saveDeliveryItemsToLocalStorage = () => {
            localStorage.setItem('deliveryItems', JSON.stringify(deliveryItems));
            localStorage.setItem('filterScrollPositions', JSON.stringify(filterScrollPositions));
        };
        const handleStatusChange = (itemNo, newStatus, completionTime = null, completionType = null, completionDetail = null) => {
            deliveryItems = deliveryItems.map(item => {
                if (item.no === itemNo) {
                    const updatedItem = { ...item, status: newStatus, deliveryCompletionTime: completionTime, completionType, completionDetail };
                    if (newStatus !== '배송전') {
                        updatedItem.isHawbConfirmed = true;
                        const hawbNos = item.hawbNo.split('\n').filter(Boolean);
                        updatedItem.confirmedHawbNos = hawbNos;
                    } else {
                        updatedItem.isHawbConfirmed = false;
                        updatedItem.confirmedHawbNos = [];
                    }
                    return updatedItem;
                }
                return item;
            });
            saveDeliveryItemsToLocalStorage();
            renderDeliveryCards(activeFilter);
            updateFilterCounts();
        };

        const handleCheckboxToggleAndResetSearch = async (itemNo, checkboxElement) => {
            const itemIndex = deliveryItems.findIndex(item => item.no === itemNo);
            if (itemIndex === -1) return;

            const item = deliveryItems[itemIndex];
            const allHawbNos = item.hawbNo.split('\n').filter(Boolean);
            const isMultiBox = allHawbNos.length > 1;

            // Ensure confirmedHawbNos is an array
            if (!Array.isArray(item.confirmedHawbNos)) {
                item.confirmedHawbNos = [];
            }

            // Update confirmed list based on checkbox action
            const hawbValue = checkboxElement.dataset.hawb;
            if (checkboxElement.checked) {
                if (!item.confirmedHawbNos.includes(hawbValue)) {
                    item.confirmedHawbNos.push(hawbValue);
                }
            } else {
                item.confirmedHawbNos = item.confirmedHawbNos.filter(h => h !== hawbValue);
            }

            const allChecked = item.confirmedHawbNos.length === allHawbNos.length;
            item.isHawbConfirmed = allChecked;

            if (allChecked) {
                if (item.status === '배송전') {
                    const cardElement = checkboxElement.closest(`[data-no="${item.no}"]`);
                    const allCheckboxes = cardElement.querySelectorAll('input[data-action="toggle-hawb-confirm"]');
                    allCheckboxes.forEach(cb => cb.disabled = true);
                    
                    if (item.addressLocation) {
                        showToastMessage('이미 좌표가 저장되어 있습니다.');
                    } else {
                        showLoadingMessage('주소 좌표 확인 중...');
                        try {
                            const coords = await getCoordsFromAddress(item.baseAddress);
                            item.addressLocation = coords;
                            closeConfirmationModal();
                            showToastMessage('주소 좌표 저장 완료!');
                        } catch (error) {
                            console.error("체크인 실패 (주소 좌표 획득 오류):", error.message);
                            closeConfirmationModal();
                            showMessage(`주소 좌표를 가져올 수 없습니다: ${error.message}\n주소를 확인하고 다시 시도해주세요.`, '오류');
                            // Revert state on failure
                            item.confirmedHawbNos = [];
                            item.isHawbConfirmed = false;
                            saveDeliveryItemsToLocalStorage();
                            renderDeliveryCards(activeFilter);
                            return;
                        }
                    }
                    
                    item.status = '배송중';
                    saveDeliveryItemsToLocalStorage();
                    searchTerm = '';
                    invoiceNumberInput.value = '';
                    renderDeliveryCards(activeFilter);
                    updateFilterCounts();
                }
            } else { // Not all boxes are checked
                if (item.status === '배송중') {
                    item.status = '배송전';
                    saveDeliveryItemsToLocalStorage();
                    searchTerm = '';
                    invoiceNumberInput.value = '';
                    renderDeliveryCards(activeFilter);
                    updateFilterCounts();
                    showToastMessage('체크인이 취소되었습니다.');
                }
            }
            // Always save the intermediate state
            saveDeliveryItemsToLocalStorage();
        };
        
        const openNaverMap = (item) => {
            const addressForMapSearch = item.baseAddress || '';
            const textToCopy = `${item.no}. ${extractClipboardAddressPart(item)}`;
            const textarea = document.createElement('textarea');
            textarea.value = textToCopy;
            textarea.style.position = 'fixed';
            textarea.style.opacity = 0;
            document.body.appendChild(textarea);
            textarea.focus();
            textarea.select();
            try {
                document.execCommand('copy');
            } catch (err) {
                console.error('클립보드 복사 실패:', err);
                showMessage('클립보드 복사에 실패했습니다.', '복사 실패');
            }
            document.body.removeChild(textarea);
            window.location.href = `nmap://search?query=${encodeURIComponent(addressForMapSearch)}&appname=DeliveryApp`;
        };

        const highlightHawbNo = (hawbNo, term) => {
            if (!hawbNo) return '';
            const formattedHawbNo = hawbNo.replace(/\n/g, '<br>'); // Handle multiline for display
            if (!term || !formattedHawbNo.toLowerCase().includes(term.toLowerCase())) return formattedHawbNo;
            const escapedTerm = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const regex = new RegExp(`(${escapedTerm})`, 'gi');
            return formattedHawbNo.replace(regex, `<span class="bg-yellow-200 rounded px-0.5">$1</span>`);
        };
        
        // --- Render function ---
        const renderDeliveryCards = (currentFilter, animationClass = '') => {
            if (currentFilter === '배송준비') { deliveryCardsContainer.innerHTML = ''; return; }

            let baseData = [];
            if (currentFilter !== '전체') {
                baseData = deliveryItems.filter(item => item.status === currentFilter);
            } else {
                baseData = [...deliveryItems];
            }

            let dataToRender = [];
            if (searchTerm) {
                const cleanedSearchTerm = searchTerm.trim().replace(/[\s-]/g, '').toLowerCase();
                dataToRender = baseData.filter(item => 
                    item.hawbNo?.replace(/[\s-\n]/g, '').toLowerCase().includes(cleanedSearchTerm)
                );
            } else {
                dataToRender = baseData;
            }
            
            if (dataToRender.length === 0) {
                deliveryCardsContainer.innerHTML = '<p class="text-center text-gray-600 px-4">해당하는 항목이 없습니다.</p>';
                return;
            }

            deliveryCardsContainer.innerHTML = dataToRender.map(data => {
                const fullAddress = data.baseAddress + (data.detailAddress ? `, ${data.detailAddress}` : '');
                const isMapButtonActive = isValidAddressForMap(data.baseAddress) && ['전체', '배송전'].includes(currentFilter);
                const distanceInfo = (currentSortOrder === 'distance' && data.distanceFromMe !== undefined)
                    ? `<span class="block text-sm font-medium text-purple-600 -mt-1">(${data.distanceFromMe.toFixed(2)} km)</span>`
                    : '';
                
                let cardBg = 'bg-white';
                if (data.status === '배송중') {
                    cardBg = 'bg-blue-100';
                } else if (data.status === '완료') {
                    cardBg = 'bg-gray-200';
                }

                const showCompletedCard = !['전체', '배송전', '배송중'].includes(currentFilter) && data.status === '완료';
                const showInProgressButtons = !['전체', '배송전', '완료'].includes(currentFilter) && data.status === '배송중';

                const carrierBadge = data.carrier === 'UPS' 
                    ? `<span class="text-xs font-bold text-yellow-700 bg-yellow-300 px-2 py-1 rounded-full">UPS</span>`
                    : `<span class="text-xs font-bold text-red-700 bg-red-200 px-2 py-1 rounded-full">SF</span>`;

                const hawbNos = (data.hawbNo || '').split('\n').filter(Boolean);
                const confirmedHawbNos = data.confirmedHawbNos || [];
                
                const hawbHtml = hawbNos.map(hawb => `
                    <div class="flex items-center justify-between w-full">
                        <span class="text-base font-bold text-gray-600 whitespace-nowrap">${highlightHawbNo(formatHawbNoForDisplay(hawb, data.carrier), searchTerm)}</span>
                        <input type="checkbox" data-action="toggle-hawb-confirm" data-no="${data.no}" data-hawb="${hawb}" ${confirmedHawbNos.includes(hawb) ? 'checked' : ''} class="form-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded ml-2"/>
                    </div>
                `).join('');

                const detailsHtml = `
                    <div class="flex items-start space-x-2.5">
                        <button data-action="open-naver-map" data-no="${data.no}" class="flex-shrink-0 pt-1 ${isMapButtonActive ? 'text-gray-600 hover:text-black' : 'text-gray-400 cursor-not-allowed'}" ${isMapButtonActive ? '' : 'disabled'}>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 22a1 1 0 0 1-1-1v-4a1 1 0 0 1 .445-.832l3-2a1 1 0 0 1 1.11 0l3 2A1 1 0 0 1 22 17v4a1 1 0 0 1-1 1z"/><path d="M18 10a8 8 0 0 0-16 0c0 4.993 5.539 10.193 7.399 11.799a1 1 0 0 0 .601.2"/><path d="M18 22v-3"/><circle cx="10" cy="10" r="3"/></svg>
                        </button>
                        <div>
                            <p class="text-base text-blue-600 font-semibold cursor-pointer" data-action="open-smart-edit" data-no="${data.no}">${fullAddress}</p>
                            ${data.receiverAddressOriginal ? `<p class="text-xs text-gray-500">(${data.receiverAddressOriginal})</p>` : ''}
                        </div>
                    </div>
                    <div class="flex items-start space-x-2.5">
                        <div class="flex-shrink-0 pt-1 text-gray-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z"/><path d="M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2"/><path d="M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2"/><path d="M10 6h4"/><path d="M10 10h4"/><path d="M10 14h4"/><path d="M10 18h4"/></svg>
                        </div>
                        <div>
                            <p class="text-base text-blue-600 font-semibold">${data.companyNameKorean || 'N/A'}</p>
                            ${data.companyNameOriginal && data.companyNameOriginal !== data.companyNameKorean ? `<p class="text-xs text-gray-500">(${data.companyNameOriginal})</p>` : ''}
                        </div>
                    </div>
                    <div class="flex items-start space-x-2.5">
                        <div class="flex-shrink-0 pt-1 text-gray-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><path d="M16 3.128a4 4 0 0 1 0 7.744"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><circle cx="9" cy="7" r="4"/></svg>
                        </div>
                        <div>
                            <p class="text-base text-blue-600 font-semibold">${data.receiverNameKorean || 'N/A'}</p>
                            ${data.receiverNameOriginal && data.receiverNameOriginal !== data.receiverNameKorean ? `<p class="text-xs text-gray-500">(${data.receiverNameOriginal})</p>` : ''}
                        </div>
                    </div>
                    <div class="flex items-start space-x-2.5">
                        <div class="flex-shrink-0 pt-1 text-gray-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="20" x="5" y="2" rx="2" ry="2"/><path d="M12 18h.01"/></svg>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-base text-blue-600 font-semibold">${formatPhoneNumberForDisplay(data.receiverTelephoneNo)}</span>
                            <a href="tel:${getCleanPhoneNumber(data.receiverTelephoneNo)}" class="px-3 py-1.5 rounded-full bg-transparent text-orange-500 border border-orange-500 text-sm font-medium hover:bg-orange-100">전화</a>
                            <a href="sms:${getCleanPhoneNumber(data.receiverTelephoneNo)}" class="px-3 py-1.5 rounded-full bg-transparent text-blue-500 border border-blue-500 text-sm font-medium hover:bg-blue-100">문자</a>
                        </div>
                    </div>
                    ${data.status === '완료' ? `<div class="mt-4 pt-4 border-t border-gray-200 flex justify-center"><button data-action="revert-delivery" data-no="${data.no}" class="px-4 py-2 rounded-md bg-red-500 text-white text-sm font-medium">되돌리기</button></div>` : ''}
                `;

                if (showCompletedCard) {
                    return `
                        <div class="bg-gray-200 rounded-lg shadow-lg p-4 mb-4 border border-gray-200" data-no="${data.no}">
                            <div class="flex justify-between items-center">
                                <div class="text-xl font-semibold text-gray-700 text-left">
                                    <span class="text-red-500 text-2xl mr-4">${data.no}</span>
                                    ${data.completionType === '서명' && data.completionDetail ? `<span class="text-lg font-semibold text-gray-800 p-1 border border-dashed border-gray-400 rounded-md bg-gray-50 inline-block">${data.completionDetail}</span>` : data.completionType === '본인확인' ? `${data.completionType} (${data.completionDetail})` : `${data.completionType || ''}`}
                                    <span class="ml-2">${formatCompletionTime(data.deliveryCompletionTime)}</span>
                                </div>
                                <button data-action="toggle-details" data-no="${data.no}" class="p-2 rounded-full hover:bg-gray-300/50">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                                    </svg>
                                </button>
                            </div>
                            <div class="space-y-3 mt-4 pt-4 border-t border-gray-300" data-details-container="${data.no}" style="display:none;">
                                ${detailsHtml}
                            </div>
                        </div>
                    `;
                } else {
                    return `
                        <div class="${cardBg} rounded-lg shadow-lg p-6 mb-4 border border-gray-200" data-no="${data.no}">
                            <div class="flex justify-between items-start mb-4 pb-2 border-b border-gray-200">
                                <div class="flex justify-between items-start w-full">
                                    <div class="flex items-start space-x-4">
                                        <div>
                                            <h3 class="text-3xl font-semibold text-red-500">${data.no}</h3>
                                            ${distanceInfo}
                                        </div>
                                        <div class="pt-1.5 flex flex-col space-y-1">
                                            ${hawbHtml}
                                        </div>
                                    </div>
                                    <div class="pt-1.5">
                                        ${carrierBadge}
                                    </div>
                                </div>
                            </div>
                            <div class="space-y-3" data-details-container="${data.no}">
                                ${detailsHtml}
                            </div>
                            ${showInProgressButtons ? `<div class="mt-4 pt-4 border-t border-gray-200 flex justify-start space-x-2 w-10/12"><button data-action="identity-verification" data-no="${data.no}" class="flex-1 px-3 py-1.5 rounded-md bg-green-600 text-white text-sm font-medium">본인확인</button><button data-action="front-door-delivery" data-no="${data.no}" class="flex-1 px-3 py-1.5 rounded-md bg-purple-600 text-white text-sm font-medium">문앞배송</button><button data-action="sign-delivery" data-no="${data.no}" class="flex-1 px-3 py-1.5 rounded-md bg-indigo-600 text-white text-sm font-medium">서명</button></div>` : ''}
                        </div>
                    `;
                }
            }).join('');
        
            if (animationClass) {
                deliveryCardsContainer.classList.remove('animate-slide-in-left', 'animate-slide-in-right');
                void deliveryCardsContainer.offsetWidth; // Reflow to restart animation
                deliveryCardsContainer.classList.add(animationClass);
            }
        };

    // --- UI Update & Event Listener Setup ---
    const updateFilterCounts = () => {
        document.getElementById('count-전체').textContent = deliveryItems.length;
        document.getElementById('count-배송전').textContent = deliveryItems.filter(item => item.status === '배송전').length;
        document.getElementById('count-배송중').textContent = deliveryItems.filter(item => item.status === '배송중').length;
        document.getElementById('count-완료').textContent = deliveryItems.filter(item => item.status === '완료').length;
    };
    
    const updateStickyHeaderPositions = () => {
        requestAnimationFrame(() => {
            const topOffset = filterButtonsContainer.offsetHeight;
            document.body.style.paddingTop = `${topOffset}px`;
            document.documentElement.style.scrollPaddingTop = `${topOffset}px`;

            const isScanVisible = activeFilter === '배송준비';
            scanSectionContainer.classList.toggle('hidden', !isScanVisible);
            dataManagementContainer.classList.toggle('hidden', !isScanVisible);
            versionInfoContainer.classList.toggle('hidden', !isScanVisible); 

            const isSearchVisible = ['전체', '배송전'].includes(activeFilter);
            searchBarContainer.style.display = isSearchVisible ? 'block' : 'none';
            
            const isActionVisible = ['배송중', '완료'].includes(activeFilter);
            actionBarContainer.style.display = isActionVisible ? 'block' : 'none';

            if (isActionVisible) {
                actionButtons.innerHTML = ''; // Clear previous buttons
                const menuItems = [];
                let buttonClass = '';

                if (activeFilter === '배송중') {
                    buttonClass = 'flex-1 flex items-center justify-center space-x-2 px-4 py-2 bg-blue-100 text-blue-700 border border-blue-700 rounded-md hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50';
                    menuItems.push({ icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="2" x2="5" y1="12" y2="12"/><line x1="19" x2="22" y1="12" y2="12"/><line x1="12" x2="12" y1="2" y2="5"/><line x1="12" x2="12" y1="19" y2="22"/><circle cx="12" cy="12" r="7"/></svg>`, text: '거리', action: 'sort-distance' });
                    menuItems.push({ icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 16 4 4 4-4"/><path d="M7 20V4"/><rect x="15" y="4" width="4" height="6" ry="2"/><path d="M17 20v-6h-2"/><path d="M15 20h4"/></svg>`, text: '순번', action: 'sort-no' });
                    menuItems.push({ icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 12h11"/><path d="M10 18h11"/><path d="M10 6h11"/><path d="M4 10h2"/><path d="M4 6h1v4"/><path d="M6 18H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg>`, text: '선택', action: 'jump-no' });
                } else if (activeFilter === '완료') {
                    buttonClass = 'flex-1 flex items-center justify-center space-x-2 px-4 py-2 bg-gray-200 text-black border border-black rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50';
                    menuItems.push({ icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 16 4 4 4-4"/><path d="M7 20V4"/><rect x="15" y="4" width="4" height="6" ry="2"/><path d="M17 20v-6h-2"/><path d="M15 20h4"/></svg>`, text: '순번', action: 'sort-no-completed' });
                    menuItems.push({ icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 6v6l4 2"/><circle cx="12" cy="12" r="10"/></svg>`, text: '완료시간', action: 'sort-time' });
                }

                menuItems.forEach(item => {
                    const button = document.createElement('button');
                    button.className = buttonClass;
                    button.innerHTML = `${item.icon}<span class="font-semibold">${item.text}</span>`;
                    button.dataset.action = item.action;
                    actionButtons.appendChild(button);
                });
            }
        });
    };
    
    const changeFilter = (newFilter, animationClass = '', isInitialLoad = false) => {
        if (newFilter === activeFilter && !isInitialLoad) return;

        if (!isInitialLoad) {
            searchTerm = '';
            invoiceNumberInput.value = '';
        }

        filterScrollPositions[activeFilter] = window.scrollY;
        activeFilter = newFilter;

        filterButtonsContainer.querySelectorAll('button[data-filter]').forEach(btn => {
            const isActive = btn.dataset.filter === activeFilter;
            btn.classList.remove('bg-blue-500', 'text-white', 'shadow', 'bg-transparent', 'text-gray-700', 'border', 'border-gray-300', 'hover:bg-gray-100');
            if (isActive) {
                btn.classList.add('bg-blue-500', 'text-white', 'shadow');
            } else {
                btn.classList.add('bg-transparent', 'text-gray-700', 'border', 'border-gray-300', 'hover:bg-gray-100');
            }
        });
        
        if (['배송중', '완료', '전체'].includes(activeFilter)) {
            currentSortOrder = 'no';
            deliveryItems.sort((a, b) => a.no - b.no);
        }

        renderDeliveryCards(activeFilter, animationClass);
        updateStickyHeaderPositions();
        const button = filterButtonsContainer.querySelector(`button[data-filter="${activeFilter}"]`);
        if (button) button.scrollIntoView({ behavior: 'smooth', inline: 'center' });
        setTimeout(() => window.scrollTo({ top: filterScrollPositions[activeFilter] || 0, behavior: 'auto' }), 0);
    };

    filterButtonsContainer.addEventListener('click', (event) => {
        const button = event.target.closest('button[data-filter]');
        if (!button) return;
        const newFilter = button.dataset.filter;
        
        const oldIndex = filterCategories.indexOf(activeFilter);
        const newIndex = filterCategories.indexOf(newFilter);
        const animation = newIndex > oldIndex ? 'animate-slide-in-right' : 'animate-slide-in-left';

        changeFilter(newFilter, animation);
    });

    searchButton.addEventListener('click', () => { searchTerm = invoiceNumberInput.value.trim(); renderDeliveryCards(activeFilter); window.scrollTo({ top: 0, behavior: 'auto' }); filterScrollPositions[activeFilter] = 0; });
    resetButton.addEventListener('click', () => { filterScrollPositions[activeFilter] = window.scrollY; searchTerm = ''; invoiceNumberInput.value = ''; renderDeliveryCards(activeFilter); setTimeout(() => window.scrollTo({ top: filterScrollPositions[activeFilter] || 0, behavior: 'auto' }), 0); });
    invoiceNumberInput.addEventListener('input', (event) => { searchTerm = event.target.value.trim(); renderDeliveryCards(activeFilter); window.scrollTo({ top: 0, behavior: 'auto' }); filterScrollPositions[activeFilter] = 0; });

    deliverySheetImageInput.addEventListener('change', (event) => {
        currentFileToScan = event.target.files;
        selectedFilesDisplay.textContent = currentFileToScan.length > 0 ? `선택된 파일: ${Array.from(currentFileToScan).map(f => f.name).join(', ')}` : '선택된 파일 없음';
    });
    
    clearAllCardsButton.addEventListener('click', () => {
        openConfirmationModal("모든 카드를 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.", () => {
            deliveryItems = [];
            saveDeliveryItemsToLocalStorage();
            renderDeliveryCards(activeFilter);
            updateFilterCounts();
            showToastMessage("모든 카드가 삭제되었습니다.");
        });
    });

    async function performScan(filesToScan) {
        const CONCURRENT_LIMIT = 4;
        const totalFiles = filesToScan.length;
        let completedCount = 0;

        scanProgressText.textContent = `이미지 리사이징 중 (0/${totalFiles})...`;
        const resizePromises = filesToScan.map((file, index) => 
            resizeImage(file).then(resizedObject => {
                scanProgressText.textContent = `이미지 리사이징 중 (${index + 1}/${totalFiles})...`;
                return resizedObject;
            })
        );
        const resizedImageObjects = await Promise.all(resizePromises);
        scanProgressText.textContent = `리사이징 완료, API 요청 시작...`;
        
        let pageResults = [];
        const failedFileObjectsForRetry = [];
        const requestQueue = [...resizedImageObjects]; 

        const updateApiProgress = () => {
            completedCount++;
            scanProgressText.textContent = `API 처리 중 (${completedCount}/${totalFiles})...`;
        };

        const processApiRequest = async (resizedObject) => {
            const { file, data: base64ImageData } = resizedObject;
            let lastError = null;

            for (let attempt = 1; attempt <= 3; attempt++) {
                try {
                    const payload = {
                        contents: [{ role: "user", parts: [{ text: GEMINI_PROMPT }, { inlineData: { mimeType: 'image/jpeg', data: base64ImageData } }] }],
                        generationConfig: { temperature: 0, responseMimeType: "application/json" }
                    };
                    const tempApiKeyForLocalTest = "AIzaSyCNYPhrVzBC-wQoZU3ftYEznfUZv3vZEFs";
                    const directApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${tempApiKeyForLocalTest}`;

                    const response = await fetch(directApiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) { throw new Error(`API 요청 실패 (상태: ${response.status})`); }
                    
                    const result = await response.json();

                    if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                        const parsedData = JSON.parse(result.candidates[0].content.parts[0].text);
                        return parsedData;
                    }
                    throw new Error("AI가 유효한 JSON 형식으로 응답하지 않았습니다.");
                } catch (error) {
                    lastError = error;
                    console.warn(`파일(${file.name}) 처리 시도 ${attempt} 실패:`, error);
                    if (attempt < 3) {
                        await new Promise(resolve => setTimeout(resolve, 200));
                    }
                }
            }
            throw lastError;
        };
        
        const worker = async () => {
            while (requestQueue.length > 0) {
                const requestObject = requestQueue.shift(); 
                if (requestObject) {
                    try {
                        const apiResult = await processApiRequest(requestObject);
                        pageResults.push(apiResult);
                    } catch (error) {
                        console.error(`파일 스캔 오류 (${requestObject.file.name}):`, error);
                        failedFileObjectsForRetry.push(requestObject.file);
                    } finally {
                        updateApiProgress();
                    }
                }
            }
        };

        const workerPromises = Array.from({ length: CONCURRENT_LIMIT }, () => worker());
        await Promise.all(workerPromises);

        pageResults.sort((a, b) => (a.pageNo || 9999) - (b.pageNo || 9999));

        let rawItems = [];
        for (const result of pageResults) {
            if (result.carrier === 'UPS') {
                const { trackingNumbers = [], companyNames = [], receiverNames = [], addresses = [], phoneNumbers = [] } = result;
                const lengths = [trackingNumbers.length, companyNames.length, receiverNames.length, addresses.length, phoneNumbers.length];
                const allLengthsEqual = lengths.every(len => len === lengths[0]);

                if (!allLengthsEqual) {
                    console.warn(`[Page ${result.pageNo}] 데이터 배열 길이가 일치하지 않아 해당 페이지를 건너뜁니다.`, lengths);
                    showToastMessage(`페이지 ${result.pageNo} 데이터가 불완전하여 건너뜁니다.`);
                    continue;
                }

                for (let i = 0; i < lengths[0]; i++) {
                    rawItems.push({
                        carrier: 'UPS',
                        hawbNo: trackingNumbers[i],
                        receiverCompanyName: companyNames[i],
                        receiverName: receiverNames[i],
                        receiverAddress: addresses[i],
                        receiverPhone: phoneNumbers[i],
                        // AI가 번역/분리한 데이터를 그대로 사용
                        receiverCompanyNameKorean: companyNames[i], // 임시
                        receiverNameKorean: receiverNames[i], // 임시
                        baseAddressKorean: addresses[i], // 임시
                        detailAddressKorean: '' // 임시
                    });
                }
            } else if (Array.isArray(result)) { // SF Express
                rawItems.push(...result);
            }
        }

        const processAndTranslateItem = async (item, index) => {
            const { baseAddressKorean, detailAddressKorean } = await validateAddressWithKakao(item.baseAddressKorean, item.detailAddressKorean);
            return {
                no: index + 1,
                carrier: item.carrier || 'SF',
                hawbNo: item.hawbNo || '',
                baseAddress: baseAddressKorean,
                detailAddress: detailAddressKorean,
                receiverAddressOriginal: item.receiverAddress || '',
                companyNameOriginal: item.receiverCompanyName || '',
                receiverNameOriginal: item.receiverName || '',
                companyNameKorean: item.receiverCompanyNameKorean || item.receiverCompanyName || '',
                receiverNameKorean: item.receiverNameKorean || item.receiverName || '',
                receiverTelephoneNo: item.receiverPhone ? getCleanPhoneNumber(item.receiverPhone) : '',
                status: '배송전', isHawbConfirmed: false,
                deliveryCompletionTime: null, completionType: null, completionDetail: null,
                addressLocation: null,
                confirmedHawbNos: []
            };
        };

        if (rawItems.length > 0) {
            const finalItemsPromises = rawItems.map(processAndTranslateItem);
            deliveryItems = await Promise.all(finalItemsPromises);
            saveDeliveryItemsToLocalStorage();
        }
        
        return { newCount: deliveryItems.length, updateCount: 0, failedFiles: failedFileObjectsForRetry };
    }
    
    scanAndGenerateButton.addEventListener('click', async () => {
        if (!currentFileToScan || currentFileToScan.length === 0) { showMessage('스캔할 이미지를 선택해주세요.'); return; }
        
        const startTime = Date.now();
        scanLoadingIndicator.style.display = 'block';
        scanErrorMessage.style.display = 'none';
        failedFileObjects = []; 

        try {
            const initialFiles = Array.from(currentFileToScan);
            const result = await performScan(initialFiles);
            const endTime = Date.now();
            const elapsedTime = Math.round((endTime - startTime) / 1000);
            const minutes = Math.floor(elapsedTime / 60);
            const seconds = elapsedTime % 60;
            const timeString = `(소요 시간: ${minutes}분 ${seconds}초)`;

            if (result.failedFiles.length === 0) {
                showMessage(`${result.newCount}개의 카드가 새로 생성되었습니다. ${timeString}`);
            } else {
                failedFileObjects = result.failedFiles;
                const successCount = initialFiles.length - failedFileObjects.length;
                const failedFileNames = failedFileObjects.map(f => f.name);
                
                const message = `총 ${initialFiles.length}개 중 ${successCount}개 파일 스캔 성공. ${timeString}\n\n실패한 ${failedFileObjects.length}개 파일을 다시 스캔하시겠습니까?\n- ${failedFileNames.join('\n- ')}`;

                const onRetry = async () => {
                    scanLoadingIndicator.style.display = 'block';
                    
                    const retryResult = await performScan(failedFileObjects);

                    scanLoadingIndicator.style.display = 'none';

                    if (retryResult.failedFiles.length === 0) {
                        showMessage(`재시도 성공: ${retryResult.newCount}개의 카드가 추가/업데이트되었습니다.`);
                    } else {
                        const stillFailingNames = retryResult.failedFiles.map(f => f.name);
                        showMessage(`재시도 후에도 아래 ${stillFailingNames.length}개 파일이 실패했습니다.\n- ${stillFailingNames.join('\n- ')}`, '재시도 일부 실패');
                    }
                    renderDeliveryCards(activeFilter);
                    updateFilterCounts();
                };
                openConfirmationModal(message, onRetry, '실패 파일 재시도', '나중에');
            }
        } catch (error) {
            console.error("전체 스캔 프로세스 오류:", error);
            scanErrorText.textContent = error.message;
            scanErrorMessage.style.display = 'block';
        } finally {
            scanLoadingIndicator.style.display = 'none';
            deliverySheetImageInput.value = '';
            currentFileToScan = null;
            selectedFilesDisplay.textContent = '선택된 파일 없음';
            renderDeliveryCards(activeFilter);
            updateFilterCounts();
            updateStickyHeaderPositions();
        }
    });
    
    exportDataButton.addEventListener('click', () => {
        if (deliveryItems.length === 0) { showMessage("저장할 데이터가 없습니다."); return; }
        try {
            const today = new Date();
            const formattedDate = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            const fileName = `DeliveryData-${formattedDate}.json`;
            const dataStr = JSON.stringify(deliveryItems, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToastMessage(`데이터가 '${fileName}' 파일로 저장되었습니다.`);
        } catch (error) {
            showMessage(`데이터 저장 중 오류가 발생했습니다: ${error.message}`, "오류");
        }
    });

    importDataInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;

        openConfirmationModal( `'${file.name}' 파일의 데이터로 현재 목록을 모두 덮어씁니다. 계속하시겠습니까?`, () => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (!Array.isArray(importedData)) throw new Error("파일 형식이 올바르지 않습니다 (배열이 아님).");
                        
                        const firstItem = importedData[0];
                        if (importedData.length > 0 && typeof firstItem.no === 'undefined' && typeof firstItem.baseAddress === 'undefined') {
                           throw new Error("파일 내용이 올바른 배송 데이터 형식이 아닙니다.");
                        }
                        
                        deliveryItems = importedData;

                        saveDeliveryItemsToLocalStorage();
                        updateFilterCounts();
                        updateStickyHeaderPositions();
                        renderDeliveryCards(activeFilter);
                        showMessage(`'${file.name}' 파일에서 ${deliveryItems.length}개의 항목을 불러왔습니다.`);
                    } catch (error) {
                        showMessage(`파일을 불러오는 중 오류가 발생했습니다: ${error.message}`, "오류");
                    } finally {
                        importDataInput.value = '';
                    }
                };
                reader.onerror = () => { showMessage("파일을 읽는 데 실패했습니다.", "오류"); importDataInput.value = ''; };
                reader.readAsText(file);
            }
        );
    });

    document.addEventListener('DOMContentLoaded', () => {
        try {
            setVersionInfo();
            setupDelegatedEventListeners();

            // 키보드 '이동' 키로 검색 실행 및 키패드 숨기기
            invoiceNumberInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    searchButton.click();
                    invoiceNumberInput.blur();
                }
            });

            // --- 외부 스캐너 앱 연동 로직 ---
            setTimeout(() => {
                const urlParams = new URLSearchParams(window.location.search);
                const hawbFromUrl = urlParams.get('hawb');
                const filterFromUrl = urlParams.get('filter');

                let initialLoad = true;
                if (hawbFromUrl) {
                    searchTerm = hawbFromUrl;
                    invoiceNumberInput.value = hawbFromUrl;
                } else {
                    initialLoad = false;
                }

                if (filterFromUrl && filterCategories.includes(filterFromUrl)) {
                    changeFilter(filterFromUrl, '', initialLoad);
                } else {
                    changeFilter('배송준비', '', true);
                }
            }, 0);
            // ------------------------------------

            document.body.addEventListener('touchmove', (event) => {
                if (window.scrollY === 0 && touchStartY < event.touches[0].clientY && activeFilter !== '배송준비') {
                    event.preventDefault();
                }
            }, { passive: false });

            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') {
                    justReturnedFromExternalApp = true;
                    setTimeout(() => {
                        justReturnedFromExternalApp = false;
                    }, 500);
                }
            });

            history.pushState(null, '', location.href);
            window.addEventListener('popstate', (event) => {
                if (smartEditModal.style.display === 'flex') {
                    smartEditModal.style.display = 'none';
                    currentEditItemNo = null;
                    return;
                }

                if (justReturnedFromExternalApp) {
                    return;
                }

                if (backButtonPressedOnce) {
                    history.back();
                    return;
                }

                backButtonPressedOnce = true;
                showToastMessage('한 번 더 누르면 종료됩니다.', 2000);
                setTimeout(() => {
                    backButtonPressedOnce = false;
                }, 2000);

                history.pushState(null, '', location.href);
            });

            document.body.addEventListener('touchstart', (event) => {
                const touch = event.touches[0];
                touchStartX = touch.clientX;
                touchStartY = touch.clientY;
                touchStartTime = Date.now();
            }, { passive: true });

            document.body.addEventListener('touchend', (event) => {
                if (signatureModal.style.display === 'flex' ||
                    confirmationModal.style.display === 'flex' ||
                    smartEditModal.style.display === 'flex' ||
                    numberJumpModal.style.display === 'flex') {
                    return;
                }

                const touch = event.changedTouches[0];
                const touchEndX = touch.clientX;
                const touchEndY = touch.clientY;

                const diffX = touchEndX - touchStartX;
                const diffY = touchEndY - touchStartY;
                const duration = Date.now() - touchStartTime;

                if (duration > 500 || Math.abs(diffX) < 75 || Math.abs(diffX) < Math.abs(diffY) * 2) {
                    return;
                }

                const currentFilterIndex = filterCategories.indexOf(activeFilter);
                
                if (diffX > 0) {
                    if (currentFilterIndex > 0) {
                        const prevFilter = filterCategories[currentFilterIndex - 1];
                        changeFilter(prevFilter, 'animate-slide-in-left');
                    }
                } else {
                    if (currentFilterIndex < filterCategories.length - 1) {
                        const nextFilter = filterCategories[currentFilterIndex + 1];
                        changeFilter(nextFilter, 'animate-slide-in-right');
                    }
                }
            });

            actionBarContainer.addEventListener('click', async (event) => {
                const button = event.target.closest('button');
                if (!button) return;

                const action = button.dataset.action;

                switch (action) {
                    case 'sort-distance':
                        showLoadingMessage('현재 위치 확인 중...');
                        try {
                            const myLocation = await getCurrentLocation();
                            const inProgressItems = deliveryItems.filter(item => item.status === '배송중');
                            const otherItems = deliveryItems.filter(item => item.status !== '배송중');
                            const itemsWithCoords = inProgressItems.filter(item => item.addressLocation);
                            const itemsWithoutCoords = inProgressItems.filter(item => !item.addressLocation);
                            if (itemsWithoutCoords.length > 0) {
                                showToastMessage(`${itemsWithoutCoords.length}개의 카드에 좌표 정보가 없어 정렬에서 제외됩니다.`);
                            }
                            itemsWithCoords.forEach(item => {
                                item.distanceFromMe = calculateDistance(myLocation, item.addressLocation);
                            });
                            itemsWithCoords.sort((a, b) => a.distanceFromMe - b.distanceFromMe);
                            deliveryItems = [...itemsWithCoords, ...itemsWithoutCoords, ...otherItems];
                            currentSortOrder = 'distance';
                            renderDeliveryCards(activeFilter);
                            closeConfirmationModal();
                            showToastMessage('가까운 거리순으로 정렬되었습니다.');
                        } catch (error) {
                            closeConfirmationModal();
                            showMessage(`현재 위치를 가져올 수 없습니다: ${error.message}`, '오류');
                        }
                        break;
                    case 'sort-no':
                    case 'sort-no-completed':
                        currentSortOrder = 'no';
                        deliveryItems.sort((a, b) => a.no - b.no);
                        renderDeliveryCards(activeFilter);
                        showToastMessage('순번순으로 정렬되었습니다.');
                        break;
                    case 'jump-no':
                        numberJumpList.innerHTML = '';
                        if (deliveryItems.length === 0) {
                            numberJumpList.innerHTML = '<p class="text-gray-500 col-span-5 text-center">카드가 없습니다.</p>';
                            numberJumpModal.style.display = 'flex';
                            return;
                        }
                        const maxNo = Math.max(0, ...deliveryItems.map(item => item.no));
                        const itemsMap = new Map(deliveryItems.map(item => [item.no, item.status]));
                        for (let i = 1; i <= maxNo; i++) {
                            const status = itemsMap.get(i);
                            const btn = document.createElement('div');
                            btn.textContent = i;
                            if (status === '배송중') {
                                btn.className = 'number-jump-item active';
                                btn.dataset.no = i;
                                btn.onclick = () => {
                                    const targetCard = document.querySelector(`[data-no="${i}"]`);
                                    if (targetCard) {
                                        targetCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                    }
                                    numberJumpModal.style.display = 'none';
                                };
                            } else if (status) {
                                btn.className = 'number-jump-item inactive';
                            } else {
                                btn.className = 'number-jump-item placeholder';
                                btn.innerHTML = ' ';
                            }
                            numberJumpList.appendChild(btn);
                        }
                        numberJumpModal.style.display = 'flex';
                        break;
                    case 'sort-time':
                        currentSortOrder = 'time';
                        const completedItems = deliveryItems.filter(item => item.status === '완료');
                        const otherItems = deliveryItems.filter(item => item.status !== '완료');
                        completedItems.sort((a, b) => {
                            if (!a.deliveryCompletionTime) return 1;
                            if (!b.deliveryCompletionTime) return -1;
                            return a.deliveryCompletionTime.localeCompare(b.deliveryCompletionTime);
                        });
                        deliveryItems = [...completedItems, ...otherItems];
                        renderDeliveryCards(activeFilter);
                        showToastMessage('빠른 완료시간순으로 정렬되었습니다.');
                        break;
                }
            });
            numberJumpClose.addEventListener('click', () => {
                numberJumpModal.style.display = 'none';
            });

            // 스크롤 이벤트
            window.addEventListener('scroll', () => {
                const currentScrollY = window.scrollY;
                if (currentScrollY > lastScrollY) { // Scrolling down
                    searchBarContainer.classList.add('hidden');
                    actionBarContainer.classList.add('hidden');
                } else { // Scrolling up
                    searchBarContainer.classList.remove('hidden');
                    actionBarContainer.classList.remove('hidden');
                }
                lastScrollY = currentScrollY <= 0 ? 0 : currentScrollY;
            });

            const storedItems = localStorage.getItem('deliveryItems');
            if (storedItems) {
                let parsedItems = JSON.parse(storedItems);
                deliveryItems = parsedItems.map(item => {
                    // Ensure backward compatibility for items stored before these fields were added
                    if (typeof item.addressLocation === 'undefined') {
                        item.addressLocation = null;
                    }
                    if (typeof item.confirmedHawbNos === 'undefined') {
                        item.confirmedHawbNos = [];
                    }
                    if (typeof item.carrier === 'undefined') {
                        item.carrier = 'SF'; // Default to SF for old data
                    }
                    return item;
                }).sort((a, b) => a.no - b.no);
            }
            const storedScroll = localStorage.getItem('filterScrollPositions');
            if (storedScroll) filterScrollPositions = JSON.parse(storedScroll);
            updateFilterCounts();
            
            const urlParamsForCheck = new URLSearchParams(window.location.search);
            if (!urlParamsForCheck.has('hawb') && !urlParamsForCheck.has('filter')) {
                changeFilter('배송준비', '', true);
            }

        } catch (error) {
            console.error("초기화 오류:", error);
            document.body.innerHTML = `<div class="p-4 text-red-500">앱 로딩 중 오류가 발생했습니다. 오류: ${error.message}</div>`;
        }
    });
    </script>
</body>
</html>