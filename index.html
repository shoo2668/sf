<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ë°°ì†¡ ì‹œíŠ¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        html {
            scroll-behavior: auto !important; /* JSë¡œ ë¶€ë“œëŸ¬ìš´ ìŠ¤í¬ë¡¤ì„ ì œì–´í•˜ê¸° ìœ„í•´ ê¸°ë³¸ ìŠ¤í¬ë¡¤ ë™ì‘ì„ ì¦‰ì‹œë¡œ ë³€ê²½ */
        }
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding-bottom: 80px;
            overscroll-behavior-y: contain;
        }
        .signature-modal, .confirmation-modal, .suggestion-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            padding: 1rem;
        }
        .signature-modal-content, .confirmation-modal-content, .suggestion-modal-content {
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 1.5rem;
            width: 100%;
            max-width: 28rem;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #2563eb;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes slideInLeft {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .animate-slide-in-left { animation: slideInLeft 0.3s ease-out forwards; }
        .animate-slide-in-right { animation: slideInRight 0.3s ease-out forwards; }
        #delivery-cards-container {
            transition: transform 0.1s ease-out;
            will-change: transform;
        }
        #filter-buttons-container, #search-bar-container {
            position: fixed;
            left: 0;
            width: 100vw;
            will-change: transform, top;
        }
        /* âœ¨ í€µ-ìŠ¤í¬ë¡¤ í•¸ë“¤ ìŠ¤íƒ€ì¼ ì‹œì‘ âœ¨ */
        #quick-scroll-container {
            position: fixed;
            top: 0;
            right: 0;
            height: 100%;
            width: 40px; /* í•¸ë“¤ í„°ì¹˜ ì˜ì—­ í™•ì¥ */
            display: none; /* 'ë°°ì†¡ì¤‘' íƒ­ì—ì„œë§Œ ë³´ì´ë„ë¡ JSë¡œ ì œì–´ */
            z-index: 40;
            user-select: none;
            -webkit-user-select: none;
        }
        #quick-scroll-handle {
            position: absolute;
            right: 8px; /* ì˜¤ë¥¸ìª½ ì—¬ë°± í™•ë³´ */
            top: 50%;
            width: 24px; /* í•¸ë“¤ ë‘ê»˜ */
            height: 50px; /* í•¸ë“¤ ê¸¸ì´ */
            background-color: rgba(0, 0, 0, 0.25);
            border-radius: 12px;
            cursor: grab;
            transition: background-color 0.2s; /* ë“œë˜ê·¸ ì¤‘ì´ ì•„ë‹ë•Œë§Œ top ì „í™˜ íš¨ê³¼ ì ìš© */
        }
        #quick-scroll-handle:not(.active) {
            transition: background-color 0.2s, top 0.15s ease-out;
        }
        #quick-scroll-handle.active {
            background-color: rgba(37, 99, 235, 0.7); /* í™œì„±í™” ì‹œ íŒŒë€ìƒ‰ìœ¼ë¡œ ë³€ê²½ */
            cursor: grabbing;
        }
        #quick-scroll-bubble {
            position: absolute;
            right: 50px; /* í•¸ë“¤ ì™¼ìª½ìœ¼ë¡œ ì¶©ë¶„íˆ ì´ë™ */
            top: 50%;
            transform: translateY(-50%);
            padding: 10px 20px;
            background-color: rgba(0, 0, 0, 0.75);
            color: white;
            font-size: 1.5rem; /* ê¸€ì í¬ê¸° ì¦ê°€ */
            font-weight: 700;  /* í°íŠ¸ êµµê²Œ */
            border-radius: 16px;
            display: none;
            pointer-events: none; /* ë²„ë¸”ì´ í„°ì¹˜ë¥¼ ë°©í•´í•˜ì§€ ì•Šë„ë¡ */
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        #quick-scroll-handle.active ~ #quick-scroll-bubble {
             transition: none; /* ë“œë˜ê·¸ ì¤‘ì—ëŠ” ë¶€ë“œëŸ¬ìš´ íš¨ê³¼ ì œê±° */
        }
        /* âœ¨ í€µ-ìŠ¤í¬ë¡¤ í•¸ë“¤ ìŠ¤íƒ€ì¼ ë âœ¨ */
    </style>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ“„</text></svg>">
</head>
<body class="min-h-screen bg-gray-100 p-4 sm:p-6 lg:p-8 font-sans">
    <div id="search-bar-container" class="z-30">
        <div class="max-w-md mx-auto bg-white rounded-lg shadow-lg w-full min-w-[320px] p-4">
            <label for="invoiceNumber" class="block text-sm font-medium text-gray-700 sr-only">ì†¡ì¥ë²ˆí˜¸ ê²€ìƒ‰</label>
            <div class="flex space-x-2 flex-nowrap">
                <input type="tel" id="invoiceNumber" name="invoiceNumber" placeholder="ì†¡ì¥ë²ˆí˜¸ ê²€ìƒ‰" class="w-2/5 p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" inputmode="numeric" pattern="[0-9]*"/>
                <button id="searchButton" class="w-3/10 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">ê²€ìƒ‰</button>
                <button id="resetButton" class="w-3/10 px-4 py-2 bg-gray-400 text-white rounded-md hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50">ì´ˆê¸°í™”</button>
            </div>
        </div>
    </div>

    <div id="filter-buttons-container" class="z-20">
        <div class="max-w-md mx-auto bg-white rounded-lg shadow-lg w-full min-w-[320px] p-4">
            <div class="flex justify-around space-x-2 overflow-x-auto" style="-webkit-overflow-scrolling: touch;">
                <button data-filter="ë°°ì†¡ì¤€ë¹„" class="flex-shrink-0 px-3 py-1.5 rounded-full text-sm font-medium transition-colors duration-200 flex items-center justify-center space-x-1 whitespace-nowrap"><span>ë°°ì†¡ì¤€ë¹„</span></button>
                <button data-filter="ì „ì²´" class="flex-shrink-0 px-3 py-1.5 rounded-full text-sm font-medium transition-colors duration-200 flex items-center justify-center space-x-1 bg-transparent text-gray-700 border border-gray-300 hover:bg-gray-100 whitespace-nowrap"><span>ì „ì²´</span><span class="text-xs font-semibold px-1.5 py-0.5 rounded-full bg-gray-200 text-gray-700" id="count-ì „ì²´">0</span></button>
                <button data-filter="ë°°ì†¡ì „" class="flex-shrink-0 px-3 py-1.5 rounded-full text-sm font-medium transition-colors duration-200 flex items-center justify-center space-x-1 bg-transparent text-gray-700 border border-gray-300 hover:bg-gray-100 whitespace-nowrap"><span>ë°°ì†¡ì „</span><span class="text-xs font-semibold px-1.5 py-0.5 rounded-full bg-gray-200 text-gray-700" id="count-ë°°ì†¡ì „">0</span></button>
                <button data-filter="ë°°ì†¡ì¤‘" class="flex-shrink-0 px-3 py-1.5 rounded-full text-sm font-medium transition-colors duration-200 flex items-center justify-center space-x-1 bg-transparent text-gray-700 border border-gray-300 hover:bg-gray-100 whitespace-nowrap"><span>ë°°ì†¡ì¤‘</span><span class="text-xs font-semibold px-1.5 py-0.5 rounded-full bg-gray-200 text-gray-700" id="count-ë°°ì†¡ì¤‘">0</span></button>
                <button data-filter="ì™„ë£Œ" class="flex-shrink-0 px-3 py-1.5 rounded-full text-sm font-medium transition-colors duration-200 flex items-center justify-center space-x-1 bg-transparent text-gray-700 border border-gray-300 hover:bg-gray-100 whitespace-nowrap"><span>ì™„ë£Œ</span><span class="text-xs font-semibold px-1.5 py-0.5 rounded-full bg-gray-200 text-gray-700" id="count-ì™„ë£Œ">0</span></button>
            </div>
        </div>
    </div>

    <div id="data-management-container" class="max-w-md mx-auto mb-6 p-4 bg-white rounded-lg shadow-lg w-full min-w-[320px] space-y-4 hidden">
        <div>
            <h3 class="text-lg font-semibold text-gray-800 mb-2">ë°ì´í„° ë‚´ë³´ë‚´ê¸°/ê°€ì ¸ì˜¤ê¸°</h3>
            <div class="flex space-x-2">
                <button id="exportDataButton" class="w-1/2 px-4 py-2 bg-teal-600 text-white rounded-md hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-teal-500">ë°ì´í„° íŒŒì¼ë¡œ ì €ì¥</button>
                <label for="importDataInput" class="w-1/2 px-4 py-2 bg-sky-600 text-white rounded-md hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-sky-500 text-center cursor-pointer">íŒŒì¼ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°</label>
                <input type="file" id="importDataInput" class="hidden" accept=".json"/>
            </div>
        </div>
        <div>
            <h3 class="text-lg font-semibold text-gray-800 mb-2">ì¹´ë“œ ì´ˆê¸°í™”</h3>
            <button id="clearAllCardsButton" class="w-full px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">ëª¨ë“  ì¹´ë“œ ì‚­ì œ</button>
        </div>
    </div>

    <div id="scan-section-container" class="max-w-md mx-auto mb-6 p-4 bg-white rounded-lg shadow-lg w-full min-w-[320px] hidden">
        <h3 class="text-lg font-semibold text-gray-800 mb-3">ì†¡ì¥ ìŠ¤ìº”í•˜ì—¬ ì¹´ë“œ ìƒì„±</h3>
        <div class="flex flex-col sm:flex-row items-center space-y-3 sm:space-y-0 sm:space-x-3">
            <input type="file" id="deliverySheetImage" accept="image/*" multiple class="hidden"/>
            <label for="deliverySheetImage" class="flex-1 w-full text-sm text-blue-700 py-2 px-4 rounded-md border border-blue-300 bg-blue-50 font-semibold cursor-pointer hover:bg-blue-100 text-center whitespace-nowrap">ì‚¬ì§„ ì„ íƒ</label>
            <button id="scanAndGenerateButton" class="w-full sm:w-auto px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50">ìŠ¤ìº”í•˜ì—¬ ì¹´ë“œ ìƒì„±</button>
        </div>
        <div id="selected-files-display" class="mt-2 text-sm text-gray-600 text-center">ì„ íƒëœ íŒŒì¼ ì—†ìŒ</div>
        <div id="scan-loading-indicator" class="hidden mt-3 text-center text-sm text-blue-600">
            <div class="spinner mx-auto mb-2"></div>
            <p id="scan-progress-text">ì†¡ì¥ ìŠ¤ìº” ì¤‘...</p>
        </div>
        <div id="scan-error-message" class="hidden mt-3 text-center text-sm text-red-600">ìŠ¤ìº” ì‹¤íŒ¨: <span id="scan-error-text"></span></div>
    </div>

    <div id="delivery-cards-container" class="max-w-md mx-auto"></div>
    
    <div id="quick-scroll-container">
        <div id="quick-scroll-handle"></div>
        <div id="quick-scroll-bubble">1</div>
    </div>

    <div id="signature-modal" class="signature-modal" style="display: none;">
        <div class="signature-modal-content">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">ì„œëª… ì…ë ¥</h2>
            <div class="signature-input-container">
                <textarea id="signature-text-input" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" rows="3" placeholder="ì—¬ê¸°ì— ì„œëª… ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”."></textarea>
            </div>
            <div class="flex justify-end space-x-2 mt-4">
                <button id="clearSignature" class="px-4 py-2 rounded-md bg-gray-300 text-gray-800 text-sm font-medium hover:bg-gray-400">ì§€ìš°ê¸°</button>
                <button id="cancelSignature" class="px-4 py-2 rounded-md bg-red-500 text-white text-sm font-medium hover:bg-red-600">ì·¨ì†Œ</button>
                <button id="saveSignature" class="px-4 py-2 rounded-md bg-blue-600 text-white text-sm font-medium hover:bg-blue-700">ì €ì¥</button>
            </div>
        </div>
    </div>

    <div id="confirmation-modal" class="confirmation-modal" style="display: none;">
        <div class="confirmation-modal-content">
            <h2 class="text-xl font-semibold mb-4 text-gray-800" id="confirmation-modal-title">í™•ì¸</h2>
            <p class="text-base text-gray-700 mb-6" id="confirmation-modal-message"></p>
            <div class="flex justify-between space-x-2 mt-4">
                <button id="confirmCancelButton" class="w-1/2 px-4 py-2 rounded-md bg-gray-300 text-gray-800 text-sm font-medium hover:bg-gray-400">ì·¨ì†Œ</button>
                <button id="confirmOkButton" class="w-1/2 px-4 py-2 rounded-md bg-blue-600 text-white text-sm font-medium hover:bg-blue-700">í™•ì¸</button>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        const GEMINI_PROMPT = `Extract the following delivery information from the provided invoice image. The output MUST be a JSON array of objects. Each object MUST contain ALL of these exact keys, even if the value is an empty string: "no", "hawbNo", "receiverAddressKorean", "receiverAddressOriginal", "companyNameKorean", "companyNameOriginal", "receiverNameKorean", "receiverNameOriginal", "receiverTelephoneNo".

For "hawbNo", extract the *entire* HAWB number.
For "receiverAddressKorean", provide the Korean translation of the address.
For "receiverAddressOriginal", provide the exact original text.
For "companyNameKorean", provide the Korean translation.
For "companyNameOriginal", provide the exact original text.
For "receiverNameKorean", provide the Korean translation.
For "receiverNameOriginal", provide the exact original text.
For "receiverTelephoneNo", provide only digits.`;
        
        const dateTimeFormatOptions = { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };

        // --- Helper functions ---
        const cleanStringForDisplay = (str) => {
            if (typeof str !== 'string' || !str) return '';
            return str.replace(/[\n\\]/g, '').trim();
        };

        const formatSinglePhoneNumber = (phoneNumber) => {
            if (typeof phoneNumber !== 'string' || !phoneNumber) return '';
            let cleaned = phoneNumber.replace(/\D/g, '');

            if (cleaned.startsWith('+82010')) { cleaned = '010' + cleaned.substring(6); }
            else if (cleaned.startsWith('82010')) { cleaned = '010' + cleaned.substring(5); }
            else if (cleaned.startsWith('+8210')) { cleaned = '010' + cleaned.substring(5); }
            else if (cleaned.startsWith('8210')) { cleaned = '010' + cleaned.substring(4); }
            else if (cleaned.startsWith('8201') && cleaned.length > 4 && cleaned[4] !== '0') { cleaned = '010' + cleaned.substring(4); }
            else if (cleaned.startsWith('82') && cleaned.length > 2) { cleaned = '0' + cleaned.substring(2); }
            else if (cleaned.length >= 7 && cleaned.length <= 11 && !cleaned.startsWith('0')) { cleaned = '0' + cleaned; }
            
            if (cleaned.startsWith('010') && cleaned.length === 11) return cleaned.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
            if (cleaned.startsWith('02')) {
                if (cleaned.length === 9) return cleaned.replace(/(\d{2})(\d{3})(\d{4})/, '$1-$2-$3');
                if (cleaned.length === 10) return cleaned.replace(/(\d{2})(\d{4})(\d{4})/, '$1-$2-$3');
            }
            if (cleaned.startsWith('031') && cleaned.length === 11) return cleaned.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
            if (cleaned.startsWith('070') && cleaned.length === 11) return cleaned.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
            if (cleaned.length === 10) return cleaned.replace(/(\d{3})(\d{3})(\d{4})/, '$1-$2-$3');
            if (cleaned.length === 9) return cleaned.replace(/(\d{2})(\d{3})(\d{4})/, '$1-$2-$3');
            if (cleaned.length === 8) return cleaned.replace(/(\d{4})(\d{4})/, '$1-$2');
            if (cleaned.length === 7) return cleaned.replace(/(\d{3})(\d{4})/, '$1-$2');

            return cleaned;
        };

        const formatPhoneNumberForDisplay = (phoneNumber) => {
            if (typeof phoneNumber !== 'string' || !phoneNumber) return '';
            const rangeMatch = phoneNumber.match(/^(\d+)-(\d+)$/);
            if (rangeMatch) {
                const baseNumber = rangeMatch[1];
                const suffix = rangeMatch[2];
                if (baseNumber.length >= suffix.length) {
                    const num1 = formatSinglePhoneNumber(baseNumber);
                    const num2Raw = baseNumber.substring(0, baseNumber.length - suffix.length) + suffix;
                    const num2 = formatSinglePhoneNumber(num2Raw);
                    return `${num1} / ${num2}`;
                }
            }
            return formatSinglePhoneNumber(phoneNumber.replace(/\D/g, ''));
        };

        const getCleanPhoneNumber = (phoneNumber) => {
            if (typeof phoneNumber !== 'string' || !phoneNumber) return '';
            const rangeMatch = phoneNumber.match(/^(\d+)-(\d+)$/);
            if (rangeMatch) phoneNumber = rangeMatch[1];
            
            let cleaned = phoneNumber.replace(/\D/g, '');

            if (cleaned.startsWith('+82010')) { cleaned = '010' + cleaned.substring(6); }
            else if (cleaned.startsWith('82010')) { cleaned = '010' + cleaned.substring(5); }
            else if (cleaned.startsWith('+8210')) { cleaned = '010' + cleaned.substring(5); }
            else if (cleaned.startsWith('8210')) { cleaned = '010' + cleaned.substring(4); }
            else if (cleaned.startsWith('8201') && cleaned.length > 4 && cleaned[4] !== '0') { cleaned = '010' + cleaned.substring(4); }
            else if (cleaned.startsWith('82') && cleaned.length > 2) { cleaned = '0' + cleaned.substring(2); }
            else if (cleaned.length >= 7 && cleaned.length <= 11 && !cleaned.startsWith('0')) { cleaned = '0' + cleaned; }

            return cleaned;
        };

        const formatHawbNoForDisplay = (hawbNo) => {
            if (!hawbNo || hawbNo.length < 4) return hawbNo;
            const prefix = hawbNo.substring(0, hawbNo.length - 4);
            const suffix = hawbNo.substring(hawbNo.length - 4);
            return `${prefix} ${suffix}`;
        };

        const formatCompletionTime = (dateTimeString) => {
            if (!dateTimeString) return '';
            const parts = dateTimeString.split(' ');
            if (parts.length >= 4) {
                const [hour, minute] = parts[3].split(':');
                return `${hour}:${minute}`;
            }
            return '';
        };
        
        const formatAddressForClipboard = (address) => {
            if (!address || typeof address !== 'string') return '';
            let cleanedAddress = address.trim().replace(/ë–¡ì •ê³¨ë¡œ/g, "ë–¡ì „ê³¨ë¡œ");
            
            let tempAddress = cleanedAddress;
            tempAddress = tempAddress.replace(/^(ì„œìš¸|ë¶€ì‚°|ëŒ€êµ¬|ì¸ì²œ|ê´‘ì£¼|ëŒ€ì „|ìš¸ì‚°|ì„¸ì¢…|ê²½ê¸°|ê°•ì›|ì¶©ì²­ë¶ë„|ì¶©ì²­ë‚¨ë„|ì „ë¼ë¶ë„|ì „ë¼ë‚¨ë„|ê²½ìƒë¶ë„|ê²½ìƒë‚¨ë„|ì œì£¼íŠ¹ë³„ìì¹˜ë„|ì¶©ë¶|ì¶©ë‚¨|ì „ë¶|ì „ë‚¨|ê²½ë¶|ê²½ë‚¨|ì œì£¼)(íŠ¹ë³„ì‹œ|ê´‘ì—­ì‹œ|íŠ¹ë³„ìì¹˜ì‹œ|ë„)?\s*/, '').trim();
            tempAddress = tempAddress.replace(/^([ê°€-í£]+(?:ì‹œ|êµ°|êµ¬))\s+/, '').trim();
            tempAddress = tempAddress.replace(/^([ê°€-í£]+(?:ì|ë©´))\s+/, '').trim();
            cleanedAddress = tempAddress;

            const firstCommaIndex = cleanedAddress.indexOf(',');
            if (firstCommaIndex !== -1) {
                cleanedAddress = cleanedAddress.substring(0, firstCommaIndex).trim();
            }
            return cleanedAddress.replace(/\s+/g, ' ').trim();
        };
        
        const extractClipboardAddressPart = (fullAddress) => {
            if (!fullAddress || typeof fullAddress !== 'string') return '';
            let matchDongHo = fullAddress.match(/(\d+ë™\s*\d+í˜¸)/);
            if (matchDongHo?.[1]) return matchDongHo[1].trim();

            const commaIndex = fullAddress.indexOf(',');
            if (commaIndex !== -1) {
                const detailedAddressPart = fullAddress.substring(commaIndex + 1).trim();
                let matchHyphenUnitInDetailed = detailedAddressPart.match(/(\b\d{1,4}-\d{1,4}\b)(?:í˜¸)?(?!\S)/);
                if (matchHyphenUnitInDetailed?.[1]) return matchHyphenUnitInDetailed[1].trim();
            }
            return formatAddressForClipboard(fullAddress);
        };

        const isValidAddressForMap = (address) => {
            if (!address || address.trim().length === 0 || !/\d/.test(address)) return false;
            const isRoadNameAddress = /ë¡œ|ê¸¸|ëŒ€ë¡œ|ë²ˆê¸¸/.test(address);
            const isJibunAddress = /(ë™|ë¦¬|ì|ë©´)\s*\d+([\-\s]\d+)?/.test(address) || /^\d+([\-\s]\d+)*$/.test(address);
            return isRoadNameAddress || isJibunAddress;
        };

        // --- Global state and DOM elements ---
        let deliveryItems = [];
        let searchTerm = '';
        let activeFilter = 'ì „ì²´';
        const filterCategories = ['ë°°ì†¡ì¤€ë¹„', 'ì „ì²´', 'ë°°ì†¡ì „', 'ë°°ì†¡ì¤‘', 'ì™„ë£Œ'];
        let filterScrollPositions = {};
        let currentFileToScan = null;
        let currentSignatureItemNo = null;
        let onConfirmCallback = null;

        const searchBarContainer = document.getElementById('search-bar-container');
        const invoiceNumberInput = document.getElementById('invoiceNumber');
        const searchButton = document.getElementById('searchButton');
        const resetButton = document.getElementById('resetButton');
        const filterButtonsContainer = document.getElementById('filter-buttons-container');
        const deliveryCardsContainer = document.getElementById('delivery-cards-container');
        const deliverySheetImageInput = document.getElementById('deliverySheetImage');
        const scanAndGenerateButton = document.getElementById('scanAndGenerateButton');
        const scanLoadingIndicator = document.getElementById('scan-loading-indicator');
        const scanErrorMessage = document.getElementById('scan-error-message');
        const scanErrorText = document.getElementById('scan-error-text');
        const scanSectionContainer = document.getElementById('scan-section-container');
        const clearAllCardsButton = document.getElementById('clearAllCardsButton');
        const dataManagementContainer = document.getElementById('data-management-container');
        const exportDataButton = document.getElementById('exportDataButton');
        const importDataInput = document.getElementById('importDataInput');
        const scanProgressText = document.getElementById('scan-progress-text');
        const selectedFilesDisplay = document.getElementById('selected-files-display');
        const signatureModal = document.getElementById('signature-modal');
        const signatureTextInput = document.getElementById('signature-text-input');
        const clearSignatureBtn = document.getElementById('clearSignature');
        const cancelSignatureBtn = document.getElementById('cancelSignature');
        const saveSignatureBtn = document.getElementById('saveSignature');
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmationModalTitle = document.getElementById('confirmation-modal-title');
        const confirmationModalMessage = document.getElementById('confirmation-modal-message');
        const confirmOkButton = document.getElementById('confirmOkButton');
        const confirmCancelButton = document.getElementById('confirmCancelButton');

        // --- Modal & Core Logic Functions ---
        const openSignatureModal = (itemNo) => { currentSignatureItemNo = itemNo; signatureModal.style.display = 'flex'; signatureTextInput.value = ''; signatureTextInput.focus(); };
        const closeSignatureModal = () => { signatureModal.style.display = 'none'; currentSignatureItemNo = null; };
        const saveSignature = () => {
            if (currentSignatureItemNo === null) return;
            const signatureText = signatureTextInput.value.trim();
            if (signatureText === '') { showMessage('ì„œëª… ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
            const currentTime = new Date().toLocaleString('ko-KR', dateTimeFormatOptions);
            handleStatusChange(currentSignatureItemNo, 'ì™„ë£Œ', currentTime, 'ì„œëª…', signatureText);
            closeSignatureModal();
            showMessage('ì„œëª…ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'ì„±ê³µ');
        };
        const openConfirmationModal = (message, onOk) => { confirmationModalTitle.textContent = 'í™•ì¸'; confirmationModalMessage.textContent = message; confirmCancelButton.style.display = ''; onConfirmCallback = onOk; confirmationModal.style.display = 'flex'; };
        const closeConfirmationModal = () => { confirmationModal.style.display = 'none'; onConfirmCallback = null; confirmCancelButton.style.display = ''; };
        const showMessage = (message, title = 'ì•Œë¦¼') => { confirmationModalTitle.textContent = title; confirmationModalMessage.textContent = message; confirmCancelButton.style.display = 'none'; onConfirmCallback = closeConfirmationModal; confirmationModal.style.display = 'flex'; };
        
        confirmOkButton.addEventListener('click', () => { if (onConfirmCallback) onConfirmCallback(); closeConfirmationModal(); });
        confirmCancelButton.addEventListener('click', closeConfirmationModal);
        clearSignatureBtn.addEventListener('click', () => signatureTextInput.value = '');
        cancelSignatureBtn.addEventListener('click', closeSignatureModal);
        saveSignatureBtn.addEventListener('click', saveSignature);

        const saveDeliveryItemsToLocalStorage = () => {
            localStorage.setItem('deliveryItems', JSON.stringify(deliveryItems));
            localStorage.setItem('filterScrollPositions', JSON.stringify(filterScrollPositions));
        };
        const handleStatusChange = (itemNo, newStatus, completionTime = null, completionType = null, completionDetail = null) => {
            deliveryItems = deliveryItems.map(item => item.no === itemNo ? { ...item, status: newStatus, deliveryCompletionTime: completionTime, completionType, completionDetail, isHawbConfirmed: newStatus !== 'ë°°ì†¡ì „' } : item);
            saveDeliveryItemsToLocalStorage();
            renderDeliveryCards();
            updateFilterCounts();
        };
        const handleCheckboxToggleAndResetSearch = (itemNo, newCheckboxState) => {
            deliveryItems = deliveryItems.map(item => item.no === itemNo ? { ...item, isHawbConfirmed: newCheckboxState, status: newCheckboxState ? 'ë°°ì†¡ì¤‘' : 'ë°°ì†¡ì „', deliveryCompletionTime: newCheckboxState ? item.deliveryCompletionTime : null, completionType: newCheckboxState ? item.completionType : null, completionDetail: newCheckboxState ? item.completionDetail : null } : item);
            saveDeliveryItemsToLocalStorage();
            searchTerm = '';
            invoiceNumberInput.value = '';
            renderDeliveryCards();
            updateFilterCounts();
        };
        const openNaverMap = (address, no) => {
            const addressForMapSearch = formatAddressForClipboard(address);
            const textToCopy = `${no}. ${extractClipboardAddressPart(address)}`;
            const textarea = document.createElement('textarea');
            textarea.value = textToCopy;
            textarea.style.position = 'fixed';
            textarea.style.opacity = 0;
            document.body.appendChild(textarea);
            textarea.focus();
            textarea.select();
            try { document.execCommand('copy'); }
            catch (err) { console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', err); showMessage('í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'ë³µì‚¬ ì‹¤íŒ¨'); }
            document.body.removeChild(textarea);
            window.location.href = `nmap://search?query=${encodeURIComponent(addressForMapSearch)}&appname=DeliveryApp`;
        };
        const highlightHawbNo = (hawbNo, term) => {
            if (!hawbNo) return '';
            const formattedHawbNo = formatHawbNoForDisplay(hawbNo);
            if (!term || !formattedHawbNo.includes(term)) return formattedHawbNo;
            const escapedTerm = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            return formattedHawbNo.split(new RegExp(`(${escapedTerm})`, 'gi')).map(part => part.toLowerCase() === term.toLowerCase() ? `<span class="bg-yellow-200 rounded px-0.5">${part}</span>` : part).join('');
        };
        
        // --- Render function ---
        const renderDeliveryCards = (animationClass = '') => {
            let currentFilteredData = deliveryItems;
            if (activeFilter === 'ë°°ì†¡ì¤€ë¹„') { deliveryCardsContainer.innerHTML = ''; return; }

            if (searchTerm) {
                const cleanedSearchTerm = searchTerm.replace(/\D/g, '');
                currentFilteredData = currentFilteredData.filter(item => item.hawbNo?.replace(/\D/g, '').includes(cleanedSearchTerm));
            }
            if (activeFilter !== 'ì „ì²´') {
                currentFilteredData = currentFilteredData.filter(item => item.status === activeFilter);
            }

            deliveryCardsContainer.classList.remove('animate-slide-in-left', 'animate-slide-in-right');
            deliveryCardsContainer.style.animation = '';

            if (currentFilteredData.length === 0) {
                deliveryCardsContainer.innerHTML = '<p class="text-center text-gray-600 px-4">í•´ë‹¹í•˜ëŠ” í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            deliveryCardsContainer.innerHTML = currentFilteredData.map(data => {
                const isMapButtonActive = isValidAddressForMap(data.receiverAddressKorean);
                return `
                    <div class="${data.status === 'ë°°ì†¡ì¤‘' ? 'bg-blue-100' : (data.status === 'ì™„ë£Œ' ? 'bg-gray-200' : 'bg-white')} rounded-lg shadow-lg p-6 mb-4 border border-gray-200" data-no="${data.no}">
                        <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-200">
                            ${data.status !== 'ì™„ë£Œ' ? `
                                <div class="flex items-center space-x-2 w-full justify-between">
                                    <h3 class="text-3xl font-semibold text-red-500">${data.no}</h3>
                                    <span class="text-base font-bold text-gray-600 whitespace-nowrap">${highlightHawbNo(data.hawbNo, searchTerm)}</span>
                                    <input type="checkbox" data-action="toggle-hawb-confirm" data-no="${data.no}" ${data.isHawbConfirmed ? 'checked' : ''} class="form-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded"/>
                                </div>
                            ` : `
                                <div class="text-xl font-semibold text-gray-700 text-left w-full">
                                    <span class="text-red-500 text-2xl mr-8">${data.no}</span>
                                    ${data.completionType === 'ì„œëª…' && data.completionDetail ? `<span class="text-lg font-semibold text-gray-800 p-1 border border-dashed border-gray-400 rounded-md bg-gray-50 inline-block">${data.completionDetail}</span>` : data.completionType === 'ë³¸ì¸í™•ì¸' ? `${data.completionType} (${data.completionDetail})` : `${data.completionType || ''}`}
                                    <span class="ml-4">${formatCompletionTime(data.deliveryCompletionTime)}</span>
                                </div>
                            `}
                        </div>
                        <div class="space-y-3" data-details-container="${data.no}" ${data.status === 'ì™„ë£Œ' ? 'style="display:none;"' : ''}>
                            <div><p class="text-sm font-medium text-gray-700">ì£¼ì†Œ:</p><div class="flex items-center justify-between"><p class="text-base text-blue-600 font-semibold">${data.receiverAddressKorean}</p><button data-action="open-naver-map" data-address="${data.receiverAddressKorean}" data-no="${data.no}" class="${isMapButtonActive ? 'ml-2 px-3 py-1.5 rounded-full bg-green-500 text-white text-sm font-medium hover:bg-green-600' : 'ml-2 px-3 py-1.5 rounded-full bg-gray-300 text-gray-500 text-sm font-medium cursor-not-allowed opacity-50'}" ${isMapButtonActive ? '' : 'disabled'}>ì§€ë„ë³´ê¸°</button></div>${data.receiverAddressOriginal ? `<p class="text-xs text-gray-500 ml-1">(${data.receiverAddressOriginal})</p>` : ''}</div>
                            <div><p class="text-sm font-medium text-gray-700">íšŒì‚¬ëª…:</p><p class="text-base text-blue-600 font-semibold">${data.companyNameKorean || 'N/A'}</p>${data.companyNameOriginal && data.companyNameOriginal !== data.companyNameKorean ? `<p class="text-xs text-gray-500 ml-1">(${data.companyNameOriginal})</p>` : ''}</div>
                            <div><p class="text-sm font-medium text-gray-700">ì´ë¦„:</p><p class="text-base text-blue-600 font-semibold">${data.receiverNameKorean || 'N/A'}</p>${data.receiverNameOriginal && data.receiverNameOriginal !== data.receiverNameKorean ? `<p class="text-xs text-gray-500 ml-1">(${data.receiverNameOriginal})</p>` : ''}</div>
                            <div><p class="text-sm font-medium text-gray-700">ì „í™”ë²ˆí˜¸:</p><div class="flex items-center space-x-2"><span class="text-base text-blue-600 font-semibold">${formatPhoneNumberForDisplay(data.receiverTelephoneNo)}</span><a href="tel:${getCleanPhoneNumber(data.receiverTelephoneNo)}" class="px-3 py-1.5 rounded-full bg-transparent text-orange-500 border border-orange-500 text-sm font-medium hover:bg-orange-100">ì „í™”</a><a href="sms:${getCleanPhoneNumber(data.receiverTelephoneNo)}" class="px-3 py-1.5 rounded-full bg-transparent text-blue-500 border border-blue-500 text-sm font-medium hover:bg-blue-100">ë¬¸ì</a></div></div>
                            ${data.status === 'ì™„ë£Œ' ? `<div class="mt-4 pt-4 border-t border-gray-200 flex justify-center"><button data-action="revert-delivery" data-no="${data.no}" class="px-4 py-2 rounded-md bg-red-500 text-white text-sm font-medium hover:bg-red-600">ë˜ëŒë¦¬ê¸°</button></div>` : ''}
                        </div>
                        ${data.status === 'ë°°ì†¡ì¤‘' ? `<div class="mt-4 pt-4 border-t border-gray-200 flex justify-between space-x-2"><button data-action="identity-verification" data-no="${data.no}" class="w-2/5 px-3 py-1.5 rounded-md bg-green-600 text-white text-sm font-medium">ë³¸ì¸í™•ì¸</button><button data-action="front-door-delivery" data-no="${data.no}" class="w-2/5 px-3 py-1.5 rounded-md bg-purple-600 text-white text-sm font-medium">ë¬¸ì•ë°°ì†¡</button><button data-action="sign-delivery" data-no="${data.no}" class="w-1/5 px-3 py-1.5 rounded-md bg-indigo-600 text-white text-sm font-medium">ì„œëª…</button></div>` : ''}
                        ${data.status === 'ì™„ë£Œ' ? `<div class="pt-4 flex flex-col items-center"><button data-action="toggle-details" data-no="${data.no}" class="px-4 py-2 rounded-md bg-gray-300 text-gray-800 text-sm font-medium">ìƒì„¸ë³´ê¸°</button></div>` : ''}
                </div>
            `;
        }).join('');
        
        if (animationClass) {
            deliveryCardsContainer.style.transform = 'translateX(0px)';
            deliveryCardsContainer.classList.add(animationClass);
            setTimeout(() => { deliveryCardsContainer.classList.remove(animationClass); deliveryCardsContainer.style.animation = ''; }, 300);
        }
    };

    // --- UI Update & Event Listener Setup ---
    const updateFilterCounts = () => {
        document.getElementById('count-ì „ì²´').textContent = deliveryItems.length;
        document.getElementById('count-ë°°ì†¡ì „').textContent = deliveryItems.filter(item => item.status === 'ë°°ì†¡ì „').length;
        document.getElementById('count-ë°°ì†¡ì¤‘').textContent = deliveryItems.filter(item => item.status === 'ë°°ì†¡ì¤‘').length;
        document.getElementById('count-ì™„ë£Œ').textContent = deliveryItems.filter(item => item.status === 'ì™„ë£Œ').length;
    };
    
    const quickScrollContainer = document.getElementById('quick-scroll-container');
    const quickScrollHandle = document.getElementById('quick-scroll-handle');
    const quickScrollBubble = document.getElementById('quick-scroll-bubble');
    
    const updateStickyHeaderPositions = () => {
        requestAnimationFrame(() => {
            let topOffset = 0;
            const isSearchVisible = ['ì „ì²´', 'ë°°ì†¡ì „'].includes(activeFilter);
            
            searchBarContainer.classList.toggle('hidden', !isSearchVisible);
            if (isSearchVisible) {
                searchBarContainer.style.top = `${topOffset}px`; 
                topOffset += searchBarContainer.offsetHeight;
            }
            
            filterButtonsContainer.style.top = `${topOffset}px`;
            topOffset += filterButtonsContainer.offsetHeight;
            document.body.style.paddingTop = `${topOffset}px`;

            const isScanVisible = activeFilter === 'ë°°ì†¡ì¤€ë¹„';
            scanSectionContainer.classList.toggle('hidden', !isScanVisible);
            dataManagementContainer.classList.toggle('hidden', !isScanVisible);

            const deliveryInProgressCount = deliveryItems.filter(item => item.status === 'ë°°ì†¡ì¤‘').length;
            quickScrollContainer.style.display = (activeFilter === 'ë°°ì†¡ì¤‘' && deliveryInProgressCount > 0) ? 'block' : 'none';
        });
    };
    
    filterButtonsContainer.addEventListener('click', (event) => {
        const button = event.target.closest('button[data-filter]');
        if (!button || button.dataset.filter === activeFilter) return;

        filterScrollPositions[activeFilter] = window.scrollY;
        activeFilter = button.dataset.filter;

        filterButtonsContainer.querySelectorAll('button').forEach(btn => {
            const isActive = btn.dataset.filter === activeFilter;
            btn.classList.remove('bg-blue-500', 'text-white', 'shadow', 'bg-transparent', 'text-gray-700', 'border', 'border-gray-300', 'hover:bg-gray-100');
            if (isActive) {
                btn.classList.add('bg-blue-500', 'text-white', 'shadow');
            } else {
                btn.classList.add('bg-transparent', 'text-gray-700', 'border', 'border-gray-300', 'hover:bg-gray-100');
            }
        });

        renderDeliveryCards();
        updateStickyHeaderPositions();
        button.scrollIntoView({ behavior: 'smooth', inline: 'center' });
        setTimeout(() => window.scrollTo({ top: filterScrollPositions[activeFilter] || 0, behavior: 'auto' }), 0);
    });

    searchButton.addEventListener('click', () => { searchTerm = invoiceNumberInput.value.replace(/\D/g, ''); renderDeliveryCards(); window.scrollTo({ top: 0, behavior: 'auto' }); filterScrollPositions[activeFilter] = 0; });
    resetButton.addEventListener('click', () => { filterScrollPositions[activeFilter] = window.scrollY; searchTerm = ''; invoiceNumberInput.value = ''; renderDeliveryCards(); setTimeout(() => window.scrollTo({ top: filterScrollPositions[activeFilter] || 0, behavior: 'auto' }), 0); });
    invoiceNumberInput.addEventListener('input', (event) => { searchTerm = event.target.value.replace(/\D/g, ''); renderDeliveryCards(); window.scrollTo({ top: 0, behavior: 'auto' }); filterScrollPositions[activeFilter] = 0; });

    deliverySheetImageInput.addEventListener('change', (event) => {
        currentFileToScan = event.target.files;
        selectedFilesDisplay.textContent = currentFileToScan.length > 0 ? `ì„ íƒëœ íŒŒì¼: ${Array.from(currentFileToScan).map(f => f.name).join(', ')}` : 'ì„ íƒëœ íŒŒì¼ ì—†ìŒ';
    });
    
    clearAllCardsButton.addEventListener('click', () => {
        openConfirmationModal("ëª¨ë“  ì¹´ë“œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", () => {
            deliveryItems = [];
            saveDeliveryItemsToLocalStorage();
            renderDeliveryCards();
            updateFilterCounts();
            showMessage("ëª¨ë“  ì¹´ë“œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        });
    });

    // --- Scan, Import, Export Logic ---
    scanAndGenerateButton.addEventListener('click', async () => {
        if (!currentFileToScan || currentFileToScan.length === 0) { showMessage('ìŠ¤ìº”í•  ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
        scanLoadingIndicator.style.display = 'block';
        scanProgressText.textContent = 'ìŠ¤ìº” ì¤€ë¹„ ì¤‘...';
        scanErrorMessage.style.display = 'none';
        
        try {
            const mergedResults = {}; 

            for (let i = 0; i < currentFileToScan.length; i++) {
                const file = currentFileToScan[i];
                scanProgressText.textContent = `ì´ë¯¸ì§€ ë¶„ì„ ì¤‘ (${i + 1}/${currentFileToScan.length})...`;
                const base64ImageData = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });

                const payload = {
                    contents: [{ role: "user", parts: [{ text: GEMINI_PROMPT }, { inlineData: { mimeType: file.type, data: base64ImageData } }] }],
                    generationConfig: { 
                        responseMimeType: "application/json",
                        responseSchema: { type: "ARRAY", items: { type: "OBJECT", properties: { "no": { "type": "STRING" }, "hawbNo": { "type": "STRING" }, "receiverAddressKorean": { "type": "STRING" }, "receiverAddressOriginal": { "type": "STRING" }, "companyNameKorean": { "type": "STRING" }, "companyNameOriginal": { "type": "STRING" }, "receiverNameKorean": { "type": "STRING" }, "receiverNameOriginal": { "type": "STRING" }, "receiverTelephoneNo": { "type": "STRING" } } } } }
                };
                
                const tempApiKeyForLocalTest = "AIzaSyBCBUz343UBlM1IxY3UICQIX79oew2WbEs";
                const directApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro:generateContent?key=${tempApiKeyForLocalTest}`;

                const response = await fetch(directApiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`${file.name}: ${errorData?.error?.message || `API ìš”ì²­ ì‹¤íŒ¨ (ìƒíƒœ: ${response.status})`}`);
                }
                const result = await response.json();
                console.log("Gemini API Response:", JSON.stringify(result, null, 2));

                if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    const cleanedText = result.candidates[0].content.parts[0].text.replace(/^```json\s*/, '').replace(/```$/, '').trim();
                    console.log("Attempting to parse the following text as JSON:", cleanedText);
                    try {
                        const parsedData = JSON.parse(cleanedText);
                        if (Array.isArray(parsedData)) {
                            parsedData.forEach(item => {
                                const no = parseInt(item.no || '0', 10);
                                const hawbNo = item.hawbNo || '';
                                if (no > 0 && hawbNo.trim() !== '') {
                                    mergedResults[no] = item;
                                }
                            });
                        }
                    } catch (parseError) {
                        console.error(`Skipping file due to JSON parsing error: ${file.name}. Details:`, parseError);
                        console.error("Problematic text from API:", cleanedText);
                    }
                }
            }

            const allNewItems = Object.values(mergedResults);

            if (allNewItems.length > 0) {
                let newCount = 0;
                let updateCount = 0;
                
                const finalItems = allNewItems.map(item => ({
                    no: parseInt(item.no, 10),
                    hawbNo: item.hawbNo || '',
                    receiverAddressKorean: item.receiverAddressKorean || '',
                    receiverAddressOriginal: cleanStringForDisplay(item.receiverAddressOriginal),
                    companyNameKorean: item.companyNameKorean || '',
                    companyNameOriginal: cleanStringForDisplay(item.companyNameOriginal),
                    receiverNameKorean: item.receiverNameKorean || '',
                    receiverNameOriginal: cleanStringForDisplay(item.receiverNameOriginal),
                    receiverTelephoneNo: item.receiverTelephoneNo ? getCleanPhoneNumber(item.receiverTelephoneNo) : '',
                    status: 'ë°°ì†¡ì „', isHawbConfirmed: false,
                    deliveryCompletionTime: null, completionType: null, completionDetail: null,
                }));
                
                finalItems.forEach(newItem => {
                    const existingItemIndex = deliveryItems.findIndex(item => item.no === newItem.no);
                    
                    if (existingItemIndex > -1) {
                        deliveryItems[existingItemIndex] = newItem;
                        updateCount++;
                    } else {
                        deliveryItems.push(newItem);
                        newCount++;
                    }
                });

                deliveryItems.sort((a, b) => a.no - b.no);
                
                saveDeliveryItemsToLocalStorage();
                showMessage(`${updateCount}ê°œì˜ ì¹´ë“œê°€ ì—…ë°ì´íŠ¸ë˜ê³  ${newCount}ê°œì˜ ì¹´ë“œê°€ ìƒˆë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                
            } else { showMessage(`ì´ë¯¸ì§€ì—ì„œ ìœ íš¨í•œ ì •ë³´ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.`); }
        } catch (error) {
            console.error("ìŠ¤ìº” ì˜¤ë¥˜:", error);
            scanErrorText.textContent = error.message;
            scanErrorMessage.style.display = 'block';
        } finally {
            scanLoadingIndicator.style.display = 'none';
            scanProgressText.textContent = 'ì†¡ì¥ ìŠ¤ìº” ì¤‘...';
            deliverySheetImageInput.value = '';
            currentFileToScan = null;
            selectedFilesDisplay.textContent = 'ì„ íƒëœ íŒŒì¼ ì—†ìŒ';
            renderDeliveryCards();
            updateFilterCounts();
            updateStickyHeaderPositions();
        }
    });
    
    exportDataButton.addEventListener('click', () => {
        if (deliveryItems.length === 0) {
            showMessage("ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }
        try {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const formattedDate = `${year}-${month}-${day}`;
            
            const fileName = `SF-${formattedDate}.json`;

            const dataStr = JSON.stringify(deliveryItems, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showMessage(`ë°ì´í„°ê°€ '${fileName}' íŒŒì¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        } catch (error) {
            showMessage(`ë°ì´í„° ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`, "ì˜¤ë¥˜");
        }
    });

    importDataInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;

        openConfirmationModal(
            `'${file.name}' íŒŒì¼ì˜ ë°ì´í„°ë¡œ í˜„ì¬ ëª©ë¡ì„ ëª¨ë‘ ë®ì–´ì”ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`,
            () => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (!Array.isArray(importedData)) {
                            throw new Error("íŒŒì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤ (ë°°ì—´ì´ ì•„ë‹˜).");
                        }
                        if (importedData.length > 0 && typeof importedData[0].no === 'undefined') {
                            throw new Error("íŒŒì¼ ë‚´ìš©ì´ ì˜¬ë°”ë¥¸ ë°°ì†¡ ë°ì´í„° í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.");
                        }
                        deliveryItems = importedData;
                        saveDeliveryItemsToLocalStorage();
                        updateFilterCounts();
                        updateStickyHeaderPositions();
                        renderDeliveryCards();
                        showMessage(`'${file.name}' íŒŒì¼ì—ì„œ ${deliveryItems.length}ê°œì˜ í•­ëª©ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
                    } catch (error) {
                        showMessage(`íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`, "ì˜¤ë¥˜");
                    } finally {
                        importDataInput.value = '';
                    }
                };
                reader.onerror = () => {
                    showMessage("íŒŒì¼ì„ ì½ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", "ì˜¤ë¥˜");
                    importDataInput.value = '';
                };
                reader.readAsText(file);
            }
        );
    });

    // --- Swipe & Initial Load ---
    let touchStartX = 0, touchStartY = 0;
    document.body.addEventListener('touchstart', e => { touchStartX = e.touches[0].clientX; touchStartY = e.touches[0].clientY; }, { passive: true });
    document.body.addEventListener('touchmove', e => { if (Math.abs(e.touches[0].clientX - touchStartX) > 10 && Math.abs(e.touches[0].clientX - touchStartX) > Math.abs(e.touches[0].clientY - touchStartY)) e.preventDefault(); }, { passive: false });
    document.body.addEventListener('touchend', e => {
        const swipeDistanceX = e.changedTouches[0].clientX - touchStartX;
        if (Math.abs(swipeDistanceX) > 50 && Math.abs(swipeDistanceX) > Math.abs(e.changedTouches[0].clientY - touchStartY)) {
            const currentIndex = filterCategories.indexOf(activeFilter);
            const direction = swipeDistanceX > 0 ? -1 : 1;
            const newIndex = Math.max(0, Math.min(filterCategories.length - 1, currentIndex + direction));
            if (newIndex !== currentIndex) filterButtonsContainer.querySelector(`[data-filter="${filterCategories[newIndex]}"]`)?.click();
        }
    });
    
    // âœ¨ í€µ-ìŠ¤í¬ë¡¤ í•¸ë“¤ ë¡œì§ ("ë””ì§€í„¸ ë‹¤ì´ì–¼" ìµœì¢… ë²„ì „) âœ¨
    const setupQuickScroll = () => {
        let isDragging = false;
        let cardElementsCache = [];
        let cardPositionsCache = [];
        let lastScrolledIndex = -1;
        let headerHeight = 0;

        const onDragStart = (e) => {
            e.preventDefault();
            isDragging = true;
            quickScrollHandle.classList.add('active');
            quickScrollBubble.style.display = 'block';
            
            cardElementsCache = Array.from(deliveryCardsContainer.querySelectorAll('[data-no]'));
            if (cardElementsCache.length === 0) { onDragEnd(); return; }
            
            headerHeight = filterButtonsContainer.offsetTop + filterButtonsContainer.offsetHeight;
            cardPositionsCache = cardElementsCache.map(card => card.offsetTop - headerHeight);
            
            onDrag(e);
        };
        
        const onDragEnd = () => {
            if (!isDragging) return;
            isDragging = false;
            quickScrollHandle.classList.remove('active');
            quickScrollBubble.style.display = 'none';
            lastScrolledIndex = -1;
        };

        const onDrag = (e) => {
            if (!isDragging) return;
            e.preventDefault();
            
            const clientY = e.clientY || e.touches[0].clientY;
            
            const usableScreenHeight = window.innerHeight / 2;
            const usableScreenTop = window.innerHeight / 2;
            let percentage = (clientY - usableScreenTop) / usableScreenHeight;
            percentage = Math.max(0, Math.min(1, percentage));

            const targetIndex = Math.floor(percentage * (cardElementsCache.length - 1) + 0.5);

            const handleHeight = quickScrollHandle.offsetHeight;
            let handleTop = clientY - (handleHeight / 2);
            handleTop = Math.max(0, Math.min(window.innerHeight - handleHeight, handleTop));
            quickScrollHandle.style.top = `${handleTop}px`;
            quickScrollBubble.style.top = `${handleTop + (handleHeight / 2)}px`;

            if (targetIndex !== -1 && cardElementsCache[targetIndex]) {
                quickScrollBubble.textContent = cardElementsCache[targetIndex].dataset.no;

                if (targetIndex !== lastScrolledIndex) {
                    const targetPosition = cardPositionsCache[targetIndex];
                    window.scrollTo({ top: targetPosition, behavior: 'auto' });
                    
                    if (navigator.vibrate) navigator.vibrate(20); 
                    lastScrolledIndex = targetIndex;
                }
            }
        };

        const updateHandleOnScroll = () => {
            if (isDragging) return; // âœ¨ ë“œë˜ê·¸ ì¤‘ì—ëŠ” ì´ í•¨ìˆ˜ê°€ ì ˆëŒ€ ì‘ë™í•˜ì§€ ì•Šë„ë¡ í•¨

            headerHeight = filterButtonsContainer.offsetTop + filterButtonsContainer.offsetHeight;
            const currentScroll = window.scrollY;
            
            cardPositionsCache = Array.from(deliveryCardsContainer.querySelectorAll('[data-no]')).map(card => card.offsetTop - headerHeight);
            if(cardPositionsCache.length === 0) return;

            let closestIndex = 0;
            for(let i=0; i<cardPositionsCache.length; i++) {
                if (cardPositionsCache[i] <= currentScroll + 1) {
                    closestIndex = i;
                } else {
                    break;
                }
            }
            
            const percentage = cardPositionsCache.length > 1 ? closestIndex / (cardElementsCache.length - 1) : 0;
            
            const usableScreenHeight = window.innerHeight / 2;
            const usableScreenTop = window.innerHeight / 2;
            const handleHeight = quickScrollHandle.offsetHeight;

            let handleTop = usableScreenTop + (percentage * usableScreenHeight);
            handleTop = handleTop - (handleHeight / 2);
            handleTop = Math.max(0, Math.min(window.innerHeight - handleHeight, handleTop));
            
            quickScrollHandle.style.top = `${handleTop}px`;
        };

        quickScrollContainer.addEventListener('mousedown', onDragStart);
        quickScrollContainer.addEventListener('touchstart', onDragStart, { passive: false });

        window.addEventListener('mousemove', onDrag);
        window.addEventListener('touchmove', onDrag, { passive: false });
        
        window.addEventListener('mouseup', onDragEnd);
        window.addEventListener('touchend', onDragEnd);
        
        let scrollTimeout;
        window.addEventListener('scroll', () => {
             clearTimeout(scrollTimeout);
             scrollTimeout = setTimeout(updateHandleOnScroll, 100);
        });
    };

    const setupDelegatedEventListeners = () => {
        deliveryCardsContainer.addEventListener('click', (event) => {
            const button = event.target.closest('[data-action]');
            if (!button) return;
            const action = button.dataset.action;
            const itemNo = parseInt(button.dataset.no);
            const item = deliveryItems.find(i => i.no === itemNo);
            if (!item) return;
            
            switch (action) {
                case 'open-naver-map': if (!button.disabled) openNaverMap(button.dataset.address, itemNo); else showMessage('ìœ íš¨í•˜ì§€ ì•Šì€ ì£¼ì†Œì…ë‹ˆë‹¤.'); break;
                case 'identity-verification': 
                    openConfirmationModal(`HAWB ${item.hawbNo} ë³¸ì¸í™•ì¸ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, () => handleStatusChange(itemNo, 'ì™„ë£Œ', new Date().toLocaleString('ko-KR', dateTimeFormatOptions), 'ë³¸ì¸í™•ì¸', item.receiverNameKorean)); 
                    break;
                case 'front-door-delivery': 
                    openConfirmationModal(`HAWB ${item.hawbNo} ë¬¸ì•ë°°ì†¡ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, () => handleStatusChange(itemNo, 'ì™„ë£Œ', new Date().toLocaleString('ko-KR', dateTimeFormatOptions), 'ë¬¸ì•ë°°ì†¡')); 
                    break;
                case 'sign-delivery': openSignatureModal(itemNo); break;
                case 'revert-delivery': openConfirmationModal(`HAWB ${item.hawbNo} ìƒíƒœë¥¼ ë˜ëŒë¦¬ì‹œê² ìŠµë‹ˆê¹Œ?`, () => handleStatusChange(itemNo, 'ë°°ì†¡ì¤‘')); break;
                case 'toggle-details': const details = document.querySelector(`[data-details-container="${itemNo}"]`); if (details) { details.style.display = details.style.display === 'none' ? '' : 'none'; button.textContent = details.style.display === 'none' ? 'ìƒì„¸ë³´ê¸°' : 'ì ‘ê¸°'; } break;
            }
        });
        deliveryCardsContainer.addEventListener('change', (event) => {
            const checkbox = event.target.closest('[data-action="toggle-hawb-confirm"]');
            if (checkbox) handleCheckboxToggleAndResetSearch(parseInt(checkbox.dataset.no), checkbox.checked);
        });
    };

    document.addEventListener('DOMContentLoaded', () => {
        try {
            setupDelegatedEventListeners();
            setupQuickScroll();
            const storedItems = localStorage.getItem('deliveryItems');
            if (storedItems) deliveryItems = JSON.parse(storedItems).sort((a, b) => a.no - b.no);
            const storedScroll = localStorage.getItem('filterScrollPositions');
            if (storedScroll) filterScrollPositions = JSON.parse(storedScroll);
            updateFilterCounts();

            const initialBtn = filterButtonsContainer.querySelector(`[data-filter="ë°°ì†¡ì¤€ë¹„"]`);
            if (initialBtn) {
                initialBtn.click();
            }

        } catch (error) {
            console.error("ì´ˆê¸°í™” ì˜¤ë¥˜:", error);
            document.body.innerHTML = `<div class="p-4 text-red-500">ì•± ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì˜¤ë¥˜: ${error.message}</div>`;
        }
    });
</script>
</body>
</html>